#!/usr/bin/env python3
import pathlib
import subprocess
import sys


ROOT = pathlib.Path(__file__).resolve().parents[1]
SCHEMA = ROOT / "test" / "fixtures.capnp"
OUTPUT = ROOT / "test" / "generated_convert_fixtures_test.mbt"
TYPE_NAME = "Root"
TEXT_INPUT = (
    '(texts = ["alpha", "beta"], ints = [1, -2, 3], flags = [true, false, true], '
    "u16s = [1, 65535], child = (value = 123, name = \"kid\"), "
    'children = [(value = 1, name = "one"), (value = 2, name = "two")])'
)


def run_convert(segment_size: int | None) -> bytes:
    cmd = ["capnp", "convert", "text:binary"]
    if segment_size is not None:
        cmd.append(f"--segment-size={segment_size}")
    cmd.extend([str(SCHEMA), TYPE_NAME])
    try:
        completed = subprocess.run(
            cmd,
            input=TEXT_INPUT.encode("utf-8"),
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            cwd=ROOT,
            check=True,
        )
    except FileNotFoundError as exc:
        raise SystemExit("capnp tool not found in PATH") from exc
    except subprocess.CalledProcessError as exc:
        stderr = exc.stderr.decode("utf-8", errors="replace").strip()
        raise SystemExit(f"capnp convert failed: {stderr}") from exc
    return completed.stdout


def escape_bytes(data: bytes) -> str:
    out = []
    for value in data:
        if value == 0x22:
            out.append("\\\"")
        elif value == 0x5C:
            out.append("\\\\")
        elif 0x20 <= value <= 0x7E:
            out.append(chr(value))
        else:
            out.append(f"\\x{value:02x}")
    return "".join(out)


def format_bytes_literal(data: bytes) -> str:
    if len(data) <= 32:
        return f'b"{escape_bytes(data)}"'
    hex_values = [f"0x{value:02x}" for value in data]
    lines = []
    for i in range(0, len(hex_values), 12):
        chunk = ", ".join(hex_values[i : i + 12])
        if i + 12 < len(hex_values):
            chunk = f"{chunk},"
        lines.append(f"  {chunk}")
    return "[\n" + "\n".join(lines) + "\n]"


def render_fixture(name: str, data: bytes) -> str:
    literal = format_bytes_literal(data)
    return (
        "///|\n"
        f"let {name} : Bytes = {literal}\n"
    )


def main() -> int:
    single_segment = run_convert(segment_size=None)
    multi_segment = run_convert(segment_size=1)
    schema_display = SCHEMA.relative_to(ROOT)
    contents = (
        "// Code generated by scripts/gen_convert_fixtures.py; DO NOT EDIT.\n"
        f"// Schema: {schema_display.as_posix()}\n"
        f"// Type: {TYPE_NAME}\n"
        "\n"
        + render_fixture("convert_root_single_segment", single_segment)
        + "\n"
        + render_fixture("convert_root_multi_segment", multi_segment)
    )
    OUTPUT.write_text(contents, encoding="utf-8")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
