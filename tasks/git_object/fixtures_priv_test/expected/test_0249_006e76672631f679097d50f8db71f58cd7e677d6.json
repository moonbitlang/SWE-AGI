{
  "content": {
    "base64": "I2luY2x1ZGUgImNhY2hlLmgiCiNpbmNsdWRlICJidWlsdGluLmgiCiNpbmNsdWRlICJwYXJzZS1vcHRpb25zLmgiCiNpbmNsdWRlICJyYW5nZS1kaWZmLmgiCiNpbmNsdWRlICJjb25maWcuaCIKCnN0YXRpYyBjb25zdCBjaGFyICogY29uc3QgYnVpbHRpbl9yYW5nZV9kaWZmX3VzYWdlW10gPSB7Ck5fKCJnaXQgcmFuZ2UtZGlmZiBbPG9wdGlvbnM+XSA8b2xkLWJhc2U+Li48b2xkLXRpcD4gPG5ldy1iYXNlPi4uPG5ldy10aXA+IiksCk5fKCJnaXQgcmFuZ2UtZGlmZiBbPG9wdGlvbnM+XSA8b2xkLXRpcD4uLi48bmV3LXRpcD4iKSwKTl8oImdpdCByYW5nZS1kaWZmIFs8b3B0aW9ucz5dIDxiYXNlPiA8b2xkLXRpcD4gPG5ldy10aXA+IiksCk5VTEwKfTsKCnN0YXRpYyBzdHJ1Y3Qgc3RyYnVmICpvdXRwdXRfcHJlZml4X2NiKHN0cnVjdCBkaWZmX29wdGlvbnMgKm9wdCwgdm9pZCAqZGF0YSkKewoJcmV0dXJuIGRhdGE7Cn0KCmludCBjbWRfcmFuZ2VfZGlmZihpbnQgYXJnYywgY29uc3QgY2hhciAqKmFyZ3YsIGNvbnN0IGNoYXIgKnByZWZpeCkKewoJaW50IGNyZWF0aW9uX2ZhY3RvciA9IFJBTkdFX0RJRkZfQ1JFQVRJT05fRkFDVE9SX0RFRkFVTFQ7CglzdHJ1Y3QgZGlmZl9vcHRpb25zIGRpZmZvcHQgPSB7IE5VTEwgfTsKCWludCBzaW1wbGVfY29sb3IgPSAtMTsKCXN0cnVjdCBvcHRpb24gb3B0aW9uc1tdID0gewoJCU9QVF9JTlRFR0VSKDAsICJjcmVhdGlvbi1mYWN0b3IiLCAmY3JlYXRpb25fZmFjdG9yLAoJCQkgICAgTl8oIlBlcmNlbnRhZ2UgYnkgd2hpY2ggY3JlYXRpb24gaXMgd2VpZ2h0ZWQiKSksCgkJT1BUX0JPT0woMCwgIm5vLWR1YWwtY29sb3IiLCAmc2ltcGxlX2NvbG9yLAoJCQkgICAgTl8oImNvbG9yIGJvdGggZGlmZiBhbmQgZGlmZi1iZXR3ZWVuLWRpZmZzIikpLAoJCU9QVF9FTkQoKQoJfTsKCWludCBpLCBqLCByZXMgPSAwOwoJc3RydWN0IHN0cmJ1ZiBmb3VyX3NwYWNlcyA9IFNUUkJVRl9JTklUOwoJc3RydWN0IHN0cmJ1ZiByYW5nZTEgPSBTVFJCVUZfSU5JVCwgcmFuZ2UyID0gU1RSQlVGX0lOSVQ7CgoJZ2l0X2NvbmZpZyhnaXRfZGlmZl91aV9jb25maWcsIE5VTEwpOwoKCWRpZmZfc2V0dXAoJmRpZmZvcHQpOwoJZGlmZm9wdC5vdXRwdXRfZm9ybWF0ID0gRElGRl9GT1JNQVRfUEFUQ0g7CglkaWZmb3B0LmZsYWdzLnN1cHByZXNzX2RpZmZfaGVhZGVycyA9IDE7CglkaWZmb3B0Lm91dHB1dF9wcmVmaXggPSBvdXRwdXRfcHJlZml4X2NiOwoJc3RyYnVmX2FkZHN0cigmZm91cl9zcGFjZXMsICIgICAgIik7CglkaWZmb3B0Lm91dHB1dF9wcmVmaXhfZGF0YSA9ICZmb3VyX3NwYWNlczsKCglhcmdjID0gcGFyc2Vfb3B0aW9ucyhhcmdjLCBhcmd2LCBOVUxMLCBvcHRpb25zLAoJCQkgICAgIGJ1aWx0aW5fcmFuZ2VfZGlmZl91c2FnZSwgUEFSU0VfT1BUX0tFRVBfVU5LTk9XTiB8CgkJCSAgICAgUEFSU0VfT1BUX0tFRVBfREFTSERBU0ggfCBQQVJTRV9PUFRfS0VFUF9BUkdWMCk7CgoJZm9yIChpID0gaiA9IDE7IGkgPCBhcmdjICYmIHN0cmNtcCgiLS0iLCBhcmd2W2ldKTsgKSB7CgkJaW50IGMgPSBkaWZmX29wdF9wYXJzZSgmZGlmZm9wdCwgYXJndiArIGksIGFyZ2MgLSBpLCBwcmVmaXgpOwoKCQlpZiAoIWMpCgkJCWFyZ3ZbaisrXSA9IGFyZ3ZbaSsrXTsKCQllbHNlCgkJCWkgKz0gYzsKCX0KCXdoaWxlIChpIDwgYXJnYykKCQlhcmd2W2orK10gPSBhcmd2W2krK107CglhcmdjID0gajsKCWRpZmZfc2V0dXBfZG9uZSgmZGlmZm9wdCk7CgoJLyogTWFrZSBzdXJlIHRoYXQgdGhlcmUgYXJlIG5vIHVucGFyc2VkIG9wdGlvbnMgKi8KCWFyZ2MgPSBwYXJzZV9vcHRpb25zKGFyZ2MsIGFyZ3YsIE5VTEwsCgkJCSAgICAgb3B0aW9ucyArIEFSUkFZX1NJWkUob3B0aW9ucykgLSAxLCAvKiBPUFRfRU5EICovCgkJCSAgICAgYnVpbHRpbl9yYW5nZV9kaWZmX3VzYWdlLCAwKTsKCglpZiAoc2ltcGxlX2NvbG9yIDwgMSkgewoJCWlmICghc2ltcGxlX2NvbG9yKQoJCQkvKiBmb3JjZSBjb2xvciB3aGVuIC0tZHVhbC1jb2xvciB3YXMgdXNlZCAqLwoJCQlkaWZmb3B0LnVzZV9jb2xvciA9IDE7CgkJZGlmZm9wdC5mbGFncy5kdWFsX2NvbG9yX2RpZmZlZF9kaWZmcyA9IDE7Cgl9CgoJaWYgKGFyZ2MgPT0gMikgewoJCWlmICghc3Ryc3RyKGFyZ3ZbMF0sICIuLiIpKQoJCQlkaWUoXygibm8gLi4gaW4gcmFuZ2U6ICclcyciKSwgYXJndlswXSk7CgkJc3RyYnVmX2FkZHN0cigmcmFuZ2UxLCBhcmd2WzBdKTsKCgkJaWYgKCFzdHJzdHIoYXJndlsxXSwgIi4uIikpCgkJCWRpZShfKCJubyAuLiBpbiByYW5nZTogJyVzJyIpLCBhcmd2WzFdKTsKCQlzdHJidWZfYWRkc3RyKCZyYW5nZTIsIGFyZ3ZbMV0pOwoJfSBlbHNlIGlmIChhcmdjID09IDMpIHsKCQlzdHJidWZfYWRkZigmcmFuZ2UxLCAiJXMuLiVzIiwgYXJndlswXSwgYXJndlsxXSk7CgkJc3RyYnVmX2FkZGYoJnJhbmdlMiwgIiVzLi4lcyIsIGFyZ3ZbMF0sIGFyZ3ZbMl0pOwoJfSBlbHNlIGlmIChhcmdjID09IDEpIHsKCQljb25zdCBjaGFyICpiID0gc3Ryc3RyKGFyZ3ZbMF0sICIuLi4iKSwgKmEgPSBhcmd2WzBdOwoJCWludCBhX2xlbjsKCgkJaWYgKCFiKSB7CgkJCWVycm9yKF8oInNpbmdsZSBhcmcgZm9ybWF0IG11c3QgYmUgc3ltbWV0cmljIHJhbmdlIikpOwoJCQl1c2FnZV93aXRoX29wdGlvbnMoYnVpbHRpbl9yYW5nZV9kaWZmX3VzYWdlLCBvcHRpb25zKTsKCQl9CgoJCWFfbGVuID0gKGludCkoYiAtIGEpOwoJCWlmICghYV9sZW4pIHsKCQkJYSA9ICJIRUFEIjsKCQkJYV9sZW4gPSBzdHJsZW4oYSk7CgkJfQoJCWIgKz0gMzsKCQlpZiAoISpiKQoJCQliID0gIkhFQUQiOwoJCXN0cmJ1Zl9hZGRmKCZyYW5nZTEsICIlcy4uJS4qcyIsIGIsIGFfbGVuLCBhKTsKCQlzdHJidWZfYWRkZigmcmFuZ2UyLCAiJS4qcy4uJXMiLCBhX2xlbiwgYSwgYik7Cgl9IGVsc2UgewoJCWVycm9yKF8oIm5lZWQgdHdvIGNvbW1pdCByYW5nZXMiKSk7CgkJdXNhZ2Vfd2l0aF9vcHRpb25zKGJ1aWx0aW5fcmFuZ2VfZGlmZl91c2FnZSwgb3B0aW9ucyk7Cgl9CgoJcmVzID0gc2hvd19yYW5nZV9kaWZmKHJhbmdlMS5idWYsIHJhbmdlMi5idWYsIGNyZWF0aW9uX2ZhY3RvciwKCQkJICAgICAgJmRpZmZvcHQpOwoKCXN0cmJ1Zl9yZWxlYXNlKCZyYW5nZTEpOwoJc3RyYnVmX3JlbGVhc2UoJnJhbmdlMik7CglzdHJidWZfcmVsZWFzZSgmZm91cl9zcGFjZXMpOwoKCXJldHVybiByZXM7Cn0K",
    "text": "#include \"cache.h\"\n#include \"builtin.h\"\n#include \"parse-options.h\"\n#include \"range-diff.h\"\n#include \"config.h\"\n\nstatic const char * const builtin_range_diff_usage[] = {\nN_(\"git range-diff [<options>] <old-base>..<old-tip> <new-base>..<new-tip>\"),\nN_(\"git range-diff [<options>] <old-tip>...<new-tip>\"),\nN_(\"git range-diff [<options>] <base> <old-tip> <new-tip>\"),\nNULL\n};\n\nstatic struct strbuf *output_prefix_cb(struct diff_options *opt, void *data)\n{\n\treturn data;\n}\n\nint cmd_range_diff(int argc, const char **argv, const char *prefix)\n{\n\tint creation_factor = RANGE_DIFF_CREATION_FACTOR_DEFAULT;\n\tstruct diff_options diffopt = { NULL };\n\tint simple_color = -1;\n\tstruct option options[] = {\n\t\tOPT_INTEGER(0, \"creation-factor\", &creation_factor,\n\t\t\t    N_(\"Percentage by which creation is weighted\")),\n\t\tOPT_BOOL(0, \"no-dual-color\", &simple_color,\n\t\t\t    N_(\"color both diff and diff-between-diffs\")),\n\t\tOPT_END()\n\t};\n\tint i, j, res = 0;\n\tstruct strbuf four_spaces = STRBUF_INIT;\n\tstruct strbuf range1 = STRBUF_INIT, range2 = STRBUF_INIT;\n\n\tgit_config(git_diff_ui_config, NULL);\n\n\tdiff_setup(&diffopt);\n\tdiffopt.output_format = DIFF_FORMAT_PATCH;\n\tdiffopt.flags.suppress_diff_headers = 1;\n\tdiffopt.output_prefix = output_prefix_cb;\n\tstrbuf_addstr(&four_spaces, \"    \");\n\tdiffopt.output_prefix_data = &four_spaces;\n\n\targc = parse_options(argc, argv, NULL, options,\n\t\t\t     builtin_range_diff_usage, PARSE_OPT_KEEP_UNKNOWN |\n\t\t\t     PARSE_OPT_KEEP_DASHDASH | PARSE_OPT_KEEP_ARGV0);\n\n\tfor (i = j = 1; i < argc && strcmp(\"--\", argv[i]); ) {\n\t\tint c = diff_opt_parse(&diffopt, argv + i, argc - i, prefix);\n\n\t\tif (!c)\n\t\t\targv[j++] = argv[i++];\n\t\telse\n\t\t\ti += c;\n\t}\n\twhile (i < argc)\n\t\targv[j++] = argv[i++];\n\targc = j;\n\tdiff_setup_done(&diffopt);\n\n\t/* Make sure that there are no unparsed options */\n\targc = parse_options(argc, argv, NULL,\n\t\t\t     options + ARRAY_SIZE(options) - 1, /* OPT_END */\n\t\t\t     builtin_range_diff_usage, 0);\n\n\tif (simple_color < 1) {\n\t\tif (!simple_color)\n\t\t\t/* force color when --dual-color was used */\n\t\t\tdiffopt.use_color = 1;\n\t\tdiffopt.flags.dual_color_diffed_diffs = 1;\n\t}\n\n\tif (argc == 2) {\n\t\tif (!strstr(argv[0], \"..\"))\n\t\t\tdie(_(\"no .. in range: '%s'\"), argv[0]);\n\t\tstrbuf_addstr(&range1, argv[0]);\n\n\t\tif (!strstr(argv[1], \"..\"))\n\t\t\tdie(_(\"no .. in range: '%s'\"), argv[1]);\n\t\tstrbuf_addstr(&range2, argv[1]);\n\t} else if (argc == 3) {\n\t\tstrbuf_addf(&range1, \"%s..%s\", argv[0], argv[1]);\n\t\tstrbuf_addf(&range2, \"%s..%s\", argv[0], argv[2]);\n\t} else if (argc == 1) {\n\t\tconst char *b = strstr(argv[0], \"...\"), *a = argv[0];\n\t\tint a_len;\n\n\t\tif (!b) {\n\t\t\terror(_(\"single arg format must be symmetric range\"));\n\t\t\tusage_with_options(builtin_range_diff_usage, options);\n\t\t}\n\n\t\ta_len = (int)(b - a);\n\t\tif (!a_len) {\n\t\t\ta = \"HEAD\";\n\t\t\ta_len = strlen(a);\n\t\t}\n\t\tb += 3;\n\t\tif (!*b)\n\t\t\tb = \"HEAD\";\n\t\tstrbuf_addf(&range1, \"%s..%.*s\", b, a_len, a);\n\t\tstrbuf_addf(&range2, \"%.*s..%s\", a_len, a, b);\n\t} else {\n\t\terror(_(\"need two commit ranges\"));\n\t\tusage_with_options(builtin_range_diff_usage, options);\n\t}\n\n\tres = show_range_diff(range1.buf, range2.buf, creation_factor,\n\t\t\t      &diffopt);\n\n\tstrbuf_release(&range1);\n\tstrbuf_release(&range2);\n\tstrbuf_release(&four_spaces);\n\n\treturn res;\n}\n",
    "type": "blob"
  },
  "kind": "blob",
  "oid": "006e76672631f679097d50f8db71f58cd7e677d6",
  "sha1_ok": true,
  "size": 3201
}
