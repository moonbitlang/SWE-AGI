{
  "content": {
    "base64": "I2luY2x1ZGUgImNhY2hlLmgiCiNpbmNsdWRlICJsb2NrZmlsZS5oIgojaW5jbHVkZSAiY3JlZGVudGlhbC5oIgojaW5jbHVkZSAic3RyaW5nLWxpc3QuaCIKI2luY2x1ZGUgInBhcnNlLW9wdGlvbnMuaCIKCnN0YXRpYyBzdHJ1Y3QgbG9ja19maWxlIGNyZWRlbnRpYWxfbG9jazsKCnN0YXRpYyBpbnQgcGFyc2VfY3JlZGVudGlhbF9maWxlKGNvbnN0IGNoYXIgKmZuLAoJCQkJICBzdHJ1Y3QgY3JlZGVudGlhbCAqYywKCQkJCSAgdm9pZCAoKm1hdGNoX2NiKShzdHJ1Y3QgY3JlZGVudGlhbCAqKSwKCQkJCSAgdm9pZCAoKm90aGVyX2NiKShzdHJ1Y3Qgc3RyYnVmICopKQp7CglGSUxFICpmaDsKCXN0cnVjdCBzdHJidWYgbGluZSA9IFNUUkJVRl9JTklUOwoJc3RydWN0IGNyZWRlbnRpYWwgZW50cnkgPSBDUkVERU5USUFMX0lOSVQ7CglpbnQgZm91bmRfY3JlZGVudGlhbCA9IDA7CgoJZmggPSBmb3BlbihmbiwgInIiKTsKCWlmICghZmgpIHsKCQlpZiAoZXJybm8gIT0gRU5PRU5UICYmIGVycm5vICE9IEVBQ0NFUykKCQkJZGllX2Vycm5vKCJ1bmFibGUgdG8gb3BlbiAlcyIsIGZuKTsKCQlyZXR1cm4gZm91bmRfY3JlZGVudGlhbDsKCX0KCgl3aGlsZSAoc3RyYnVmX2dldGxpbmUoJmxpbmUsIGZoLCAnXG4nKSAhPSBFT0YpIHsKCQljcmVkZW50aWFsX2Zyb21fdXJsKCZlbnRyeSwgbGluZS5idWYpOwoJCWlmIChlbnRyeS51c2VybmFtZSAmJiBlbnRyeS5wYXNzd29yZCAmJgoJCSAgICBjcmVkZW50aWFsX21hdGNoKGMsICZlbnRyeSkpIHsKCQkJZm91bmRfY3JlZGVudGlhbCA9IDE7CgkJCWlmIChtYXRjaF9jYikgewoJCQkJbWF0Y2hfY2IoJmVudHJ5KTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCWVsc2UgaWYgKG90aGVyX2NiKQoJCQlvdGhlcl9jYigmbGluZSk7Cgl9CgoJY3JlZGVudGlhbF9jbGVhcigmZW50cnkpOwoJc3RyYnVmX3JlbGVhc2UoJmxpbmUpOwoJZmNsb3NlKGZoKTsKCXJldHVybiBmb3VuZF9jcmVkZW50aWFsOwp9CgpzdGF0aWMgdm9pZCBwcmludF9lbnRyeShzdHJ1Y3QgY3JlZGVudGlhbCAqYykKewoJcHJpbnRmKCJ1c2VybmFtZT0lc1xuIiwgYy0+dXNlcm5hbWUpOwoJcHJpbnRmKCJwYXNzd29yZD0lc1xuIiwgYy0+cGFzc3dvcmQpOwp9CgpzdGF0aWMgdm9pZCBwcmludF9saW5lKHN0cnVjdCBzdHJidWYgKmJ1ZikKewoJc3RyYnVmX2FkZGNoKGJ1ZiwgJ1xuJyk7Cgl3cml0ZV9vcl9kaWUoZ2V0X2xvY2tfZmlsZV9mZCgmY3JlZGVudGlhbF9sb2NrKSwgYnVmLT5idWYsIGJ1Zi0+bGVuKTsKfQoKc3RhdGljIHZvaWQgcmV3cml0ZV9jcmVkZW50aWFsX2ZpbGUoY29uc3QgY2hhciAqZm4sIHN0cnVjdCBjcmVkZW50aWFsICpjLAoJCQkJICAgIHN0cnVjdCBzdHJidWYgKmV4dHJhKQp7CglpZiAoaG9sZF9sb2NrX2ZpbGVfZm9yX3VwZGF0ZSgmY3JlZGVudGlhbF9sb2NrLCBmbiwgMCkgPCAwKQoJCWRpZV9lcnJubygidW5hYmxlIHRvIGdldCBjcmVkZW50aWFsIHN0b3JhZ2UgbG9jayIpOwoJaWYgKGV4dHJhKQoJCXByaW50X2xpbmUoZXh0cmEpOwoJcGFyc2VfY3JlZGVudGlhbF9maWxlKGZuLCBjLCBOVUxMLCBwcmludF9saW5lKTsKCWlmIChjb21taXRfbG9ja19maWxlKCZjcmVkZW50aWFsX2xvY2spIDwgMCkKCQlkaWVfZXJybm8oInVuYWJsZSB0byBjb21taXQgY3JlZGVudGlhbCBzdG9yZSIpOwp9CgpzdGF0aWMgdm9pZCBzdG9yZV9jcmVkZW50aWFsX2ZpbGUoY29uc3QgY2hhciAqZm4sIHN0cnVjdCBjcmVkZW50aWFsICpjKQp7CglzdHJ1Y3Qgc3RyYnVmIGJ1ZiA9IFNUUkJVRl9JTklUOwoKCXN0cmJ1Zl9hZGRmKCZidWYsICIlczovLyIsIGMtPnByb3RvY29sKTsKCXN0cmJ1Zl9hZGRzdHJfdXJsZW5jb2RlKCZidWYsIGMtPnVzZXJuYW1lLCAxKTsKCXN0cmJ1Zl9hZGRjaCgmYnVmLCAnOicpOwoJc3RyYnVmX2FkZHN0cl91cmxlbmNvZGUoJmJ1ZiwgYy0+cGFzc3dvcmQsIDEpOwoJc3RyYnVmX2FkZGNoKCZidWYsICdAJyk7CglpZiAoYy0+aG9zdCkKCQlzdHJidWZfYWRkc3RyX3VybGVuY29kZSgmYnVmLCBjLT5ob3N0LCAxKTsKCWlmIChjLT5wYXRoKSB7CgkJc3RyYnVmX2FkZGNoKCZidWYsICcvJyk7CgkJc3RyYnVmX2FkZHN0cl91cmxlbmNvZGUoJmJ1ZiwgYy0+cGF0aCwgMCk7Cgl9CgoJcmV3cml0ZV9jcmVkZW50aWFsX2ZpbGUoZm4sIGMsICZidWYpOwoJc3RyYnVmX3JlbGVhc2UoJmJ1Zik7Cn0KCnN0YXRpYyB2b2lkIHN0b3JlX2NyZWRlbnRpYWwoY29uc3Qgc3RydWN0IHN0cmluZ19saXN0ICpmbnMsIHN0cnVjdCBjcmVkZW50aWFsICpjKQp7CglzdHJ1Y3Qgc3RyaW5nX2xpc3RfaXRlbSAqZm47CgoJLyoKCSAqIFNhbml0eSBjaGVjayB0aGF0IHdoYXQgd2UgYXJlIHN0b3JpbmcgaXMgYWN0dWFsbHkgc2Vuc2libGUuCgkgKiBJbiBwYXJ0aWN1bGFyLCB3ZSBjYW4ndCBtYWtlIGEgVVJMIHdpdGhvdXQgYSBwcm90b2NvbCBmaWVsZC4KCSAqIFdpdGhvdXQgZWl0aGVyIGEgaG9zdCBvciBwYXRobmFtZSAoZGVwZW5kaW5nIG9uIHRoZSBzY2hlbWUpLAoJICogd2UgaGF2ZSBubyBwcmltYXJ5IGtleS4gQW5kIHdpdGhvdXQgYSB1c2VybmFtZSBhbmQgcGFzc3dvcmQsCgkgKiB3ZSBhcmUgbm90IGFjdHVhbGx5IHN0b3JpbmcgYSBjcmVkZW50aWFsLgoJICovCglpZiAoIWMtPnByb3RvY29sIHx8ICEoYy0+aG9zdCB8fCBjLT5wYXRoKSB8fCAhYy0+dXNlcm5hbWUgfHwgIWMtPnBhc3N3b3JkKQoJCXJldHVybjsKCglmb3JfZWFjaF9zdHJpbmdfbGlzdF9pdGVtKGZuLCBmbnMpCgkJaWYgKCFhY2Nlc3MoZm4tPnN0cmluZywgRl9PSykpIHsKCQkJc3RvcmVfY3JlZGVudGlhbF9maWxlKGZuLT5zdHJpbmcsIGMpOwoJCQlyZXR1cm47CgkJfQoJLyoKCSAqIFdyaXRlIGNyZWRlbnRpYWwgdG8gdGhlIGZpbGVuYW1lIHNwZWNpZmllZCBieSBmbnMtPml0ZW1zWzBdLCB0aHVzCgkgKiBjcmVhdGluZyBpdAoJICovCglpZiAoZm5zLT5ucikKCQlzdG9yZV9jcmVkZW50aWFsX2ZpbGUoZm5zLT5pdGVtc1swXS5zdHJpbmcsIGMpOwp9CgpzdGF0aWMgdm9pZCByZW1vdmVfY3JlZGVudGlhbChjb25zdCBzdHJ1Y3Qgc3RyaW5nX2xpc3QgKmZucywgc3RydWN0IGNyZWRlbnRpYWwgKmMpCnsKCXN0cnVjdCBzdHJpbmdfbGlzdF9pdGVtICpmbjsKCgkvKgoJICogU2FuaXR5IGNoZWNrIHRoYXQgd2UgYWN0dWFsbHkgaGF2ZSBzb21ldGhpbmcgdG8gbWF0Y2gKCSAqIGFnYWluc3QuIFRoZSBpbnB1dCB3ZSBnZXQgaXMgYSByZXN0cmljdGl2ZSBwYXR0ZXJuLAoJICogc28gdGVjaG5pY2FsbHkgYSBibGFuayBjcmVkZW50aWFsIG1lYW5zICJlcmFzZSBldmVyeXRoaW5nIi4KCSAqIEJ1dCBpdCBpcyB0b28gZWFzeSB0byBhY2NpZGVudGFsbHkgc2VuZCB0aGlzLCBzaW5jZSBpdCBpcyBlcXVpdmFsZW50CgkgKiB0byBlbXB0eSBpbnB1dC4gU28gZXhwbGljaXRseSBkaXNhbGxvdyBpdCwgYW5kIHJlcXVpcmUgdGhhdCB0aGUKCSAqIHBhdHRlcm4gaGF2ZSBzb21lIGFjdHVhbCBjb250ZW50IHRvIG1hdGNoLgoJICovCglpZiAoIWMtPnByb3RvY29sICYmICFjLT5ob3N0ICYmICFjLT5wYXRoICYmICFjLT51c2VybmFtZSkKCQlyZXR1cm47Cglmb3JfZWFjaF9zdHJpbmdfbGlzdF9pdGVtKGZuLCBmbnMpCgkJaWYgKCFhY2Nlc3MoZm4tPnN0cmluZywgRl9PSykpCgkJCXJld3JpdGVfY3JlZGVudGlhbF9maWxlKGZuLT5zdHJpbmcsIGMsIE5VTEwpOwp9CgpzdGF0aWMgdm9pZCBsb29rdXBfY3JlZGVudGlhbChjb25zdCBzdHJ1Y3Qgc3RyaW5nX2xpc3QgKmZucywgc3RydWN0IGNyZWRlbnRpYWwgKmMpCnsKCXN0cnVjdCBzdHJpbmdfbGlzdF9pdGVtICpmbjsKCglmb3JfZWFjaF9zdHJpbmdfbGlzdF9pdGVtKGZuLCBmbnMpCgkJaWYgKHBhcnNlX2NyZWRlbnRpYWxfZmlsZShmbi0+c3RyaW5nLCBjLCBwcmludF9lbnRyeSwgTlVMTCkpCgkJCXJldHVybjsgLyogRm91bmQgY3JlZGVudGlhbCAqLwp9CgppbnQgbWFpbihpbnQgYXJnYywgY2hhciAqKmFyZ3YpCnsKCWNvbnN0IGNoYXIgKiBjb25zdCB1c2FnZVtdID0gewoJCSJnaXQgY3JlZGVudGlhbC1zdG9yZSBbPG9wdGlvbnM+XSA8YWN0aW9uPiIsCgkJTlVMTAoJfTsKCWNvbnN0IGNoYXIgKm9wOwoJc3RydWN0IGNyZWRlbnRpYWwgYyA9IENSRURFTlRJQUxfSU5JVDsKCXN0cnVjdCBzdHJpbmdfbGlzdCBmbnMgPSBTVFJJTkdfTElTVF9JTklUX0RVUDsKCWNoYXIgKmZpbGUgPSBOVUxMOwoJc3RydWN0IG9wdGlvbiBvcHRpb25zW10gPSB7CgkJT1BUX1NUUklORygwLCAiZmlsZSIsICZmaWxlLCAicGF0aCIsCgkJCSAgICJmZXRjaCBhbmQgc3RvcmUgY3JlZGVudGlhbHMgaW4gPHBhdGg+IiksCgkJT1BUX0VORCgpCgl9OwoKCXVtYXNrKDA3Nyk7CgoJYXJnYyA9IHBhcnNlX29wdGlvbnMoYXJnYywgKGNvbnN0IGNoYXIgKiopYXJndiwgTlVMTCwgb3B0aW9ucywgdXNhZ2UsIDApOwoJaWYgKGFyZ2MgIT0gMSkKCQl1c2FnZV93aXRoX29wdGlvbnModXNhZ2UsIG9wdGlvbnMpOwoJb3AgPSBhcmd2WzBdOwoKCWlmIChmaWxlKSB7CgkJc3RyaW5nX2xpc3RfYXBwZW5kKCZmbnMsIGZpbGUpOwoJfSBlbHNlIHsKCQlpZiAoKGZpbGUgPSBleHBhbmRfdXNlcl9wYXRoKCJ+Ly5naXQtY3JlZGVudGlhbHMiKSkpCgkJCXN0cmluZ19saXN0X2FwcGVuZF9ub2R1cCgmZm5zLCBmaWxlKTsKCQlmaWxlID0geGRnX2NvbmZpZ19ob21lKCJjcmVkZW50aWFscyIpOwoJCWlmIChmaWxlKQoJCQlzdHJpbmdfbGlzdF9hcHBlbmRfbm9kdXAoJmZucywgZmlsZSk7Cgl9CglpZiAoIWZucy5ucikKCQlkaWUoInVuYWJsZSB0byBzZXQgdXAgZGVmYXVsdCBwYXRoOyB1c2UgLS1maWxlIik7CgoJaWYgKGNyZWRlbnRpYWxfcmVhZCgmYywgc3RkaW4pIDwgMCkKCQlkaWUoInVuYWJsZSB0byByZWFkIGNyZWRlbnRpYWwiKTsKCglpZiAoIXN0cmNtcChvcCwgImdldCIpKQoJCWxvb2t1cF9jcmVkZW50aWFsKCZmbnMsICZjKTsKCWVsc2UgaWYgKCFzdHJjbXAob3AsICJlcmFzZSIpKQoJCXJlbW92ZV9jcmVkZW50aWFsKCZmbnMsICZjKTsKCWVsc2UgaWYgKCFzdHJjbXAob3AsICJzdG9yZSIpKQoJCXN0b3JlX2NyZWRlbnRpYWwoJmZucywgJmMpOwoJZWxzZQoJCTsgLyogSWdub3JlIHVua25vd24gb3BlcmF0aW9uLiAqLwoKCXN0cmluZ19saXN0X2NsZWFyKCZmbnMsIDApOwoJcmV0dXJuIDA7Cn0K",
    "text": "#include \"cache.h\"\n#include \"lockfile.h\"\n#include \"credential.h\"\n#include \"string-list.h\"\n#include \"parse-options.h\"\n\nstatic struct lock_file credential_lock;\n\nstatic int parse_credential_file(const char *fn,\n\t\t\t\t  struct credential *c,\n\t\t\t\t  void (*match_cb)(struct credential *),\n\t\t\t\t  void (*other_cb)(struct strbuf *))\n{\n\tFILE *fh;\n\tstruct strbuf line = STRBUF_INIT;\n\tstruct credential entry = CREDENTIAL_INIT;\n\tint found_credential = 0;\n\n\tfh = fopen(fn, \"r\");\n\tif (!fh) {\n\t\tif (errno != ENOENT && errno != EACCES)\n\t\t\tdie_errno(\"unable to open %s\", fn);\n\t\treturn found_credential;\n\t}\n\n\twhile (strbuf_getline(&line, fh, '\\n') != EOF) {\n\t\tcredential_from_url(&entry, line.buf);\n\t\tif (entry.username && entry.password &&\n\t\t    credential_match(c, &entry)) {\n\t\t\tfound_credential = 1;\n\t\t\tif (match_cb) {\n\t\t\t\tmatch_cb(&entry);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\telse if (other_cb)\n\t\t\tother_cb(&line);\n\t}\n\n\tcredential_clear(&entry);\n\tstrbuf_release(&line);\n\tfclose(fh);\n\treturn found_credential;\n}\n\nstatic void print_entry(struct credential *c)\n{\n\tprintf(\"username=%s\\n\", c->username);\n\tprintf(\"password=%s\\n\", c->password);\n}\n\nstatic void print_line(struct strbuf *buf)\n{\n\tstrbuf_addch(buf, '\\n');\n\twrite_or_die(get_lock_file_fd(&credential_lock), buf->buf, buf->len);\n}\n\nstatic void rewrite_credential_file(const char *fn, struct credential *c,\n\t\t\t\t    struct strbuf *extra)\n{\n\tif (hold_lock_file_for_update(&credential_lock, fn, 0) < 0)\n\t\tdie_errno(\"unable to get credential storage lock\");\n\tif (extra)\n\t\tprint_line(extra);\n\tparse_credential_file(fn, c, NULL, print_line);\n\tif (commit_lock_file(&credential_lock) < 0)\n\t\tdie_errno(\"unable to commit credential store\");\n}\n\nstatic void store_credential_file(const char *fn, struct credential *c)\n{\n\tstruct strbuf buf = STRBUF_INIT;\n\n\tstrbuf_addf(&buf, \"%s://\", c->protocol);\n\tstrbuf_addstr_urlencode(&buf, c->username, 1);\n\tstrbuf_addch(&buf, ':');\n\tstrbuf_addstr_urlencode(&buf, c->password, 1);\n\tstrbuf_addch(&buf, '@');\n\tif (c->host)\n\t\tstrbuf_addstr_urlencode(&buf, c->host, 1);\n\tif (c->path) {\n\t\tstrbuf_addch(&buf, '/');\n\t\tstrbuf_addstr_urlencode(&buf, c->path, 0);\n\t}\n\n\trewrite_credential_file(fn, c, &buf);\n\tstrbuf_release(&buf);\n}\n\nstatic void store_credential(const struct string_list *fns, struct credential *c)\n{\n\tstruct string_list_item *fn;\n\n\t/*\n\t * Sanity check that what we are storing is actually sensible.\n\t * In particular, we can't make a URL without a protocol field.\n\t * Without either a host or pathname (depending on the scheme),\n\t * we have no primary key. And without a username and password,\n\t * we are not actually storing a credential.\n\t */\n\tif (!c->protocol || !(c->host || c->path) || !c->username || !c->password)\n\t\treturn;\n\n\tfor_each_string_list_item(fn, fns)\n\t\tif (!access(fn->string, F_OK)) {\n\t\t\tstore_credential_file(fn->string, c);\n\t\t\treturn;\n\t\t}\n\t/*\n\t * Write credential to the filename specified by fns->items[0], thus\n\t * creating it\n\t */\n\tif (fns->nr)\n\t\tstore_credential_file(fns->items[0].string, c);\n}\n\nstatic void remove_credential(const struct string_list *fns, struct credential *c)\n{\n\tstruct string_list_item *fn;\n\n\t/*\n\t * Sanity check that we actually have something to match\n\t * against. The input we get is a restrictive pattern,\n\t * so technically a blank credential means \"erase everything\".\n\t * But it is too easy to accidentally send this, since it is equivalent\n\t * to empty input. So explicitly disallow it, and require that the\n\t * pattern have some actual content to match.\n\t */\n\tif (!c->protocol && !c->host && !c->path && !c->username)\n\t\treturn;\n\tfor_each_string_list_item(fn, fns)\n\t\tif (!access(fn->string, F_OK))\n\t\t\trewrite_credential_file(fn->string, c, NULL);\n}\n\nstatic void lookup_credential(const struct string_list *fns, struct credential *c)\n{\n\tstruct string_list_item *fn;\n\n\tfor_each_string_list_item(fn, fns)\n\t\tif (parse_credential_file(fn->string, c, print_entry, NULL))\n\t\t\treturn; /* Found credential */\n}\n\nint main(int argc, char **argv)\n{\n\tconst char * const usage[] = {\n\t\t\"git credential-store [<options>] <action>\",\n\t\tNULL\n\t};\n\tconst char *op;\n\tstruct credential c = CREDENTIAL_INIT;\n\tstruct string_list fns = STRING_LIST_INIT_DUP;\n\tchar *file = NULL;\n\tstruct option options[] = {\n\t\tOPT_STRING(0, \"file\", &file, \"path\",\n\t\t\t   \"fetch and store credentials in <path>\"),\n\t\tOPT_END()\n\t};\n\n\tumask(077);\n\n\targc = parse_options(argc, (const char **)argv, NULL, options, usage, 0);\n\tif (argc != 1)\n\t\tusage_with_options(usage, options);\n\top = argv[0];\n\n\tif (file) {\n\t\tstring_list_append(&fns, file);\n\t} else {\n\t\tif ((file = expand_user_path(\"~/.git-credentials\")))\n\t\t\tstring_list_append_nodup(&fns, file);\n\t\tfile = xdg_config_home(\"credentials\");\n\t\tif (file)\n\t\t\tstring_list_append_nodup(&fns, file);\n\t}\n\tif (!fns.nr)\n\t\tdie(\"unable to set up default path; use --file\");\n\n\tif (credential_read(&c, stdin) < 0)\n\t\tdie(\"unable to read credential\");\n\n\tif (!strcmp(op, \"get\"))\n\t\tlookup_credential(&fns, &c);\n\telse if (!strcmp(op, \"erase\"))\n\t\tremove_credential(&fns, &c);\n\telse if (!strcmp(op, \"store\"))\n\t\tstore_credential(&fns, &c);\n\telse\n\t\t; /* Ignore unknown operation. */\n\n\tstring_list_clear(&fns, 0);\n\treturn 0;\n}\n",
    "type": "blob"
  },
  "kind": "blob",
  "oid": "00aea3aa304f2731da070c447f694591b3021bc9",
  "sha1_ok": true,
  "size": 5109
}
