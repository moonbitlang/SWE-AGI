{
  "content": {
    "base64": "I2luY2x1ZGUgImNhY2hlLmgiCiNpbmNsdWRlICJwYWNrLmgiCgpzdGF0aWMgaW50IHZlcmlmeV9vbmVfcGFjayhjb25zdCBjaGFyICpwYXRoLCBpbnQgdmVyYm9zZSkKewoJY2hhciBhcmdbUEFUSF9NQVhdOwoJaW50IGxlbjsKCXN0cnVjdCBwYWNrZWRfZ2l0ICpnOwoKCWxlbiA9IHN0cmxjcHkoYXJnLCBwYXRoLCBQQVRIX01BWCk7CglpZiAobGVuID49IFBBVEhfTUFYKQoJCXJldHVybiBlcnJvcigibmFtZSB0b28gbG9uZzogJXMiLCBwYXRoKTsKCgl3aGlsZSAoMSkgewoJCS8qIFNob3VsZCBuYW1lIGZvby5pZHgsIGJ1dCBmb28ucGFjayBtYXkgYmUgbmFtZWQ7CgkJICogY29udmVydCBpdCB0byBmb28uaWR4CgkJICovCgkJaWYgKGhhc19leHRlbnNpb24oYXJnLCBsZW4sICIucGFjayIpKSB7CgkJCXN0cmNweShhcmcgKyBsZW4gLSA1LCAiLmlkeCIpOwoJCQlsZW4tLTsKCQl9IGVsc2UgaWYgKCFoYXNfZXh0ZW5zaW9uKGFyZywgbGVuLCAiLmlkeCIpKSB7CgkJCWlmIChsZW4gKyA0ID49IFBBVEhfTUFYKQoJCQkJcmV0dXJuIGVycm9yKCJuYW1lIHRvbyBsb25nOiAlcy5pZHgiLCBhcmcpOwoJCQlzdHJjcHkoYXJnICsgbGVuLCAiLmlkeCIpOwoJCQlsZW4gKz0gNDsKCQl9CgkJaWYgKChnID0gYWRkX3BhY2tlZF9naXQoYXJnLCBsZW4sIDEpKSkKCQkJYnJlYWs7CgkJcmV0dXJuIGVycm9yKCJwYWNrZmlsZSAlcyBub3QgZm91bmQuIiwgYXJnKTsKCX0KCXJldHVybiB2ZXJpZnlfcGFjayhnLCB2ZXJib3NlKTsKfQoKc3RhdGljIGNvbnN0IGNoYXIgdmVyaWZ5X3BhY2tfdXNhZ2VbXSA9ICJnaXQtdmVyaWZ5LXBhY2sgWy12XSA8cGFjaz4uLi4iOwoKaW50IG1haW4oaW50IGFjLCBjaGFyICoqYXYpCnsKCWludCBlcnJzID0gMDsKCWludCB2ZXJib3NlID0gMDsKCWludCBub19tb3JlX29wdGlvbnMgPSAwOwoJaW50IG5vdGhpbmdfZG9uZSA9IDE7CgoJd2hpbGUgKDEgPCBhYykgewoJCWlmICghbm9fbW9yZV9vcHRpb25zICYmIGF2WzFdWzBdID09ICctJykgewoJCQlpZiAoIXN0cmNtcCgiLXYiLCBhdlsxXSkpCgkJCQl2ZXJib3NlID0gMTsKCQkJZWxzZSBpZiAoIXN0cmNtcCgiLS0iLCBhdlsxXSkpCgkJCQlub19tb3JlX29wdGlvbnMgPSAxOwoJCQllbHNlCgkJCQl1c2FnZSh2ZXJpZnlfcGFja191c2FnZSk7CgkJfQoJCWVsc2UgewoJCQlpZiAodmVyaWZ5X29uZV9wYWNrKGF2WzFdLCB2ZXJib3NlKSkKCQkJCWVycnMrKzsKCQkJbm90aGluZ19kb25lID0gMDsKCQl9CgkJYWMtLTsgYXYrKzsKCX0KCglpZiAobm90aGluZ19kb25lKQoJCXVzYWdlKHZlcmlmeV9wYWNrX3VzYWdlKTsKCglyZXR1cm4gISFlcnJzOwp9Cg==",
    "text": "#include \"cache.h\"\n#include \"pack.h\"\n\nstatic int verify_one_pack(const char *path, int verbose)\n{\n\tchar arg[PATH_MAX];\n\tint len;\n\tstruct packed_git *g;\n\n\tlen = strlcpy(arg, path, PATH_MAX);\n\tif (len >= PATH_MAX)\n\t\treturn error(\"name too long: %s\", path);\n\n\twhile (1) {\n\t\t/* Should name foo.idx, but foo.pack may be named;\n\t\t * convert it to foo.idx\n\t\t */\n\t\tif (has_extension(arg, len, \".pack\")) {\n\t\t\tstrcpy(arg + len - 5, \".idx\");\n\t\t\tlen--;\n\t\t} else if (!has_extension(arg, len, \".idx\")) {\n\t\t\tif (len + 4 >= PATH_MAX)\n\t\t\t\treturn error(\"name too long: %s.idx\", arg);\n\t\t\tstrcpy(arg + len, \".idx\");\n\t\t\tlen += 4;\n\t\t}\n\t\tif ((g = add_packed_git(arg, len, 1)))\n\t\t\tbreak;\n\t\treturn error(\"packfile %s not found.\", arg);\n\t}\n\treturn verify_pack(g, verbose);\n}\n\nstatic const char verify_pack_usage[] = \"git-verify-pack [-v] <pack>...\";\n\nint main(int ac, char **av)\n{\n\tint errs = 0;\n\tint verbose = 0;\n\tint no_more_options = 0;\n\tint nothing_done = 1;\n\n\twhile (1 < ac) {\n\t\tif (!no_more_options && av[1][0] == '-') {\n\t\t\tif (!strcmp(\"-v\", av[1]))\n\t\t\t\tverbose = 1;\n\t\t\telse if (!strcmp(\"--\", av[1]))\n\t\t\t\tno_more_options = 1;\n\t\t\telse\n\t\t\t\tusage(verify_pack_usage);\n\t\t}\n\t\telse {\n\t\t\tif (verify_one_pack(av[1], verbose))\n\t\t\t\terrs++;\n\t\t\tnothing_done = 0;\n\t\t}\n\t\tac--; av++;\n\t}\n\n\tif (nothing_done)\n\t\tusage(verify_pack_usage);\n\n\treturn !!errs;\n}\n",
    "type": "blob"
  },
  "kind": "blob",
  "oid": "002b7116171d3305f5b69955852385a5ec50ed0f",
  "sha1_ok": true,
  "size": 1318
}
