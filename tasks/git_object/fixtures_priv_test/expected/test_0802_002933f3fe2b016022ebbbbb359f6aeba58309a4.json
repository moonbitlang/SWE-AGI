{
  "content": {
    "headers": [
      "tree 57dd6eabb38e91914325e4d45aef79406ad54246",
      "parent 3cb9d2b6f9fd2dcb17f5534fd1536682e76f734a",
      "author SZEDER G\u00e1bor <szeder.dev@gmail.com> 1589198178 +0000",
      "committer Junio C Hamano <gitster@pobox.com> 1589214836 -0700"
    ],
    "message": "line-log: try to use generation number-based topo-ordering\n\nThe previous patch made it possible to perform line-level filtering\nduring history traversal instead of in an expensive preprocessing\nstep, but it still requires some simpler preprocessing steps, notably\ntopo-ordering.  However, nowadays we have commit-graphs storing\ngeneration numbers, which make it possible to incrementally traverse\nthe history in topological order, without the preparatory limit_list()\nand sort_in_topological_order() steps; see b45424181e (revision.c:\ngeneration-based topo-order algorithm, 2018-11-01).\n\nThis patch combines the two, so we can do both the topo-ordering and\nthe line-level filtering during history traversal, eliminating even\nthose simpler preprocessing steps, and thus further reducing the delay\nbefore showing the first commit modifying the given line range.\n\nThe 'revs->limited' flag plays the central role in this, because, due\nto limitations of the current implementation, the generation\nnumber-based topo-ordering is only enabled when this flag remains\nunset.  Line-level log, however, always sets this flag in\nsetup_revisions() ever since the feature was introduced in 12da1d1f6f\n(Implement line-history search (git log -L), 2013-03-28).  The reason\nfor setting 'limited' is unclear, though, because the line-level log\nitself doesn't directly depend on it, and it doesn't affect how the\nlimit_list() function limits the revision range.  However, there is an\nindirect dependency: the line-level log requires topo-ordering, and\nthe \"traditional\" sort_in_topological_order() requires an already\nlimited commit list since e6c3505b44 (Make sure we generate the whole\ncommit list before trying to sort it topologically, 2005-07-06).  The\nnew, generation numbers-based topo-ordering doesn't require a limited\ncommit list anymore.\n\nSo don't set 'revs->limited' for line-level log, unless it is really\nnecessary, namely:\n\n  - The user explicitly requested parent rewriting, because that is\n    still done in the line_log_filter() preprocessing step (see\n    previous patch), which requires sort_in_topological_order() and in\n    turn limit_list() as well.\n\n  - A commit-graph file is not available or it doesn't yet contain\n    generation numbers.  In these cases we had to fall back on\n    sort_in_topological_order() and in turn limit_list().  The\n    existing condition with generation_numbers_enabled() has already\n    ensured that the 'limited' flag is set in these cases; this patch\n    just makes sure that the line-level log sets 'revs->topo_order'\n    before that condition.\n\nWhile the reduced delay before showing the first commit is measurable\nin git.git, it takes a bigger repository to make it clearly noticable.\nIn both cases below the line ranges were chosen so that they were\nmodified rather close to the starting revisions, so the effect of this\nchange is most noticable.\n\n  # git.git\n  $ time git --no-pager log -L:read_alternate_refs:sha1-file.c -1 v2.23.0\n\n  Before:\n\n    real    0m0.107s\n    user    0m0.091s\n    sys     0m0.013s\n\n  After:\n\n    real    0m0.058s\n    user    0m0.050s\n    sys     0m0.005s\n\n  # linux.git\n  $ time git --no-pager log \\\n    -L:build_restore_work_registers:arch/mips/mm/tlbex.c -1 v5.2\n\n  Before:\n\n    real   0m1.129s\n    user   0m1.061s\n    sys    0m0.069s\n\n  After:\n\n    real   0m0.096s\n    user   0m0.087s\n    sys    0m0.009s\n\nAdditional testing by Derrick Stolee: Since this patch improves\nthe performance for the first result, I repeated the experiment\nfrom the previous patch on the Linux kernel repository, reporting\nreal time here:\n\n    Command: git log -L 100,200:MAINTAINERS -n 1 >/dev/null\n     Before: 0.71 s\n      After: 0.05 s\n\nNow, we have dropped the full topo-order of all ~910,000 commits\nbefore reporting the first result. The remaining performance\nimprovements then are:\n\n 1. Update the parent-rewriting logic to be incremental similar to\n    how \"git log --graph\" behaves.\n\n 2. Use changed-path Bloom filters to reduce the time spend in the\n    tree-diff to see if the path(s) changed.\n\nSigned-off-by: SZEDER G\u00e1bor <szeder.dev@gmail.com>\nSigned-off-by: Derrick Stolee <dstolee@microsoft.com>\nSigned-off-by: Junio C Hamano <gitster@pobox.com>\n",
    "type": "commit"
  },
  "kind": "commit",
  "oid": "002933f3fe2b016022ebbbbb359f6aeba58309a4",
  "sha1_ok": true,
  "size": 4428
}
