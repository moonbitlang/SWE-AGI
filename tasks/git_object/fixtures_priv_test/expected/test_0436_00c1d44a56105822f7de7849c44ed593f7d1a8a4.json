{
  "content": {
    "base64": "I2luY2x1ZGUgImdpdC1jb21wYXQtdXRpbC5oIgojaW5jbHVkZSAiYmxvb20uaCIKI2luY2x1ZGUgInRlc3QtdG9vbC5oIgojaW5jbHVkZSAiY29tbWl0LmgiCgpzdHJ1Y3QgYmxvb21fZmlsdGVyX3NldHRpbmdzIHNldHRpbmdzID0gREVGQVVMVF9CTE9PTV9GSUxURVJfU0VUVElOR1M7CgpzdGF0aWMgdm9pZCBhZGRfc3RyaW5nX3RvX2ZpbHRlcihjb25zdCBjaGFyICpkYXRhLCBzdHJ1Y3QgYmxvb21fZmlsdGVyICpmaWx0ZXIpIHsKCQlzdHJ1Y3QgYmxvb21fa2V5IGtleTsKCQlpbnQgaTsKCgkJZmlsbF9ibG9vbV9rZXkoZGF0YSwgc3RybGVuKGRhdGEpLCAma2V5LCAmc2V0dGluZ3MpOwoJCXByaW50ZigiSGFzaGVzOiIpOwoJCWZvciAoaSA9IDA7IGkgPCBzZXR0aW5ncy5udW1faGFzaGVzOyBpKyspewoJCQlwcmludGYoIjB4JTA4eHwiLCBrZXkuaGFzaGVzW2ldKTsKCQl9CgkJcHJpbnRmKCJcbiIpOwoJCWFkZF9rZXlfdG9fZmlsdGVyKCZrZXksIGZpbHRlciwgJnNldHRpbmdzKTsKfQoKc3RhdGljIHZvaWQgcHJpbnRfYmxvb21fZmlsdGVyKHN0cnVjdCBibG9vbV9maWx0ZXIgKmZpbHRlcikgewoJaW50IGk7CgoJaWYgKCFmaWx0ZXIpIHsKCQlwcmludGYoIk5vIGZpbHRlci5cbiIpOwoJCXJldHVybjsKCX0KCXByaW50ZigiRmlsdGVyX0xlbmd0aDolZFxuIiwgKGludClmaWx0ZXItPmxlbik7CglwcmludGYoIkZpbHRlcl9EYXRhOiIpOwoJZm9yIChpID0gMDsgaSA8IGZpbHRlci0+bGVuOyBpKyspIHsKCQlwcmludGYoIiUwMnh8IiwgZmlsdGVyLT5kYXRhW2ldKTsKCX0KCXByaW50ZigiXG4iKTsKfQoKc3RhdGljIHZvaWQgZ2V0X2Jsb29tX2ZpbHRlcl9mb3JfY29tbWl0KGNvbnN0IHN0cnVjdCBvYmplY3RfaWQgKmNvbW1pdF9vaWQpCnsKCXN0cnVjdCBjb21taXQgKmM7CglzdHJ1Y3QgYmxvb21fZmlsdGVyICpmaWx0ZXI7CglzZXR1cF9naXRfZGlyZWN0b3J5KCk7CgljID0gbG9va3VwX2NvbW1pdCh0aGVfcmVwb3NpdG9yeSwgY29tbWl0X29pZCk7CglmaWx0ZXIgPSBnZXRfYmxvb21fZmlsdGVyKHRoZV9yZXBvc2l0b3J5LCBjLCAxKTsKCXByaW50X2Jsb29tX2ZpbHRlcihmaWx0ZXIpOwp9CgpzdGF0aWMgY29uc3QgY2hhciAqYmxvb21fdXNhZ2UgPSAiXG4iCiIgIHRlc3QtdG9vbCBibG9vbSBnZXRfbXVybXVyMyA8c3RyaW5nPlxuIgoiICB0ZXN0LXRvb2wgYmxvb20gZ2VuZXJhdGVfZmlsdGVyIDxzdHJpbmc+IFs8c3RyaW5nPi4uLl1cbiIKIiAgdGVzdC10b29sIGdldF9maWx0ZXJfZm9yX2NvbW1pdCA8Y29tbWl0LWhleD5cbiI7CgppbnQgY21kX19ibG9vbShpbnQgYXJnYywgY29uc3QgY2hhciAqKmFyZ3YpCnsKCWlmIChhcmdjIDwgMikKCQl1c2FnZShibG9vbV91c2FnZSk7CgoJaWYgKCFzdHJjbXAoYXJndlsxXSwgImdldF9tdXJtdXIzIikpIHsKCQl1aW50MzJfdCBoYXNoZWQ7CgkJaWYgKGFyZ2MgPCAzKQoJCQl1c2FnZShibG9vbV91c2FnZSk7CgkJaGFzaGVkID0gbXVybXVyM19zZWVkZWQoMCwgYXJndlsyXSwgc3RybGVuKGFyZ3ZbMl0pKTsKCQlwcmludGYoIk11cm11cjMgSGFzaCB3aXRoIHNlZWQ9MDoweCUwOHhcbiIsIGhhc2hlZCk7Cgl9CgoJaWYgKCFzdHJjbXAoYXJndlsxXSwgImdlbmVyYXRlX2ZpbHRlciIpKSB7CgkJc3RydWN0IGJsb29tX2ZpbHRlciBmaWx0ZXI7CgkJaW50IGkgPSAyOwoJCWZpbHRlci5sZW4gPSAgKHNldHRpbmdzLmJpdHNfcGVyX2VudHJ5ICsgQklUU19QRVJfV09SRCAtIDEpIC8gQklUU19QRVJfV09SRDsKCQlmaWx0ZXIuZGF0YSA9IHhjYWxsb2MoZmlsdGVyLmxlbiwgc2l6ZW9mKHVuc2lnbmVkIGNoYXIpKTsKCgkJaWYgKGFyZ2MgLSAxIDwgaSkKCQkJdXNhZ2UoYmxvb21fdXNhZ2UpOwoKCQl3aGlsZSAoYXJndltpXSkgewoJCQlhZGRfc3RyaW5nX3RvX2ZpbHRlcihhcmd2W2ldLCAmZmlsdGVyKTsKCQkJaSsrOwoJCX0KCgkJcHJpbnRfYmxvb21fZmlsdGVyKCZmaWx0ZXIpOwoJfQoKCWlmICghc3RyY21wKGFyZ3ZbMV0sICJnZXRfZmlsdGVyX2Zvcl9jb21taXQiKSkgewoJCXN0cnVjdCBvYmplY3RfaWQgb2lkOwoJCWNvbnN0IGNoYXIgKmVuZDsKCQlpZiAoYXJnYyA8IDMpCgkJCXVzYWdlKGJsb29tX3VzYWdlKTsKCQlpZiAocGFyc2Vfb2lkX2hleChhcmd2WzJdLCAmb2lkLCAmZW5kKSkKCQkJZGllKCJjYW5ub3QgcGFyc2Ugb2lkICclcyciLCBhcmd2WzJdKTsKCQlpbml0X2Jsb29tX2ZpbHRlcnMoKTsKCQlnZXRfYmxvb21fZmlsdGVyX2Zvcl9jb21taXQoJm9pZCk7Cgl9CgoJcmV0dXJuIDA7Cn0K",
    "text": "#include \"git-compat-util.h\"\n#include \"bloom.h\"\n#include \"test-tool.h\"\n#include \"commit.h\"\n\nstruct bloom_filter_settings settings = DEFAULT_BLOOM_FILTER_SETTINGS;\n\nstatic void add_string_to_filter(const char *data, struct bloom_filter *filter) {\n\t\tstruct bloom_key key;\n\t\tint i;\n\n\t\tfill_bloom_key(data, strlen(data), &key, &settings);\n\t\tprintf(\"Hashes:\");\n\t\tfor (i = 0; i < settings.num_hashes; i++){\n\t\t\tprintf(\"0x%08x|\", key.hashes[i]);\n\t\t}\n\t\tprintf(\"\\n\");\n\t\tadd_key_to_filter(&key, filter, &settings);\n}\n\nstatic void print_bloom_filter(struct bloom_filter *filter) {\n\tint i;\n\n\tif (!filter) {\n\t\tprintf(\"No filter.\\n\");\n\t\treturn;\n\t}\n\tprintf(\"Filter_Length:%d\\n\", (int)filter->len);\n\tprintf(\"Filter_Data:\");\n\tfor (i = 0; i < filter->len; i++) {\n\t\tprintf(\"%02x|\", filter->data[i]);\n\t}\n\tprintf(\"\\n\");\n}\n\nstatic void get_bloom_filter_for_commit(const struct object_id *commit_oid)\n{\n\tstruct commit *c;\n\tstruct bloom_filter *filter;\n\tsetup_git_directory();\n\tc = lookup_commit(the_repository, commit_oid);\n\tfilter = get_bloom_filter(the_repository, c, 1);\n\tprint_bloom_filter(filter);\n}\n\nstatic const char *bloom_usage = \"\\n\"\n\"  test-tool bloom get_murmur3 <string>\\n\"\n\"  test-tool bloom generate_filter <string> [<string>...]\\n\"\n\"  test-tool get_filter_for_commit <commit-hex>\\n\";\n\nint cmd__bloom(int argc, const char **argv)\n{\n\tif (argc < 2)\n\t\tusage(bloom_usage);\n\n\tif (!strcmp(argv[1], \"get_murmur3\")) {\n\t\tuint32_t hashed;\n\t\tif (argc < 3)\n\t\t\tusage(bloom_usage);\n\t\thashed = murmur3_seeded(0, argv[2], strlen(argv[2]));\n\t\tprintf(\"Murmur3 Hash with seed=0:0x%08x\\n\", hashed);\n\t}\n\n\tif (!strcmp(argv[1], \"generate_filter\")) {\n\t\tstruct bloom_filter filter;\n\t\tint i = 2;\n\t\tfilter.len =  (settings.bits_per_entry + BITS_PER_WORD - 1) / BITS_PER_WORD;\n\t\tfilter.data = xcalloc(filter.len, sizeof(unsigned char));\n\n\t\tif (argc - 1 < i)\n\t\t\tusage(bloom_usage);\n\n\t\twhile (argv[i]) {\n\t\t\tadd_string_to_filter(argv[i], &filter);\n\t\t\ti++;\n\t\t}\n\n\t\tprint_bloom_filter(&filter);\n\t}\n\n\tif (!strcmp(argv[1], \"get_filter_for_commit\")) {\n\t\tstruct object_id oid;\n\t\tconst char *end;\n\t\tif (argc < 3)\n\t\t\tusage(bloom_usage);\n\t\tif (parse_oid_hex(argv[2], &oid, &end))\n\t\t\tdie(\"cannot parse oid '%s'\", argv[2]);\n\t\tinit_bloom_filters();\n\t\tget_bloom_filter_for_commit(&oid);\n\t}\n\n\treturn 0;\n}\n",
    "type": "blob"
  },
  "kind": "blob",
  "oid": "00c1d44a56105822f7de7849c44ed593f7d1a8a4",
  "sha1_ok": true,
  "size": 2250
}
