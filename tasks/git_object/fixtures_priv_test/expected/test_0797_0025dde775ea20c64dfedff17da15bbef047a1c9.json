{
  "content": {
    "headers": [
      "tree 0fc8fa2654af4cc0cc6f9cfba38fdb570bfab766",
      "parent 2e8e77cbac8ac17f94eee2087187fa1718e38b14",
      "author Ren\u00e9 Scharfe <l.s.r@web.de> 1698493981 +0200",
      "committer Junio C Hamano <gitster@pobox.com> 1698538518 +0900"
    ],
    "message": "parse-options: make CMDMODE errors more precise\n\nOnly a single PARSE_OPT_CMDMODE option can be specified for the same\nvariable at the same time.  This is enforced by get_value(), but the\nerror messages are imprecise in three ways:\n\n1. If a non-PARSE_OPT_CMDMODE option changes the value variable of a\nPARSE_OPT_CMDMODE option then an ominously vague message is shown:\n\n   $ t/helper/test-tool parse-options --set23 --mode1\n   error: option `mode1' : incompatible with something else\n\nWorse: If the order of options is reversed then no error is reported at\nall:\n\n   $ t/helper/test-tool parse-options --mode1 --set23\n   boolean: 0\n   integer: 23\n   magnitude: 0\n   timestamp: 0\n   string: (not set)\n   abbrev: 7\n   verbose: -1\n   quiet: 0\n   dry run: no\n   file: (not set)\n\nFortunately this can currently only happen in the test helper; actual\nGit commands don't share the same variable for the value of options with\nand without the flag PARSE_OPT_CMDMODE.\n\n2. If there are multiple options with the same value (synonyms), then\nthe one that is defined first is shown rather than the one actually\ngiven on the command line, which is confusing:\n\n   $ git am --resolved --quit\n   error: option `quit' is incompatible with --continue\n\n3. Arguments of PARSE_OPT_CMDMODE options are not handled by the\nparse-option machinery.  This is left to the callback function.  We\ncurrently only have a single affected option, --show-current-patch of\ngit am.  Errors for it can show an argument that was not actually given\non the command line:\n\n   $ git am --show-current-patch --show-current-patch=diff\n   error: options '--show-current-patch=diff' and '--show-current-patch=raw' cannot be used together\n\nThe options --show-current-patch and --show-current-patch=raw are\nsynonyms, but the error accuses the user of input they did not actually\nmade.  Or it can awkwardly print a NULL pointer:\n\n   $ git am --show-current-patch=diff --show-current-patch\n   error: options '--show-current-patch=(null)' and '--show-current-patch=diff' cannot be used together\n\nThe reasons for these shortcomings is that the current code checks\nincompatibility only when encountering a PARSE_OPT_CMDMODE option at the\ncommand line, and that it searches the previous incompatible option by\nvalue.\n\nFix the first two points by checking all PARSE_OPT_CMDMODE variables\nafter parsing each option and by storing all relevant details if their\nvalue changed.  Do that whether or not the changing options has the flag\nPARSE_OPT_CMDMODE set.  Report an incompatibility only if two options\nchange the variable to different values and at least one of them is a\nPARSE_OPT_CMDMODE option.  This changes the output of the first three\nexamples above to:\n\n   $ t/helper/test-tool parse-options --set23 --mode1\n   error: --mode1 is incompatible with --set23\n   $ t/helper/test-tool parse-options --mode1 --set23\n   error: --set23 is incompatible with --mode1\n   $ git am --resolved --quit\n   error: --quit is incompatible with --resolved\n\nStore the argument of PARSE_OPT_CMDMODE options of type OPTION_CALLBACK\nas well to allow taking over the responsibility for compatibility\nchecking from the callback function.  The next patch will use this\ncapability to fix the messages for git am --show-current-patch.\n\nUse a linked list for storing the PARSE_OPT_CMDMODE variables.  This\nsomewhat outdated data structure is simple and suffices, as the number\nof elements per command is currently only zero or one.  We do support\nmultiple different command modes variables per command, but I don't\nexpect that we'd ever use a significant number of them.  Once we do we\ncan switch to a hashmap.\n\nSince we no longer need to search the conflicting option, the all_opts\nparameter of get_value() is no longer used.  Remove it.\n\nExtend the tests to check for both conflicting option names, but don't\ninsist on a particular order.\n\nSigned-off-by: Ren\u00e9 Scharfe <l.s.r@web.de>\nSigned-off-by: Junio C Hamano <gitster@pobox.com>\n",
    "type": "commit"
  },
  "kind": "commit",
  "oid": "0025dde775ea20c64dfedff17da15bbef047a1c9",
  "sha1_ok": true,
  "size": 4163
}
