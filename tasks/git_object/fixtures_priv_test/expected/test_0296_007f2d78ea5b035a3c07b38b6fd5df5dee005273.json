{
  "content": {
    "base64": "IwojIEV4YW1wbGUgaW1wbGVtZW50YXRpb24gZm9yIHRoZSBHaXQgZmlsdGVyIHByb3RvY29sIHZlcnNpb24gMgojIFNlZSBEb2N1bWVudGF0aW9uL2dpdGF0dHJpYnV0ZXMudHh0LCBzZWN0aW9uICJGaWx0ZXIgUHJvdG9jb2wiCiMKIyBVc2FnZTogcm90MTMtZmlsdGVyLnBsIFstLWFsd2F5cy1kZWxheV0gPGxvZyBwYXRoPiA8Y2FwYWJpbGl0aWVzPgojCiMgTG9nIHBhdGggZGVmaW5lcyBhIGRlYnVnIGxvZyBmaWxlIHRoYXQgdGhlIHNjcmlwdCB3cml0ZXMgdG8uIFRoZQojIHN1YnNlcXVlbnQgYXJndW1lbnRzIGRlZmluZSBhIGxpc3Qgb2Ygc3VwcG9ydGVkIHByb3RvY29sIGNhcGFiaWxpdGllcwojICgiY2xlYW4iLCAic211ZGdlIiwgZXRjKS4KIwojIFdoZW4gLS1hbHdheXMtZGVsYXkgaXMgZ2l2ZW4gYWxsIHBhdGhuYW1lcyB3aXRoIHRoZSAiY2FuLWRlbGF5IiBmbGFnCiMgdGhhdCBkb24ndCBhcHBlYXIgb24gdGhlIGxpc3QgYmVsbG93IGFyZSBkZWxheWVkIHdpdGggYSBjb3VudCBvZiAxCiMgKHNlZSBtb3JlIGJlbG93KS4KIwojIFRoaXMgaW1wbGVtZW50YXRpb24gc3VwcG9ydHMgc3BlY2lhbCB0ZXN0IGNhc2VzOgojICgxKSBJZiBkYXRhIHdpdGggdGhlIHBhdGhuYW1lICJjbGVhbi13cml0ZS1mYWlsLnIiIGlzIHByb2Nlc3NlZCB3aXRoCiMgICAgIGEgImNsZWFuIiBvcGVyYXRpb24gdGhlbiB0aGUgd3JpdGUgb3BlcmF0aW9uIHdpbGwgZGllLgojICgyKSBJZiBkYXRhIHdpdGggdGhlIHBhdGhuYW1lICJzbXVkZ2Utd3JpdGUtZmFpbC5yIiBpcyBwcm9jZXNzZWQgd2l0aAojICAgICBhICJzbXVkZ2UiIG9wZXJhdGlvbiB0aGVuIHRoZSB3cml0ZSBvcGVyYXRpb24gd2lsbCBkaWUuCiMgKDMpIElmIGRhdGEgd2l0aCB0aGUgcGF0aG5hbWUgImVycm9yLnIiIGlzIHByb2Nlc3NlZCB3aXRoIGFueQojICAgICBvcGVyYXRpb24gdGhlbiB0aGUgZmlsdGVyIHNpZ25hbHMgdGhhdCBpdCBjYW5ub3Qgb3IgZG9lcyBub3Qgd2FudAojICAgICB0byBwcm9jZXNzIHRoZSBmaWxlLgojICg0KSBJZiBkYXRhIHdpdGggdGhlIHBhdGhuYW1lICJhYm9ydC5yIiBpcyBwcm9jZXNzZWQgd2l0aCBhbnkKIyAgICAgb3BlcmF0aW9uIHRoZW4gdGhlIGZpbHRlciBzaWduYWxzIHRoYXQgaXQgY2Fubm90IG9yIGRvZXMgbm90IHdhbnQKIyAgICAgdG8gcHJvY2VzcyB0aGUgZmlsZSBhbmQgYW55IGZpbGUgYWZ0ZXIgdGhhdCBpcyBwcm9jZXNzZWQgd2l0aCB0aGUKIyAgICAgc2FtZSBjb21tYW5kLgojICg1KSBJZiBkYXRhIHdpdGggYSBwYXRobmFtZSB0aGF0IGlzIGEga2V5IGluIHRoZSBERUxBWSBoYXNoIGlzCiMgICAgIHJlcXVlc3RlZCAoZS5nLiAidGVzdC1kZWxheTEwLmEiKSB0aGVuIHRoZSBmaWx0ZXIgcmVzcG9uZHMgd2l0aAojICAgICBhICJkZWxheSIgc3RhdHVzIGFuZCBzZXRzIHRoZSAicmVxdWVzdGVkIiBmaWVsZCBpbiB0aGUgREVMQVkgaGFzaC4KIyAgICAgVGhlIGZpbHRlciB3aWxsIHNpZ25hbCB0aGUgYXZhaWxhYmlsaXR5IG9mIHRoaXMgb2JqZWN0IGFmdGVyCiMgICAgICJjb3VudCIgKGZpZWxkIGluIERFTEFZIGhhc2gpICJsaXN0X2F2YWlsYWJsZV9ibG9icyIgY29tbWFuZHMuCiMgKDYpIElmIGRhdGEgd2l0aCB0aGUgcGF0aG5hbWUgIm1pc3NpbmctZGVsYXkuYSIgaXMgcHJvY2Vzc2VkIHRoYXQgdGhlCiMgICAgIGZpbHRlciB3aWxsIGRyb3AgdGhlIHBhdGggZnJvbSB0aGUgImxpc3RfYXZhaWxhYmxlX2Jsb2JzIiByZXNwb25zZS4KIyAoNykgSWYgZGF0YSB3aXRoIHRoZSBwYXRobmFtZSAiaW52YWxpZC1kZWxheS5hIiBpcyBwcm9jZXNzZWQgdGhhdCB0aGUKIyAgICAgZmlsdGVyIHdpbGwgYWRkIHRoZSBwYXRoICJ1bmZpbHRlcmVkIiB3aGljaCB3YXMgbm90IGRlbGF5ZWQgYmVmb3JlCiMgICAgIHRvIHRoZSAibGlzdF9hdmFpbGFibGVfYmxvYnMiIHJlc3BvbnNlLgojCgp1c2UgNS4wMDg7CnN1YiBnaXRwZXJsbGliIHsKCSMgR2l0IGFzc3VtZXMgdGhhdCBhbGwgcGF0aCBsaXN0cyBhcmUgVW5peC15IGNvbG9uLXNlcGFyYXRlZCBvbmVzLiBCdXQKCSMgd2hlbiB0aGUgR2l0IGZvciBXaW5kb3dzIGV4ZWN1dGVzIHRoZSB0ZXN0IHN1aXRlLCBpdHMgTVNZUzIgQmFzaAoJIyBjYWxscyBnaXQuZXhlLCBhbmQgY29sb24tc2VwYXJhdGVkIHBhdGggbGlzdHMgYXJlIGNvbnZlcnRlZCBpbnRvCgkjIFdpbmRvd3MteSBzZW1pY29sb24tc2VwYXJhdGVkIGxpc3RzIG9mICpXaW5kb3dzKiBwYXRocyAod2hpY2gKCSMgbmF0dXJhbGx5IGNvbnRhaW4gYSBjb2xvbiBhZnRlciB0aGUgZHJpdmUgbGV0dGVyLCBzbyBzcGxpdHRpbmcgYnkKCSMgY29sb25zIHNpbXBseSBkb2VzIG5vdCBjdXQgaXQpLgoJIwoJIyBEZXRlY3Qgc2VtaWNvbG9uLXNlcGFyYXRlZCBwYXRoIGxpc3QgYW5kIGhhbmRsZSB0aGVtIGFwcHJvcHJpYXRlbHkuCgoJaWYgKCRFTlZ7R0lUUEVSTExJQn0gPX4gLzsvKSB7CgkJcmV0dXJuIHNwbGl0KC87LywgJEVOVntHSVRQRVJMTElCfSk7Cgl9CglyZXR1cm4gc3BsaXQoLzovLCAkRU5We0dJVFBFUkxMSUJ9KTsKfQp1c2UgbGliIChnaXRwZXJsbGliKCkpOwp1c2Ugc3RyaWN0Owp1c2Ugd2FybmluZ3M7CnVzZSBJTzo6RmlsZTsKdXNlIEdpdDo6UGFja2V0OwoKbXkgJE1BWF9QQUNLRVRfQ09OVEVOVF9TSVpFID0gNjU1MTY7CgpteSAkYWx3YXlzX2RlbGF5ID0gMDsKaWYgKCAkQVJHVlswXSBlcSAnLS1hbHdheXMtZGVsYXknICkgewoJJGFsd2F5c19kZWxheSA9IDE7CglzaGlmdCBAQVJHVjsKfQoKbXkgJGxvZ19maWxlICAgICAgICAgICAgICAgID0gc2hpZnQgQEFSR1Y7Cm15IEBjYXBhYmlsaXRpZXMgICAgICAgICAgICA9IEBBUkdWOwoKb3BlbiBteSAkZGVidWcsICI+PiIsICRsb2dfZmlsZSBvciBkaWUgImNhbm5vdCBvcGVuIGxvZyBmaWxlOiAkISI7CgpteSAlREVMQVkgPSAoCgkndGVzdC1kZWxheTEwLmEnID0+IHsgInJlcXVlc3RlZCIgPT4gMCwgImNvdW50IiA9PiAxIH0sCgkndGVzdC1kZWxheTExLmEnID0+IHsgInJlcXVlc3RlZCIgPT4gMCwgImNvdW50IiA9PiAxIH0sCgkndGVzdC1kZWxheTIwLmEnID0+IHsgInJlcXVlc3RlZCIgPT4gMCwgImNvdW50IiA9PiAyIH0sCgkndGVzdC1kZWxheTEwLmInID0+IHsgInJlcXVlc3RlZCIgPT4gMCwgImNvdW50IiA9PiAxIH0sCgknbWlzc2luZy1kZWxheS5hJyA9PiB7ICJyZXF1ZXN0ZWQiID0+IDAsICJjb3VudCIgPT4gMSB9LAoJJ2ludmFsaWQtZGVsYXkuYScgPT4geyAicmVxdWVzdGVkIiA9PiAwLCAiY291bnQiID0+IDEgfSwKKTsKCnN1YiByb3QxMyB7CglteSAkc3RyID0gc2hpZnQ7Cgkkc3RyID1+IHkvQS1aYS16L04tWkEtTW4temEtbS87CglyZXR1cm4gJHN0cjsKfQoKcHJpbnQgJGRlYnVnICJTVEFSVFxuIjsKJGRlYnVnLT5mbHVzaCgpOwoKcGFja2V0X2luaXRpYWxpemUoImdpdC1maWx0ZXIiLCAyKTsKCm15ICVyZW1vdGVfY2FwcyA9IHBhY2tldF9yZWFkX2FuZF9jaGVja19jYXBhYmlsaXRpZXMoImNsZWFuIiwgInNtdWRnZSIsICJkZWxheSIpOwpwYWNrZXRfY2hlY2tfYW5kX3dyaXRlX2NhcGFiaWxpdGllcyhcJXJlbW90ZV9jYXBzLCBAY2FwYWJpbGl0aWVzKTsKCnByaW50ICRkZWJ1ZyAiaW5pdCBoYW5kc2hha2UgY29tcGxldGVcbiI7CiRkZWJ1Zy0+Zmx1c2goKTsKCndoaWxlICgxKSB7CglteSAoICRyZXMsICRjb21tYW5kICkgPSBwYWNrZXRfa2V5X3ZhbF9yZWFkKCJjb21tYW5kIik7CglpZiAoICRyZXMgPT0gLTEgKSB7CgkJcHJpbnQgJGRlYnVnICJTVE9QXG4iOwoJCWV4aXQoKTsKCX0KCXByaW50ICRkZWJ1ZyAiSU46ICRjb21tYW5kIjsKCSRkZWJ1Zy0+Zmx1c2goKTsKCglpZiAoICRjb21tYW5kIGVxICJsaXN0X2F2YWlsYWJsZV9ibG9icyIgKSB7CgkJIyBGbHVzaAoJCXBhY2tldF9jb21wYXJlX2xpc3RzKFsxLCAiIl0sIHBhY2tldF9iaW5fcmVhZCgpKSB8fAoJCQlkaWUgImJhZCBsaXN0X2F2YWlsYWJsZV9ibG9icyBlbmQiOwoKCQlmb3JlYWNoIG15ICRwYXRobmFtZSAoIHNvcnQga2V5cyAlREVMQVkgKSB7CgkJCWlmICggJERFTEFZeyRwYXRobmFtZX17InJlcXVlc3RlZCJ9ID49IDEgKSB7CgkJCQkkREVMQVl7JHBhdGhuYW1lfXsiY291bnQifSA9ICRERUxBWXskcGF0aG5hbWV9eyJjb3VudCJ9IC0gMTsKCQkJCWlmICggJHBhdGhuYW1lIGVxICJpbnZhbGlkLWRlbGF5LmEiICkgewoJCQkJCSMgU2VuZCBHaXQgYSBwYXRobmFtZSB0aGF0IHdhcyBub3QgZGVsYXllZCBlYXJsaWVyCgkJCQkJcGFja2V0X3R4dF93cml0ZSgicGF0aG5hbWU9dW5maWx0ZXJlZCIpOwoJCQkJfQoJCQkJaWYgKCAkcGF0aG5hbWUgZXEgIm1pc3NpbmctZGVsYXkuYSIgKSB7CgkJCQkJIyBEbyBub3Qgc2lnbmFsIEdpdCB0aGF0IHRoaXMgZmlsZSBpcyBhdmFpbGFibGUKCQkJCX0gZWxzaWYgKCAkREVMQVl7JHBhdGhuYW1lfXsiY291bnQifSA9PSAwICkgewoJCQkJCXByaW50ICRkZWJ1ZyAiICRwYXRobmFtZSI7CgkJCQkJcGFja2V0X3R4dF93cml0ZSgicGF0aG5hbWU9JHBhdGhuYW1lIik7CgkJCQl9CgkJCX0KCQl9CgoJCXBhY2tldF9mbHVzaCgpOwoKCQlwcmludCAkZGVidWcgIiBbT0tdXG4iOwoJCSRkZWJ1Zy0+Zmx1c2goKTsKCQlwYWNrZXRfdHh0X3dyaXRlKCJzdGF0dXM9c3VjY2VzcyIpOwoJCXBhY2tldF9mbHVzaCgpOwoJfSBlbHNlIHsKCQlteSAoICRyZXMsICRwYXRobmFtZSApID0gcGFja2V0X2tleV92YWxfcmVhZCgicGF0aG5hbWUiKTsKCQlpZiAoICRyZXMgPT0gLTEgKSB7CgkJCWRpZSAidW5leHBlY3RlZCBFT0Ygd2hpbGUgZXhwZWN0aW5nIHBhdGhuYW1lIjsKCQl9CgkJcHJpbnQgJGRlYnVnICIgJHBhdGhuYW1lIjsKCQkkZGVidWctPmZsdXNoKCk7CgoJCSMgUmVhZCB1bnRpbCBmbHVzaAoJCW15ICggJGRvbmUsICRidWZmZXIgKSA9IHBhY2tldF90eHRfcmVhZCgpOwoJCXdoaWxlICggJGJ1ZmZlciBuZSAnJyApIHsKCQkJaWYgKCAkYnVmZmVyIGVxICJjYW4tZGVsYXk9MSIgKSB7CgkJCQlpZiAoIGV4aXN0cyAkREVMQVl7JHBhdGhuYW1lfSBhbmQgJERFTEFZeyRwYXRobmFtZX17InJlcXVlc3RlZCJ9ID09IDAgKSB7CgkJCQkJJERFTEFZeyRwYXRobmFtZX17InJlcXVlc3RlZCJ9ID0gMTsKCQkJCX0gZWxzaWYgKCAhZXhpc3RzICRERUxBWXskcGF0aG5hbWV9IGFuZCAkYWx3YXlzX2RlbGF5ICkgewoJCQkJCSRERUxBWXskcGF0aG5hbWV9ID0geyAicmVxdWVzdGVkIiA9PiAxLCAiY291bnQiID0+IDEgfTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWRpZSAiVW5rbm93biBtZXNzYWdlICckYnVmZmVyJyI7CgkJCX0KCgkJCSggJGRvbmUsICRidWZmZXIgKSA9IHBhY2tldF90eHRfcmVhZCgpOwoJCX0KCQlpZiAoICRkb25lID09IC0xICkgewoJCQlkaWUgInVuZXhwZWN0ZWQgRU9GIGFmdGVyIHBhdGhuYW1lICckcGF0aG5hbWUnIjsKCQl9CgoJCW15ICRpbnB1dCA9ICIiOwoJCXsKCQkJYmlubW9kZShTVERJTik7CgkJCW15ICRidWZmZXI7CgkJCW15ICRkb25lID0gMDsKCQkJd2hpbGUgKCAhJGRvbmUgKSB7CgkJCQkoICRkb25lLCAkYnVmZmVyICkgPSBwYWNrZXRfYmluX3JlYWQoKTsKCQkJCSRpbnB1dCAuPSAkYnVmZmVyOwoJCQl9CgkJCWlmICggJGRvbmUgPT0gLTEgKSB7CgkJCQlkaWUgInVuZXhwZWN0ZWQgRU9GIHdoaWxlIHJlYWRpbmcgaW5wdXQgZm9yICckcGF0aG5hbWUnIjsKCQkJfQkJCQoJCQlwcmludCAkZGVidWcgIiAiIC4gbGVuZ3RoKCRpbnB1dCkgLiAiIFtPS10gLS0gIjsKCQkJJGRlYnVnLT5mbHVzaCgpOwoJCX0KCgkJbXkgJG91dHB1dDsKCQlpZiAoIGV4aXN0cyAkREVMQVl7JHBhdGhuYW1lfSBhbmQgZXhpc3RzICRERUxBWXskcGF0aG5hbWV9eyJvdXRwdXQifSApIHsKCQkJJG91dHB1dCA9ICRERUxBWXskcGF0aG5hbWV9eyJvdXRwdXQifQoJCX0gZWxzaWYgKCAkcGF0aG5hbWUgZXEgImVycm9yLnIiIG9yICRwYXRobmFtZSBlcSAiYWJvcnQuciIgKSB7CgkJCSRvdXRwdXQgPSAiIjsKCQl9IGVsc2lmICggJGNvbW1hbmQgZXEgImNsZWFuIiBhbmQgZ3JlcCggL15jbGVhbiQvLCBAY2FwYWJpbGl0aWVzICkgKSB7CgkJCSRvdXRwdXQgPSByb3QxMygkaW5wdXQpOwoJCX0gZWxzaWYgKCAkY29tbWFuZCBlcSAic211ZGdlIiBhbmQgZ3JlcCggL15zbXVkZ2UkLywgQGNhcGFiaWxpdGllcyApICkgewoJCQkkb3V0cHV0ID0gcm90MTMoJGlucHV0KTsKCQl9IGVsc2UgewoJCQlkaWUgImJhZCBjb21tYW5kICckY29tbWFuZCciOwoJCX0KCgkJaWYgKCAkcGF0aG5hbWUgZXEgImVycm9yLnIiICkgewoJCQlwcmludCAkZGVidWcgIltFUlJPUl1cbiI7CgkJCSRkZWJ1Zy0+Zmx1c2goKTsKCQkJcGFja2V0X3R4dF93cml0ZSgic3RhdHVzPWVycm9yIik7CgkJCXBhY2tldF9mbHVzaCgpOwoJCX0gZWxzaWYgKCAkcGF0aG5hbWUgZXEgImFib3J0LnIiICkgewoJCQlwcmludCAkZGVidWcgIltBQk9SVF1cbiI7CgkJCSRkZWJ1Zy0+Zmx1c2goKTsKCQkJcGFja2V0X3R4dF93cml0ZSgic3RhdHVzPWFib3J0Iik7CgkJCXBhY2tldF9mbHVzaCgpOwoJCX0gZWxzaWYgKCAkY29tbWFuZCBlcSAic211ZGdlIiBhbmQKCQkJZXhpc3RzICRERUxBWXskcGF0aG5hbWV9IGFuZAoJCQkkREVMQVl7JHBhdGhuYW1lfXsicmVxdWVzdGVkIn0gPT0gMSApIHsKCQkJcHJpbnQgJGRlYnVnICJbREVMQVlFRF1cbiI7CgkJCSRkZWJ1Zy0+Zmx1c2goKTsKCQkJcGFja2V0X3R4dF93cml0ZSgic3RhdHVzPWRlbGF5ZWQiKTsKCQkJcGFja2V0X2ZsdXNoKCk7CgkJCSRERUxBWXskcGF0aG5hbWV9eyJyZXF1ZXN0ZWQifSA9IDI7CgkJCSRERUxBWXskcGF0aG5hbWV9eyJvdXRwdXQifSA9ICRvdXRwdXQ7CgkJfSBlbHNlIHsKCQkJcGFja2V0X3R4dF93cml0ZSgic3RhdHVzPXN1Y2Nlc3MiKTsKCQkJcGFja2V0X2ZsdXNoKCk7CgoJCQlpZiAoICRwYXRobmFtZSBlcSAiJHtjb21tYW5kfS13cml0ZS1mYWlsLnIiICkgewoJCQkJcHJpbnQgJGRlYnVnICJbV1JJVEUgRkFJTF1cbiI7CgkJCQkkZGVidWctPmZsdXNoKCk7CgkJCQlkaWUgIiR7Y29tbWFuZH0gd3JpdGUgZXJyb3IiOwoJCQl9CgoJCQlwcmludCAkZGVidWcgIk9VVDogIiAuIGxlbmd0aCgkb3V0cHV0KSAuICIgIjsKCQkJJGRlYnVnLT5mbHVzaCgpOwoKCQkJd2hpbGUgKCBsZW5ndGgoJG91dHB1dCkgPiAwICkgewoJCQkJbXkgJHBhY2tldCA9IHN1YnN0ciggJG91dHB1dCwgMCwgJE1BWF9QQUNLRVRfQ09OVEVOVF9TSVpFICk7CgkJCQlwYWNrZXRfYmluX3dyaXRlKCRwYWNrZXQpOwoJCQkJIyBkb3RzIHJlcHJlc2VudCB0aGUgbnVtYmVyIG9mIHBhY2tldHMKCQkJCXByaW50ICRkZWJ1ZyAiLiI7CgkJCQlpZiAoIGxlbmd0aCgkb3V0cHV0KSA+ICRNQVhfUEFDS0VUX0NPTlRFTlRfU0laRSApIHsKCQkJCQkkb3V0cHV0ID0gc3Vic3RyKCAkb3V0cHV0LCAkTUFYX1BBQ0tFVF9DT05URU5UX1NJWkUgKTsKCQkJCX0gZWxzZSB7CgkJCQkJJG91dHB1dCA9ICIiOwoJCQkJfQoJCQl9CgkJCXBhY2tldF9mbHVzaCgpOwoJCQlwcmludCAkZGVidWcgIiBbT0tdXG4iOwoJCQkkZGVidWctPmZsdXNoKCk7CgkJCXBhY2tldF9mbHVzaCgpOwoJCX0KCX0KfQo=",
    "text": "#\n# Example implementation for the Git filter protocol version 2\n# See Documentation/gitattributes.txt, section \"Filter Protocol\"\n#\n# Usage: rot13-filter.pl [--always-delay] <log path> <capabilities>\n#\n# Log path defines a debug log file that the script writes to. The\n# subsequent arguments define a list of supported protocol capabilities\n# (\"clean\", \"smudge\", etc).\n#\n# When --always-delay is given all pathnames with the \"can-delay\" flag\n# that don't appear on the list bellow are delayed with a count of 1\n# (see more below).\n#\n# This implementation supports special test cases:\n# (1) If data with the pathname \"clean-write-fail.r\" is processed with\n#     a \"clean\" operation then the write operation will die.\n# (2) If data with the pathname \"smudge-write-fail.r\" is processed with\n#     a \"smudge\" operation then the write operation will die.\n# (3) If data with the pathname \"error.r\" is processed with any\n#     operation then the filter signals that it cannot or does not want\n#     to process the file.\n# (4) If data with the pathname \"abort.r\" is processed with any\n#     operation then the filter signals that it cannot or does not want\n#     to process the file and any file after that is processed with the\n#     same command.\n# (5) If data with a pathname that is a key in the DELAY hash is\n#     requested (e.g. \"test-delay10.a\") then the filter responds with\n#     a \"delay\" status and sets the \"requested\" field in the DELAY hash.\n#     The filter will signal the availability of this object after\n#     \"count\" (field in DELAY hash) \"list_available_blobs\" commands.\n# (6) If data with the pathname \"missing-delay.a\" is processed that the\n#     filter will drop the path from the \"list_available_blobs\" response.\n# (7) If data with the pathname \"invalid-delay.a\" is processed that the\n#     filter will add the path \"unfiltered\" which was not delayed before\n#     to the \"list_available_blobs\" response.\n#\n\nuse 5.008;\nsub gitperllib {\n\t# Git assumes that all path lists are Unix-y colon-separated ones. But\n\t# when the Git for Windows executes the test suite, its MSYS2 Bash\n\t# calls git.exe, and colon-separated path lists are converted into\n\t# Windows-y semicolon-separated lists of *Windows* paths (which\n\t# naturally contain a colon after the drive letter, so splitting by\n\t# colons simply does not cut it).\n\t#\n\t# Detect semicolon-separated path list and handle them appropriately.\n\n\tif ($ENV{GITPERLLIB} =~ /;/) {\n\t\treturn split(/;/, $ENV{GITPERLLIB});\n\t}\n\treturn split(/:/, $ENV{GITPERLLIB});\n}\nuse lib (gitperllib());\nuse strict;\nuse warnings;\nuse IO::File;\nuse Git::Packet;\n\nmy $MAX_PACKET_CONTENT_SIZE = 65516;\n\nmy $always_delay = 0;\nif ( $ARGV[0] eq '--always-delay' ) {\n\t$always_delay = 1;\n\tshift @ARGV;\n}\n\nmy $log_file                = shift @ARGV;\nmy @capabilities            = @ARGV;\n\nopen my $debug, \">>\", $log_file or die \"cannot open log file: $!\";\n\nmy %DELAY = (\n\t'test-delay10.a' => { \"requested\" => 0, \"count\" => 1 },\n\t'test-delay11.a' => { \"requested\" => 0, \"count\" => 1 },\n\t'test-delay20.a' => { \"requested\" => 0, \"count\" => 2 },\n\t'test-delay10.b' => { \"requested\" => 0, \"count\" => 1 },\n\t'missing-delay.a' => { \"requested\" => 0, \"count\" => 1 },\n\t'invalid-delay.a' => { \"requested\" => 0, \"count\" => 1 },\n);\n\nsub rot13 {\n\tmy $str = shift;\n\t$str =~ y/A-Za-z/N-ZA-Mn-za-m/;\n\treturn $str;\n}\n\nprint $debug \"START\\n\";\n$debug->flush();\n\npacket_initialize(\"git-filter\", 2);\n\nmy %remote_caps = packet_read_and_check_capabilities(\"clean\", \"smudge\", \"delay\");\npacket_check_and_write_capabilities(\\%remote_caps, @capabilities);\n\nprint $debug \"init handshake complete\\n\";\n$debug->flush();\n\nwhile (1) {\n\tmy ( $res, $command ) = packet_key_val_read(\"command\");\n\tif ( $res == -1 ) {\n\t\tprint $debug \"STOP\\n\";\n\t\texit();\n\t}\n\tprint $debug \"IN: $command\";\n\t$debug->flush();\n\n\tif ( $command eq \"list_available_blobs\" ) {\n\t\t# Flush\n\t\tpacket_compare_lists([1, \"\"], packet_bin_read()) ||\n\t\t\tdie \"bad list_available_blobs end\";\n\n\t\tforeach my $pathname ( sort keys %DELAY ) {\n\t\t\tif ( $DELAY{$pathname}{\"requested\"} >= 1 ) {\n\t\t\t\t$DELAY{$pathname}{\"count\"} = $DELAY{$pathname}{\"count\"} - 1;\n\t\t\t\tif ( $pathname eq \"invalid-delay.a\" ) {\n\t\t\t\t\t# Send Git a pathname that was not delayed earlier\n\t\t\t\t\tpacket_txt_write(\"pathname=unfiltered\");\n\t\t\t\t}\n\t\t\t\tif ( $pathname eq \"missing-delay.a\" ) {\n\t\t\t\t\t# Do not signal Git that this file is available\n\t\t\t\t} elsif ( $DELAY{$pathname}{\"count\"} == 0 ) {\n\t\t\t\t\tprint $debug \" $pathname\";\n\t\t\t\t\tpacket_txt_write(\"pathname=$pathname\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tpacket_flush();\n\n\t\tprint $debug \" [OK]\\n\";\n\t\t$debug->flush();\n\t\tpacket_txt_write(\"status=success\");\n\t\tpacket_flush();\n\t} else {\n\t\tmy ( $res, $pathname ) = packet_key_val_read(\"pathname\");\n\t\tif ( $res == -1 ) {\n\t\t\tdie \"unexpected EOF while expecting pathname\";\n\t\t}\n\t\tprint $debug \" $pathname\";\n\t\t$debug->flush();\n\n\t\t# Read until flush\n\t\tmy ( $done, $buffer ) = packet_txt_read();\n\t\twhile ( $buffer ne '' ) {\n\t\t\tif ( $buffer eq \"can-delay=1\" ) {\n\t\t\t\tif ( exists $DELAY{$pathname} and $DELAY{$pathname}{\"requested\"} == 0 ) {\n\t\t\t\t\t$DELAY{$pathname}{\"requested\"} = 1;\n\t\t\t\t} elsif ( !exists $DELAY{$pathname} and $always_delay ) {\n\t\t\t\t\t$DELAY{$pathname} = { \"requested\" => 1, \"count\" => 1 };\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tdie \"Unknown message '$buffer'\";\n\t\t\t}\n\n\t\t\t( $done, $buffer ) = packet_txt_read();\n\t\t}\n\t\tif ( $done == -1 ) {\n\t\t\tdie \"unexpected EOF after pathname '$pathname'\";\n\t\t}\n\n\t\tmy $input = \"\";\n\t\t{\n\t\t\tbinmode(STDIN);\n\t\t\tmy $buffer;\n\t\t\tmy $done = 0;\n\t\t\twhile ( !$done ) {\n\t\t\t\t( $done, $buffer ) = packet_bin_read();\n\t\t\t\t$input .= $buffer;\n\t\t\t}\n\t\t\tif ( $done == -1 ) {\n\t\t\t\tdie \"unexpected EOF while reading input for '$pathname'\";\n\t\t\t}\t\t\t\n\t\t\tprint $debug \" \" . length($input) . \" [OK] -- \";\n\t\t\t$debug->flush();\n\t\t}\n\n\t\tmy $output;\n\t\tif ( exists $DELAY{$pathname} and exists $DELAY{$pathname}{\"output\"} ) {\n\t\t\t$output = $DELAY{$pathname}{\"output\"}\n\t\t} elsif ( $pathname eq \"error.r\" or $pathname eq \"abort.r\" ) {\n\t\t\t$output = \"\";\n\t\t} elsif ( $command eq \"clean\" and grep( /^clean$/, @capabilities ) ) {\n\t\t\t$output = rot13($input);\n\t\t} elsif ( $command eq \"smudge\" and grep( /^smudge$/, @capabilities ) ) {\n\t\t\t$output = rot13($input);\n\t\t} else {\n\t\t\tdie \"bad command '$command'\";\n\t\t}\n\n\t\tif ( $pathname eq \"error.r\" ) {\n\t\t\tprint $debug \"[ERROR]\\n\";\n\t\t\t$debug->flush();\n\t\t\tpacket_txt_write(\"status=error\");\n\t\t\tpacket_flush();\n\t\t} elsif ( $pathname eq \"abort.r\" ) {\n\t\t\tprint $debug \"[ABORT]\\n\";\n\t\t\t$debug->flush();\n\t\t\tpacket_txt_write(\"status=abort\");\n\t\t\tpacket_flush();\n\t\t} elsif ( $command eq \"smudge\" and\n\t\t\texists $DELAY{$pathname} and\n\t\t\t$DELAY{$pathname}{\"requested\"} == 1 ) {\n\t\t\tprint $debug \"[DELAYED]\\n\";\n\t\t\t$debug->flush();\n\t\t\tpacket_txt_write(\"status=delayed\");\n\t\t\tpacket_flush();\n\t\t\t$DELAY{$pathname}{\"requested\"} = 2;\n\t\t\t$DELAY{$pathname}{\"output\"} = $output;\n\t\t} else {\n\t\t\tpacket_txt_write(\"status=success\");\n\t\t\tpacket_flush();\n\n\t\t\tif ( $pathname eq \"${command}-write-fail.r\" ) {\n\t\t\t\tprint $debug \"[WRITE FAIL]\\n\";\n\t\t\t\t$debug->flush();\n\t\t\t\tdie \"${command} write error\";\n\t\t\t}\n\n\t\t\tprint $debug \"OUT: \" . length($output) . \" \";\n\t\t\t$debug->flush();\n\n\t\t\twhile ( length($output) > 0 ) {\n\t\t\t\tmy $packet = substr( $output, 0, $MAX_PACKET_CONTENT_SIZE );\n\t\t\t\tpacket_bin_write($packet);\n\t\t\t\t# dots represent the number of packets\n\t\t\t\tprint $debug \".\";\n\t\t\t\tif ( length($output) > $MAX_PACKET_CONTENT_SIZE ) {\n\t\t\t\t\t$output = substr( $output, $MAX_PACKET_CONTENT_SIZE );\n\t\t\t\t} else {\n\t\t\t\t\t$output = \"\";\n\t\t\t\t}\n\t\t\t}\n\t\t\tpacket_flush();\n\t\t\tprint $debug \" [OK]\\n\";\n\t\t\t$debug->flush();\n\t\t\tpacket_flush();\n\t\t}\n\t}\n}\n",
    "type": "blob"
  },
  "kind": "blob",
  "oid": "007f2d78ea5b035a3c07b38b6fd5df5dee005273",
  "sha1_ok": true,
  "size": 7493
}
