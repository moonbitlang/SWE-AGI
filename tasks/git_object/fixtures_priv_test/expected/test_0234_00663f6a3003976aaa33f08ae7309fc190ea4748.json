{
  "content": {
    "base64": "LyoKICogQnVpbHRpbiAiZ2l0IHZlcmlmeS10YWciCiAqCiAqIENvcHlyaWdodCAoYykgMjAwNyBDYXJsb3MgUmljYSA8amFzYW1wbGVyQGdtYWlsLmNvbT4KICoKICogQmFzZWQgb24gZ2l0LXZlcmlmeS10YWcuc2gKICovCiNpbmNsdWRlICJjYWNoZS5oIgojaW5jbHVkZSAiYnVpbHRpbi5oIgojaW5jbHVkZSAidGFnLmgiCiNpbmNsdWRlICJydW4tY29tbWFuZC5oIgojaW5jbHVkZSA8c2lnbmFsLmg+CiNpbmNsdWRlICJwYXJzZS1vcHRpb25zLmgiCiNpbmNsdWRlICJncGctaW50ZXJmYWNlLmgiCgpzdGF0aWMgY29uc3QgY2hhciAqIGNvbnN0IHZlcmlmeV90YWdfdXNhZ2VbXSA9IHsKCQlOXygiZ2l0IHZlcmlmeS10YWcgWy12IHwgLS12ZXJib3NlXSA8dGFnPi4uLiIpLAoJCU5VTEwKfTsKCnN0YXRpYyBpbnQgcnVuX2dwZ192ZXJpZnkoY29uc3QgY2hhciAqYnVmLCB1bnNpZ25lZCBsb25nIHNpemUsIHVuc2lnbmVkIGZsYWdzKQp7CglzdHJ1Y3Qgc2lnbmF0dXJlX2NoZWNrIHNpZ2M7CglpbnQgbGVuOwoJaW50IHJldDsKCgltZW1zZXQoJnNpZ2MsIDAsIHNpemVvZihzaWdjKSk7CgoJbGVuID0gcGFyc2Vfc2lnbmF0dXJlKGJ1Ziwgc2l6ZSk7CgoJaWYgKHNpemUgPT0gbGVuKSB7CgkJaWYgKGZsYWdzICYgR1BHX1ZFUklGWV9WRVJCT1NFKQoJCQl3cml0ZV9pbl9mdWxsKDEsIGJ1ZiwgbGVuKTsKCQlyZXR1cm4gZXJyb3IoIm5vIHNpZ25hdHVyZSBmb3VuZCIpOwoJfQoKCXJldCA9IGNoZWNrX3NpZ25hdHVyZShidWYsIGxlbiwgYnVmICsgbGVuLCBzaXplIC0gbGVuLCAmc2lnYyk7CglwcmludF9zaWduYXR1cmVfYnVmZmVyKCZzaWdjLCBmbGFncyk7CgoJc2lnbmF0dXJlX2NoZWNrX2NsZWFyKCZzaWdjKTsKCXJldHVybiByZXQ7Cn0KCnN0YXRpYyBpbnQgdmVyaWZ5X3RhZyhjb25zdCBjaGFyICpuYW1lLCB1bnNpZ25lZCBmbGFncykKewoJZW51bSBvYmplY3RfdHlwZSB0eXBlOwoJdW5zaWduZWQgY2hhciBzaGExWzIwXTsKCWNoYXIgKmJ1ZjsKCXVuc2lnbmVkIGxvbmcgc2l6ZTsKCWludCByZXQ7CgoJaWYgKGdldF9zaGExKG5hbWUsIHNoYTEpKQoJCXJldHVybiBlcnJvcigidGFnICclcycgbm90IGZvdW5kLiIsIG5hbWUpOwoKCXR5cGUgPSBzaGExX29iamVjdF9pbmZvKHNoYTEsIE5VTEwpOwoJaWYgKHR5cGUgIT0gT0JKX1RBRykKCQlyZXR1cm4gZXJyb3IoIiVzOiBjYW5ub3QgdmVyaWZ5IGEgbm9uLXRhZyBvYmplY3Qgb2YgdHlwZSAlcy4iLAoJCQkJbmFtZSwgdHlwZW5hbWUodHlwZSkpOwoKCWJ1ZiA9IHJlYWRfc2hhMV9maWxlKHNoYTEsICZ0eXBlLCAmc2l6ZSk7CglpZiAoIWJ1ZikKCQlyZXR1cm4gZXJyb3IoIiVzOiB1bmFibGUgdG8gcmVhZCBmaWxlLiIsIG5hbWUpOwoKCXJldCA9IHJ1bl9ncGdfdmVyaWZ5KGJ1Ziwgc2l6ZSwgZmxhZ3MpOwoKCWZyZWUoYnVmKTsKCXJldHVybiByZXQ7Cn0KCnN0YXRpYyBpbnQgZ2l0X3ZlcmlmeV90YWdfY29uZmlnKGNvbnN0IGNoYXIgKnZhciwgY29uc3QgY2hhciAqdmFsdWUsIHZvaWQgKmNiKQp7CglpbnQgc3RhdHVzID0gZ2l0X2dwZ19jb25maWcodmFyLCB2YWx1ZSwgY2IpOwoJaWYgKHN0YXR1cykKCQlyZXR1cm4gc3RhdHVzOwoJcmV0dXJuIGdpdF9kZWZhdWx0X2NvbmZpZyh2YXIsIHZhbHVlLCBjYik7Cn0KCmludCBjbWRfdmVyaWZ5X3RhZyhpbnQgYXJnYywgY29uc3QgY2hhciAqKmFyZ3YsIGNvbnN0IGNoYXIgKnByZWZpeCkKewoJaW50IGkgPSAxLCB2ZXJib3NlID0gMCwgaGFkX2Vycm9yID0gMDsKCXVuc2lnbmVkIGZsYWdzID0gMDsKCWNvbnN0IHN0cnVjdCBvcHRpb24gdmVyaWZ5X3RhZ19vcHRpb25zW10gPSB7CgkJT1BUX19WRVJCT1NFKCZ2ZXJib3NlLCBOXygicHJpbnQgdGFnIGNvbnRlbnRzIikpLAoJCU9QVF9CSVQoMCwgInJhdyIsICZmbGFncywgTl8oInByaW50IHJhdyBncGcgc3RhdHVzIG91dHB1dCIpLCBHUEdfVkVSSUZZX1JBVyksCgkJT1BUX0VORCgpCgl9OwoKCWdpdF9jb25maWcoZ2l0X3ZlcmlmeV90YWdfY29uZmlnLCBOVUxMKTsKCglhcmdjID0gcGFyc2Vfb3B0aW9ucyhhcmdjLCBhcmd2LCBwcmVmaXgsIHZlcmlmeV90YWdfb3B0aW9ucywKCQkJICAgICB2ZXJpZnlfdGFnX3VzYWdlLCBQQVJTRV9PUFRfS0VFUF9BUkdWMCk7CglpZiAoYXJnYyA8PSBpKQoJCXVzYWdlX3dpdGhfb3B0aW9ucyh2ZXJpZnlfdGFnX3VzYWdlLCB2ZXJpZnlfdGFnX29wdGlvbnMpOwoKCWlmICh2ZXJib3NlKQoJCWZsYWdzIHw9IEdQR19WRVJJRllfVkVSQk9TRTsKCgkvKiBzb21ldGltZXMgdGhlIHByb2dyYW0gd2FzIHRlcm1pbmF0ZWQgYmVjYXVzZSB0aGlzIHNpZ25hbAoJICogd2FzIHJlY2VpdmVkIGluIHRoZSBwcm9jZXNzIG9mIHdyaXRpbmcgdGhlIGdwZyBpbnB1dDogKi8KCXNpZ25hbChTSUdQSVBFLCBTSUdfSUdOKTsKCXdoaWxlIChpIDwgYXJnYykKCQlpZiAodmVyaWZ5X3RhZyhhcmd2W2krK10sIGZsYWdzKSkKCQkJaGFkX2Vycm9yID0gMTsKCXJldHVybiBoYWRfZXJyb3I7Cn0K",
    "text": "/*\n * Builtin \"git verify-tag\"\n *\n * Copyright (c) 2007 Carlos Rica <jasampler@gmail.com>\n *\n * Based on git-verify-tag.sh\n */\n#include \"cache.h\"\n#include \"builtin.h\"\n#include \"tag.h\"\n#include \"run-command.h\"\n#include <signal.h>\n#include \"parse-options.h\"\n#include \"gpg-interface.h\"\n\nstatic const char * const verify_tag_usage[] = {\n\t\tN_(\"git verify-tag [-v | --verbose] <tag>...\"),\n\t\tNULL\n};\n\nstatic int run_gpg_verify(const char *buf, unsigned long size, unsigned flags)\n{\n\tstruct signature_check sigc;\n\tint len;\n\tint ret;\n\n\tmemset(&sigc, 0, sizeof(sigc));\n\n\tlen = parse_signature(buf, size);\n\n\tif (size == len) {\n\t\tif (flags & GPG_VERIFY_VERBOSE)\n\t\t\twrite_in_full(1, buf, len);\n\t\treturn error(\"no signature found\");\n\t}\n\n\tret = check_signature(buf, len, buf + len, size - len, &sigc);\n\tprint_signature_buffer(&sigc, flags);\n\n\tsignature_check_clear(&sigc);\n\treturn ret;\n}\n\nstatic int verify_tag(const char *name, unsigned flags)\n{\n\tenum object_type type;\n\tunsigned char sha1[20];\n\tchar *buf;\n\tunsigned long size;\n\tint ret;\n\n\tif (get_sha1(name, sha1))\n\t\treturn error(\"tag '%s' not found.\", name);\n\n\ttype = sha1_object_info(sha1, NULL);\n\tif (type != OBJ_TAG)\n\t\treturn error(\"%s: cannot verify a non-tag object of type %s.\",\n\t\t\t\tname, typename(type));\n\n\tbuf = read_sha1_file(sha1, &type, &size);\n\tif (!buf)\n\t\treturn error(\"%s: unable to read file.\", name);\n\n\tret = run_gpg_verify(buf, size, flags);\n\n\tfree(buf);\n\treturn ret;\n}\n\nstatic int git_verify_tag_config(const char *var, const char *value, void *cb)\n{\n\tint status = git_gpg_config(var, value, cb);\n\tif (status)\n\t\treturn status;\n\treturn git_default_config(var, value, cb);\n}\n\nint cmd_verify_tag(int argc, const char **argv, const char *prefix)\n{\n\tint i = 1, verbose = 0, had_error = 0;\n\tunsigned flags = 0;\n\tconst struct option verify_tag_options[] = {\n\t\tOPT__VERBOSE(&verbose, N_(\"print tag contents\")),\n\t\tOPT_BIT(0, \"raw\", &flags, N_(\"print raw gpg status output\"), GPG_VERIFY_RAW),\n\t\tOPT_END()\n\t};\n\n\tgit_config(git_verify_tag_config, NULL);\n\n\targc = parse_options(argc, argv, prefix, verify_tag_options,\n\t\t\t     verify_tag_usage, PARSE_OPT_KEEP_ARGV0);\n\tif (argc <= i)\n\t\tusage_with_options(verify_tag_usage, verify_tag_options);\n\n\tif (verbose)\n\t\tflags |= GPG_VERIFY_VERBOSE;\n\n\t/* sometimes the program was terminated because this signal\n\t * was received in the process of writing the gpg input: */\n\tsignal(SIGPIPE, SIG_IGN);\n\twhile (i < argc)\n\t\tif (verify_tag(argv[i++], flags))\n\t\t\thad_error = 1;\n\treturn had_error;\n}\n",
    "type": "blob"
  },
  "kind": "blob",
  "oid": "00663f6a3003976aaa33f08ae7309fc190ea4748",
  "sha1_ok": true,
  "size": 2475
}
