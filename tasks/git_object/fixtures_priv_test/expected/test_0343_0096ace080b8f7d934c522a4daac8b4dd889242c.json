{
  "content": {
    "base64": "I2luY2x1ZGUgImNhY2hlLmgiCiNpbmNsdWRlICJnZXR0ZXh0LmgiCiNpbmNsdWRlICJwYWNrLW10aW1lcy5oIgojaW5jbHVkZSAib2JqZWN0LWZpbGUuaCIKI2luY2x1ZGUgIm9iamVjdC1zdG9yZS5oIgojaW5jbHVkZSAicGFja2ZpbGUuaCIKCnN0YXRpYyBjaGFyICpwYWNrX210aW1lc19maWxlbmFtZShzdHJ1Y3QgcGFja2VkX2dpdCAqcCkKewoJc2l6ZV90IGxlbjsKCWlmICghc3RyaXBfc3VmZml4KHAtPnBhY2tfbmFtZSwgIi5wYWNrIiwgJmxlbikpCgkJQlVHKCJwYWNrX25hbWUgZG9lcyBub3QgZW5kIGluIC5wYWNrIik7CglyZXR1cm4geHN0cmZtdCgiJS4qcy5tdGltZXMiLCAoaW50KWxlbiwgcC0+cGFja19uYW1lKTsKfQoKI2RlZmluZSBNVElNRVNfSEVBREVSX1NJWkUgKDEyKQoKc3RydWN0IG10aW1lc19oZWFkZXIgewoJdWludDMyX3Qgc2lnbmF0dXJlOwoJdWludDMyX3QgdmVyc2lvbjsKCXVpbnQzMl90IGhhc2hfaWQ7Cn07CgpzdGF0aWMgaW50IGxvYWRfcGFja19tdGltZXNfZmlsZShjaGFyICptdGltZXNfZmlsZSwKCQkJCSB1aW50MzJfdCBudW1fb2JqZWN0cywKCQkJCSBjb25zdCB1aW50MzJfdCAqKmRhdGFfcCwgc2l6ZV90ICpsZW5fcCkKewoJaW50IGZkLCByZXQgPSAwOwoJc3RydWN0IHN0YXQgc3Q7Cgl1aW50MzJfdCAqZGF0YSA9IE5VTEw7CglzaXplX3QgbXRpbWVzX3NpemUsIGV4cGVjdGVkX3NpemU7CglzdHJ1Y3QgbXRpbWVzX2hlYWRlciBoZWFkZXI7CgoJZmQgPSBnaXRfb3BlbihtdGltZXNfZmlsZSk7CgoJaWYgKGZkIDwgMCkgewoJCXJldCA9IC0xOwoJCWdvdG8gY2xlYW51cDsKCX0KCWlmIChmc3RhdChmZCwgJnN0KSkgewoJCXJldCA9IGVycm9yX2Vycm5vKF8oImZhaWxlZCB0byByZWFkICVzIiksIG10aW1lc19maWxlKTsKCQlnb3RvIGNsZWFudXA7Cgl9CgoJbXRpbWVzX3NpemUgPSB4c2l6ZV90KHN0LnN0X3NpemUpOwoKCWlmIChtdGltZXNfc2l6ZSA8IE1USU1FU19IRUFERVJfU0laRSkgewoJCXJldCA9IGVycm9yKF8oIm10aW1lcyBmaWxlICVzIGlzIHRvbyBzbWFsbCIpLCBtdGltZXNfZmlsZSk7CgkJZ290byBjbGVhbnVwOwoJfQoKCWRhdGEgPSB4bW1hcChOVUxMLCBtdGltZXNfc2l6ZSwgUFJPVF9SRUFELCBNQVBfUFJJVkFURSwgZmQsIDApOwoKCWhlYWRlci5zaWduYXR1cmUgPSBudG9obChkYXRhWzBdKTsKCWhlYWRlci52ZXJzaW9uID0gbnRvaGwoZGF0YVsxXSk7CgloZWFkZXIuaGFzaF9pZCA9IG50b2hsKGRhdGFbMl0pOwoKCWlmIChoZWFkZXIuc2lnbmF0dXJlICE9IE1USU1FU19TSUdOQVRVUkUpIHsKCQlyZXQgPSBlcnJvcihfKCJtdGltZXMgZmlsZSAlcyBoYXMgdW5rbm93biBzaWduYXR1cmUiKSwgbXRpbWVzX2ZpbGUpOwoJCWdvdG8gY2xlYW51cDsKCX0KCglpZiAoaGVhZGVyLnZlcnNpb24gIT0gMSkgewoJCXJldCA9IGVycm9yKF8oIm10aW1lcyBmaWxlICVzIGhhcyB1bnN1cHBvcnRlZCB2ZXJzaW9uICUiUFJJdTMyKSwKCQkJICAgIG10aW1lc19maWxlLCBoZWFkZXIudmVyc2lvbik7CgkJZ290byBjbGVhbnVwOwoJfQoKCWlmICghKGhlYWRlci5oYXNoX2lkID09IDEgfHwgaGVhZGVyLmhhc2hfaWQgPT0gMikpIHsKCQlyZXQgPSBlcnJvcihfKCJtdGltZXMgZmlsZSAlcyBoYXMgdW5zdXBwb3J0ZWQgaGFzaCBpZCAlIlBSSXUzMiksCgkJCSAgICBtdGltZXNfZmlsZSwgaGVhZGVyLmhhc2hfaWQpOwoJCWdvdG8gY2xlYW51cDsKCX0KCgoJZXhwZWN0ZWRfc2l6ZSA9IE1USU1FU19IRUFERVJfU0laRTsKCWV4cGVjdGVkX3NpemUgPSBzdF9hZGQoZXhwZWN0ZWRfc2l6ZSwgc3RfbXVsdChzaXplb2YodWludDMyX3QpLCBudW1fb2JqZWN0cykpOwoJZXhwZWN0ZWRfc2l6ZSA9IHN0X2FkZChleHBlY3RlZF9zaXplLCAyICogKGhlYWRlci5oYXNoX2lkID09IDEgPyBHSVRfU0hBMV9SQVdTWiA6IEdJVF9TSEEyNTZfUkFXU1opKTsKCglpZiAobXRpbWVzX3NpemUgIT0gZXhwZWN0ZWRfc2l6ZSkgewoJCXJldCA9IGVycm9yKF8oIm10aW1lcyBmaWxlICVzIGlzIGNvcnJ1cHQiKSwgbXRpbWVzX2ZpbGUpOwoJCWdvdG8gY2xlYW51cDsKCX0KCmNsZWFudXA6CglpZiAocmV0KSB7CgkJaWYgKGRhdGEpCgkJCW11bm1hcChkYXRhLCBtdGltZXNfc2l6ZSk7Cgl9IGVsc2UgewoJCSpsZW5fcCA9IG10aW1lc19zaXplOwoJCSpkYXRhX3AgPSBkYXRhOwoJfQoKCWlmIChmZCA+PSAwKQoJCWNsb3NlKGZkKTsKCXJldHVybiByZXQ7Cn0KCmludCBsb2FkX3BhY2tfbXRpbWVzKHN0cnVjdCBwYWNrZWRfZ2l0ICpwKQp7CgljaGFyICptdGltZXNfbmFtZSA9IE5VTEw7CglpbnQgcmV0ID0gMDsKCglpZiAoIXAtPmlzX2NydWZ0KQoJCXJldHVybiByZXQ7IC8qIG5vdCBhIGNydWZ0IHBhY2sgKi8KCWlmIChwLT5tdGltZXNfbWFwKQoJCXJldHVybiByZXQ7IC8qIGFscmVhZHkgbG9hZGVkICovCgoJcmV0ID0gb3Blbl9wYWNrX2luZGV4KHApOwoJaWYgKHJldCA8IDApCgkJZ290byBjbGVhbnVwOwoKCW10aW1lc19uYW1lID0gcGFja19tdGltZXNfZmlsZW5hbWUocCk7CglyZXQgPSBsb2FkX3BhY2tfbXRpbWVzX2ZpbGUobXRpbWVzX25hbWUsCgkJCQkgICAgcC0+bnVtX29iamVjdHMsCgkJCQkgICAgJnAtPm10aW1lc19tYXAsCgkJCQkgICAgJnAtPm10aW1lc19zaXplKTsKY2xlYW51cDoKCWZyZWUobXRpbWVzX25hbWUpOwoJcmV0dXJuIHJldDsKfQoKdWludDMyX3QgbnRoX3BhY2tlZF9tdGltZShzdHJ1Y3QgcGFja2VkX2dpdCAqcCwgdWludDMyX3QgcG9zKQp7CglpZiAoIXAtPm10aW1lc19tYXApCgkJQlVHKCJwYWNrIC5tdGltZXMgZmlsZSBub3QgbG9hZGVkIGZvciAlcyIsIHAtPnBhY2tfbmFtZSk7CglpZiAocC0+bnVtX29iamVjdHMgPD0gcG9zKQoJCUJVRygicGFjayAubXRpbWVzIG91dC1vZi1ib3VuZHMgKCUiUFJJdTMyIiB2cyAlIlBSSXUzMiIpIiwKCQkgICAgcG9zLCBwLT5udW1fb2JqZWN0cyk7CgoJcmV0dXJuIGdldF9iZTMyKHAtPm10aW1lc19tYXAgKyBwb3MgKyAzKTsKfQo=",
    "text": "#include \"cache.h\"\n#include \"gettext.h\"\n#include \"pack-mtimes.h\"\n#include \"object-file.h\"\n#include \"object-store.h\"\n#include \"packfile.h\"\n\nstatic char *pack_mtimes_filename(struct packed_git *p)\n{\n\tsize_t len;\n\tif (!strip_suffix(p->pack_name, \".pack\", &len))\n\t\tBUG(\"pack_name does not end in .pack\");\n\treturn xstrfmt(\"%.*s.mtimes\", (int)len, p->pack_name);\n}\n\n#define MTIMES_HEADER_SIZE (12)\n\nstruct mtimes_header {\n\tuint32_t signature;\n\tuint32_t version;\n\tuint32_t hash_id;\n};\n\nstatic int load_pack_mtimes_file(char *mtimes_file,\n\t\t\t\t uint32_t num_objects,\n\t\t\t\t const uint32_t **data_p, size_t *len_p)\n{\n\tint fd, ret = 0;\n\tstruct stat st;\n\tuint32_t *data = NULL;\n\tsize_t mtimes_size, expected_size;\n\tstruct mtimes_header header;\n\n\tfd = git_open(mtimes_file);\n\n\tif (fd < 0) {\n\t\tret = -1;\n\t\tgoto cleanup;\n\t}\n\tif (fstat(fd, &st)) {\n\t\tret = error_errno(_(\"failed to read %s\"), mtimes_file);\n\t\tgoto cleanup;\n\t}\n\n\tmtimes_size = xsize_t(st.st_size);\n\n\tif (mtimes_size < MTIMES_HEADER_SIZE) {\n\t\tret = error(_(\"mtimes file %s is too small\"), mtimes_file);\n\t\tgoto cleanup;\n\t}\n\n\tdata = xmmap(NULL, mtimes_size, PROT_READ, MAP_PRIVATE, fd, 0);\n\n\theader.signature = ntohl(data[0]);\n\theader.version = ntohl(data[1]);\n\theader.hash_id = ntohl(data[2]);\n\n\tif (header.signature != MTIMES_SIGNATURE) {\n\t\tret = error(_(\"mtimes file %s has unknown signature\"), mtimes_file);\n\t\tgoto cleanup;\n\t}\n\n\tif (header.version != 1) {\n\t\tret = error(_(\"mtimes file %s has unsupported version %\"PRIu32),\n\t\t\t    mtimes_file, header.version);\n\t\tgoto cleanup;\n\t}\n\n\tif (!(header.hash_id == 1 || header.hash_id == 2)) {\n\t\tret = error(_(\"mtimes file %s has unsupported hash id %\"PRIu32),\n\t\t\t    mtimes_file, header.hash_id);\n\t\tgoto cleanup;\n\t}\n\n\n\texpected_size = MTIMES_HEADER_SIZE;\n\texpected_size = st_add(expected_size, st_mult(sizeof(uint32_t), num_objects));\n\texpected_size = st_add(expected_size, 2 * (header.hash_id == 1 ? GIT_SHA1_RAWSZ : GIT_SHA256_RAWSZ));\n\n\tif (mtimes_size != expected_size) {\n\t\tret = error(_(\"mtimes file %s is corrupt\"), mtimes_file);\n\t\tgoto cleanup;\n\t}\n\ncleanup:\n\tif (ret) {\n\t\tif (data)\n\t\t\tmunmap(data, mtimes_size);\n\t} else {\n\t\t*len_p = mtimes_size;\n\t\t*data_p = data;\n\t}\n\n\tif (fd >= 0)\n\t\tclose(fd);\n\treturn ret;\n}\n\nint load_pack_mtimes(struct packed_git *p)\n{\n\tchar *mtimes_name = NULL;\n\tint ret = 0;\n\n\tif (!p->is_cruft)\n\t\treturn ret; /* not a cruft pack */\n\tif (p->mtimes_map)\n\t\treturn ret; /* already loaded */\n\n\tret = open_pack_index(p);\n\tif (ret < 0)\n\t\tgoto cleanup;\n\n\tmtimes_name = pack_mtimes_filename(p);\n\tret = load_pack_mtimes_file(mtimes_name,\n\t\t\t\t    p->num_objects,\n\t\t\t\t    &p->mtimes_map,\n\t\t\t\t    &p->mtimes_size);\ncleanup:\n\tfree(mtimes_name);\n\treturn ret;\n}\n\nuint32_t nth_packed_mtime(struct packed_git *p, uint32_t pos)\n{\n\tif (!p->mtimes_map)\n\t\tBUG(\"pack .mtimes file not loaded for %s\", p->pack_name);\n\tif (p->num_objects <= pos)\n\t\tBUG(\"pack .mtimes out-of-bounds (%\"PRIu32\" vs %\"PRIu32\")\",\n\t\t    pos, p->num_objects);\n\n\treturn get_be32(p->mtimes_map + pos + 3);\n}\n",
    "type": "blob"
  },
  "kind": "blob",
  "oid": "0096ace080b8f7d934c522a4daac8b4dd889242c",
  "sha1_ok": true,
  "size": 2972
}
