{
  "content": {
    "base64": "I2luY2x1ZGUgImJ1aWx0aW4uaCIKI2luY2x1ZGUgImNhY2hlLmgiCiNpbmNsdWRlICJkaXIuaCIKI2luY2x1ZGUgInN0cmluZy1saXN0LmgiCiNpbmNsdWRlICJyZXJlcmUuaCIKI2luY2x1ZGUgInhkaWZmL3hkaWZmLmgiCiNpbmNsdWRlICJ4ZGlmZi1pbnRlcmZhY2UuaCIKCnN0YXRpYyBjb25zdCBjaGFyIGdpdF9yZXJlcmVfdXNhZ2VbXSA9CiJnaXQgcmVyZXJlIFtjbGVhciB8IHN0YXR1cyB8IGRpZmYgfCBnY10iOwoKLyogdGhlc2UgdmFsdWVzIGFyZSBkYXlzICovCnN0YXRpYyBpbnQgY3V0b2ZmX25vcmVzb2x2ZSA9IDE1OwpzdGF0aWMgaW50IGN1dG9mZl9yZXNvbHZlID0gNjA7CgpzdGF0aWMgdGltZV90IHJlcmVyZV9jcmVhdGVkX2F0KGNvbnN0IGNoYXIgKm5hbWUpCnsKCXN0cnVjdCBzdGF0IHN0OwoJcmV0dXJuIHN0YXQocmVyZXJlX3BhdGgobmFtZSwgInByZWltYWdlIiksICZzdCkgPyAodGltZV90KSAwIDogc3Quc3RfbXRpbWU7Cn0KCnN0YXRpYyB2b2lkIHVubGlua19ycl9pdGVtKGNvbnN0IGNoYXIgKm5hbWUpCnsKCXVubGluayhyZXJlcmVfcGF0aChuYW1lLCAidGhpc2ltYWdlIikpOwoJdW5saW5rKHJlcmVyZV9wYXRoKG5hbWUsICJwcmVpbWFnZSIpKTsKCXVubGluayhyZXJlcmVfcGF0aChuYW1lLCAicG9zdGltYWdlIikpOwoJcm1kaXIoZ2l0X3BhdGgoInJyLWNhY2hlLyVzIiwgbmFtZSkpOwp9CgpzdGF0aWMgaW50IGdpdF9yZXJlcmVfZ2NfY29uZmlnKGNvbnN0IGNoYXIgKnZhciwgY29uc3QgY2hhciAqdmFsdWUsIHZvaWQgKmNiKQp7CglpZiAoIXN0cmNtcCh2YXIsICJnYy5yZXJlcmVyZXNvbHZlZCIpKQoJCWN1dG9mZl9yZXNvbHZlID0gZ2l0X2NvbmZpZ19pbnQodmFyLCB2YWx1ZSk7CgllbHNlIGlmICghc3RyY21wKHZhciwgImdjLnJlcmVyZXVucmVzb2x2ZWQiKSkKCQljdXRvZmZfbm9yZXNvbHZlID0gZ2l0X2NvbmZpZ19pbnQodmFyLCB2YWx1ZSk7CgllbHNlCgkJcmV0dXJuIGdpdF9kZWZhdWx0X2NvbmZpZyh2YXIsIHZhbHVlLCBjYik7CglyZXR1cm4gMDsKfQoKc3RhdGljIHZvaWQgZ2FyYmFnZV9jb2xsZWN0KHN0cnVjdCBzdHJpbmdfbGlzdCAqcnIpCnsKCXN0cnVjdCBzdHJpbmdfbGlzdCB0b19yZW1vdmUgPSB7IE5VTEwsIDAsIDAsIDEgfTsKCURJUiAqZGlyOwoJc3RydWN0IGRpcmVudCAqZTsKCWludCBpLCBjdXRvZmY7Cgl0aW1lX3Qgbm93ID0gdGltZShOVUxMKSwgdGhlbjsKCglnaXRfY29uZmlnKGdpdF9yZXJlcmVfZ2NfY29uZmlnLCBOVUxMKTsKCWRpciA9IG9wZW5kaXIoZ2l0X3BhdGgoInJyLWNhY2hlIikpOwoJaWYgKCFkaXIpCgkJZGllX2Vycm5vKCJ1bmFibGUgdG8gb3BlbiByci1jYWNoZSBkaXJlY3RvcnkiKTsKCXdoaWxlICgoZSA9IHJlYWRkaXIoZGlyKSkpIHsKCQlpZiAoaXNfZG90X29yX2RvdGRvdChlLT5kX25hbWUpKQoJCQljb250aW51ZTsKCQl0aGVuID0gcmVyZXJlX2NyZWF0ZWRfYXQoZS0+ZF9uYW1lKTsKCQlpZiAoIXRoZW4pCgkJCWNvbnRpbnVlOwoJCWN1dG9mZiA9IChoYXNfcmVyZXJlX3Jlc29sdXRpb24oZS0+ZF9uYW1lKQoJCQkgID8gY3V0b2ZmX3Jlc29sdmUgOiBjdXRvZmZfbm9yZXNvbHZlKTsKCQlpZiAodGhlbiA8IG5vdyAtIGN1dG9mZiAqIDg2NDAwKQoJCQlzdHJpbmdfbGlzdF9hcHBlbmQoZS0+ZF9uYW1lLCAmdG9fcmVtb3ZlKTsKCX0KCWZvciAoaSA9IDA7IGkgPCB0b19yZW1vdmUubnI7IGkrKykKCQl1bmxpbmtfcnJfaXRlbSh0b19yZW1vdmUuaXRlbXNbaV0uc3RyaW5nKTsKCXN0cmluZ19saXN0X2NsZWFyKCZ0b19yZW1vdmUsIDApOwp9CgpzdGF0aWMgaW50IG91dGYodm9pZCAqZHVtbXksIG1tYnVmZmVyX3QgKnB0ciwgaW50IG5idWYpCnsKCWludCBpOwoJZm9yIChpID0gMDsgaSA8IG5idWY7IGkrKykKCQlpZiAod3JpdGVfaW5fZnVsbCgxLCBwdHJbaV0ucHRyLCBwdHJbaV0uc2l6ZSkgIT0gcHRyW2ldLnNpemUpCgkJCXJldHVybiAtMTsKCXJldHVybiAwOwp9CgpzdGF0aWMgaW50IGRpZmZfdHdvKGNvbnN0IGNoYXIgKmZpbGUxLCBjb25zdCBjaGFyICpsYWJlbDEsCgkJY29uc3QgY2hhciAqZmlsZTIsIGNvbnN0IGNoYXIgKmxhYmVsMikKewoJeHBwYXJhbV90IHhwcDsKCXhkZW1pdGNvbmZfdCB4ZWNmZzsKCXhkZW1pdGNiX3QgZWNiOwoJbW1maWxlX3QgbWludXMsIHBsdXM7CgoJaWYgKHJlYWRfbW1maWxlKCZtaW51cywgZmlsZTEpIHx8IHJlYWRfbW1maWxlKCZwbHVzLCBmaWxlMikpCgkJcmV0dXJuIDE7CgoJcHJpbnRmKCItLS0gYS8lc1xuKysrIGIvJXNcbiIsIGxhYmVsMSwgbGFiZWwyKTsKCWZmbHVzaChzdGRvdXQpOwoJbWVtc2V0KCZ4cHAsIDAsIHNpemVvZih4cHApKTsKCXhwcC5mbGFncyA9IDA7CgltZW1zZXQoJnhlY2ZnLCAwLCBzaXplb2YoeGVjZmcpKTsKCXhlY2ZnLmN0eGxlbiA9IDM7CgllY2Iub3V0ZiA9IG91dGY7Cgl4ZGlfZGlmZigmbWludXMsICZwbHVzLCAmeHBwLCAmeGVjZmcsICZlY2IpOwoKCWZyZWUobWludXMucHRyKTsKCWZyZWUocGx1cy5wdHIpOwoJcmV0dXJuIDA7Cn0KCmludCBjbWRfcmVyZXJlKGludCBhcmdjLCBjb25zdCBjaGFyICoqYXJndiwgY29uc3QgY2hhciAqcHJlZml4KQp7CglzdHJ1Y3Qgc3RyaW5nX2xpc3QgbWVyZ2VfcnIgPSB7IE5VTEwsIDAsIDAsIDEgfTsKCWludCBpLCBmZCwgZmxhZ3MgPSAwOwoKCWlmICgyIDwgYXJnYykgewoJCWlmICghc3RyY21wKGFyZ3ZbMV0sICItaCIpKQoJCQl1c2FnZShnaXRfcmVyZXJlX3VzYWdlKTsKCQlpZiAoIXN0cmNtcChhcmd2WzFdLCAiLS1yZXJlcmUtYXV0b3VwZGF0ZSIpKQoJCQlmbGFncyA9IFJFUkVSRV9BVVRPVVBEQVRFOwoJCWVsc2UgaWYgKCFzdHJjbXAoYXJndlsxXSwgIi0tbm8tcmVyZXJlLWF1dG91cGRhdGUiKSkKCQkJZmxhZ3MgPSBSRVJFUkVfTk9BVVRPVVBEQVRFOwoJCWlmIChmbGFncykgewoJCQlhcmdjLS07CgkJCWFyZ3YrKzsKCQl9Cgl9CglpZiAoYXJnYyA8IDIpCgkJcmV0dXJuIHJlcmVyZShmbGFncyk7CgoJaWYgKCFzdHJjbXAoYXJndlsxXSwgImZvcmdldCIpKSB7CgkJY29uc3QgY2hhciAqKnBhdGhzcGVjID0gZ2V0X3BhdGhzcGVjKHByZWZpeCwgYXJndiArIDIpOwoJCXJldHVybiByZXJlcmVfZm9yZ2V0KHBhdGhzcGVjKTsKCX0KCglmZCA9IHNldHVwX3JlcmVyZSgmbWVyZ2VfcnIsIGZsYWdzKTsKCWlmIChmZCA8IDApCgkJcmV0dXJuIDA7CgoJaWYgKCFzdHJjbXAoYXJndlsxXSwgImNsZWFyIikpIHsKCQlmb3IgKGkgPSAwOyBpIDwgbWVyZ2VfcnIubnI7IGkrKykgewoJCQljb25zdCBjaGFyICpuYW1lID0gKGNvbnN0IGNoYXIgKiltZXJnZV9yci5pdGVtc1tpXS51dGlsOwoJCQlpZiAoIWhhc19yZXJlcmVfcmVzb2x1dGlvbihuYW1lKSkKCQkJCXVubGlua19ycl9pdGVtKG5hbWUpOwoJCX0KCQl1bmxpbmtfb3Jfd2FybihnaXRfcGF0aCgicnItY2FjaGUvTUVSR0VfUlIiKSk7Cgl9IGVsc2UgaWYgKCFzdHJjbXAoYXJndlsxXSwgImdjIikpCgkJZ2FyYmFnZV9jb2xsZWN0KCZtZXJnZV9ycik7CgllbHNlIGlmICghc3RyY21wKGFyZ3ZbMV0sICJzdGF0dXMiKSkKCQlmb3IgKGkgPSAwOyBpIDwgbWVyZ2VfcnIubnI7IGkrKykKCQkJcHJpbnRmKCIlc1xuIiwgbWVyZ2VfcnIuaXRlbXNbaV0uc3RyaW5nKTsKCWVsc2UgaWYgKCFzdHJjbXAoYXJndlsxXSwgImRpZmYiKSkKCQlmb3IgKGkgPSAwOyBpIDwgbWVyZ2VfcnIubnI7IGkrKykgewoJCQljb25zdCBjaGFyICpwYXRoID0gbWVyZ2VfcnIuaXRlbXNbaV0uc3RyaW5nOwoJCQljb25zdCBjaGFyICpuYW1lID0gKGNvbnN0IGNoYXIgKiltZXJnZV9yci5pdGVtc1tpXS51dGlsOwoJCQlkaWZmX3R3byhyZXJlcmVfcGF0aChuYW1lLCAicHJlaW1hZ2UiKSwgcGF0aCwgcGF0aCwgcGF0aCk7CgkJfQoJZWxzZQoJCXVzYWdlKGdpdF9yZXJlcmVfdXNhZ2UpOwoKCXN0cmluZ19saXN0X2NsZWFyKCZtZXJnZV9yciwgMSk7CglyZXR1cm4gMDsKfQo=",
    "text": "#include \"builtin.h\"\n#include \"cache.h\"\n#include \"dir.h\"\n#include \"string-list.h\"\n#include \"rerere.h\"\n#include \"xdiff/xdiff.h\"\n#include \"xdiff-interface.h\"\n\nstatic const char git_rerere_usage[] =\n\"git rerere [clear | status | diff | gc]\";\n\n/* these values are days */\nstatic int cutoff_noresolve = 15;\nstatic int cutoff_resolve = 60;\n\nstatic time_t rerere_created_at(const char *name)\n{\n\tstruct stat st;\n\treturn stat(rerere_path(name, \"preimage\"), &st) ? (time_t) 0 : st.st_mtime;\n}\n\nstatic void unlink_rr_item(const char *name)\n{\n\tunlink(rerere_path(name, \"thisimage\"));\n\tunlink(rerere_path(name, \"preimage\"));\n\tunlink(rerere_path(name, \"postimage\"));\n\trmdir(git_path(\"rr-cache/%s\", name));\n}\n\nstatic int git_rerere_gc_config(const char *var, const char *value, void *cb)\n{\n\tif (!strcmp(var, \"gc.rerereresolved\"))\n\t\tcutoff_resolve = git_config_int(var, value);\n\telse if (!strcmp(var, \"gc.rerereunresolved\"))\n\t\tcutoff_noresolve = git_config_int(var, value);\n\telse\n\t\treturn git_default_config(var, value, cb);\n\treturn 0;\n}\n\nstatic void garbage_collect(struct string_list *rr)\n{\n\tstruct string_list to_remove = { NULL, 0, 0, 1 };\n\tDIR *dir;\n\tstruct dirent *e;\n\tint i, cutoff;\n\ttime_t now = time(NULL), then;\n\n\tgit_config(git_rerere_gc_config, NULL);\n\tdir = opendir(git_path(\"rr-cache\"));\n\tif (!dir)\n\t\tdie_errno(\"unable to open rr-cache directory\");\n\twhile ((e = readdir(dir))) {\n\t\tif (is_dot_or_dotdot(e->d_name))\n\t\t\tcontinue;\n\t\tthen = rerere_created_at(e->d_name);\n\t\tif (!then)\n\t\t\tcontinue;\n\t\tcutoff = (has_rerere_resolution(e->d_name)\n\t\t\t  ? cutoff_resolve : cutoff_noresolve);\n\t\tif (then < now - cutoff * 86400)\n\t\t\tstring_list_append(e->d_name, &to_remove);\n\t}\n\tfor (i = 0; i < to_remove.nr; i++)\n\t\tunlink_rr_item(to_remove.items[i].string);\n\tstring_list_clear(&to_remove, 0);\n}\n\nstatic int outf(void *dummy, mmbuffer_t *ptr, int nbuf)\n{\n\tint i;\n\tfor (i = 0; i < nbuf; i++)\n\t\tif (write_in_full(1, ptr[i].ptr, ptr[i].size) != ptr[i].size)\n\t\t\treturn -1;\n\treturn 0;\n}\n\nstatic int diff_two(const char *file1, const char *label1,\n\t\tconst char *file2, const char *label2)\n{\n\txpparam_t xpp;\n\txdemitconf_t xecfg;\n\txdemitcb_t ecb;\n\tmmfile_t minus, plus;\n\n\tif (read_mmfile(&minus, file1) || read_mmfile(&plus, file2))\n\t\treturn 1;\n\n\tprintf(\"--- a/%s\\n+++ b/%s\\n\", label1, label2);\n\tfflush(stdout);\n\tmemset(&xpp, 0, sizeof(xpp));\n\txpp.flags = 0;\n\tmemset(&xecfg, 0, sizeof(xecfg));\n\txecfg.ctxlen = 3;\n\tecb.outf = outf;\n\txdi_diff(&minus, &plus, &xpp, &xecfg, &ecb);\n\n\tfree(minus.ptr);\n\tfree(plus.ptr);\n\treturn 0;\n}\n\nint cmd_rerere(int argc, const char **argv, const char *prefix)\n{\n\tstruct string_list merge_rr = { NULL, 0, 0, 1 };\n\tint i, fd, flags = 0;\n\n\tif (2 < argc) {\n\t\tif (!strcmp(argv[1], \"-h\"))\n\t\t\tusage(git_rerere_usage);\n\t\tif (!strcmp(argv[1], \"--rerere-autoupdate\"))\n\t\t\tflags = RERERE_AUTOUPDATE;\n\t\telse if (!strcmp(argv[1], \"--no-rerere-autoupdate\"))\n\t\t\tflags = RERERE_NOAUTOUPDATE;\n\t\tif (flags) {\n\t\t\targc--;\n\t\t\targv++;\n\t\t}\n\t}\n\tif (argc < 2)\n\t\treturn rerere(flags);\n\n\tif (!strcmp(argv[1], \"forget\")) {\n\t\tconst char **pathspec = get_pathspec(prefix, argv + 2);\n\t\treturn rerere_forget(pathspec);\n\t}\n\n\tfd = setup_rerere(&merge_rr, flags);\n\tif (fd < 0)\n\t\treturn 0;\n\n\tif (!strcmp(argv[1], \"clear\")) {\n\t\tfor (i = 0; i < merge_rr.nr; i++) {\n\t\t\tconst char *name = (const char *)merge_rr.items[i].util;\n\t\t\tif (!has_rerere_resolution(name))\n\t\t\t\tunlink_rr_item(name);\n\t\t}\n\t\tunlink_or_warn(git_path(\"rr-cache/MERGE_RR\"));\n\t} else if (!strcmp(argv[1], \"gc\"))\n\t\tgarbage_collect(&merge_rr);\n\telse if (!strcmp(argv[1], \"status\"))\n\t\tfor (i = 0; i < merge_rr.nr; i++)\n\t\t\tprintf(\"%s\\n\", merge_rr.items[i].string);\n\telse if (!strcmp(argv[1], \"diff\"))\n\t\tfor (i = 0; i < merge_rr.nr; i++) {\n\t\t\tconst char *path = merge_rr.items[i].string;\n\t\t\tconst char *name = (const char *)merge_rr.items[i].util;\n\t\t\tdiff_two(rerere_path(name, \"preimage\"), path, path, path);\n\t\t}\n\telse\n\t\tusage(git_rerere_usage);\n\n\tstring_list_clear(&merge_rr, 1);\n\treturn 0;\n}\n",
    "type": "blob"
  },
  "kind": "blob",
  "oid": "0048f9ef7fee24e5e058ef226f3b0fc93703fcf1",
  "sha1_ok": true,
  "size": 3923
}
