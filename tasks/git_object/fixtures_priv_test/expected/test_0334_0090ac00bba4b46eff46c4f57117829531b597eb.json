{
  "content": {
    "base64": "LyoKICogQ29weXJpZ2h0IChjKSAyMDA1IEp1bmlvIEMgSGFtYW5vCiAqLwoKI2luY2x1ZGUgImNhY2hlLmgiCiNpbmNsdWRlICJkaWZmLmgiCgpzdGF0aWMgaW50IGRpZmZfb3V0cHV0X2Zvcm1hdCA9IERJRkZfRk9STUFUX0hVTUFOOwpzdGF0aWMgaW50IGRldGVjdF9yZW5hbWUgPSAwOwpzdGF0aWMgaW50IGRpZmZfc2V0dXBfb3B0ID0gMDsKc3RhdGljIGludCBkaWZmX3Njb3JlX29wdCA9IDA7CnN0YXRpYyBjb25zdCBjaGFyICpwaWNrYXhlID0gTlVMTDsKc3RhdGljIGludCBwaWNrYXhlX29wdHMgPSAwOwpzdGF0aWMgaW50IGRpZmZfYnJlYWtfb3B0ID0gLTE7CnN0YXRpYyBjb25zdCBjaGFyICpvcmRlcmZpbGUgPSBOVUxMOwoKc3RhdGljIGNoYXIgKmRpZmZfc3RhZ2VzX3VzYWdlID0KImdpdC1kaWZmLXN0YWdlcyBbLXBdIFstcl0gWy16XSBbLU1dIFstQ10gWy1SXSBbLVM8c3RyaW5nPl0gWy1PPG9yZGVyZmlsZT5dIDxzdGFnZTE+IDxzdGFnZTI+IFs8cGF0aD4uLi5dIjsKCmludCBtYWluKGludCBhYywgY29uc3QgY2hhciAqKmF2KQp7CglpbnQgc3RhZ2UxLCBzdGFnZTIsIGk7CgoJcmVhZF9jYWNoZSgpOwoJd2hpbGUgKDEgPCBhYyAmJiBhdlsxXVswXSA9PSAnLScpIHsKCQljb25zdCBjaGFyICphcmcgPSBhdlsxXTsKCQlpZiAoIXN0cmNtcChhcmcsICItciIpKQoJCQk7IC8qIGFzIHVzdWFsICovCgkJZWxzZSBpZiAoIXN0cmNtcChhcmcsICItcCIpKQoJCQlkaWZmX291dHB1dF9mb3JtYXQgPSBESUZGX0ZPUk1BVF9QQVRDSDsKCQllbHNlIGlmICghc3RybmNtcChhcmcsICItQiIsIDIpKSB7CgkJCWlmICgoZGlmZl9icmVha19vcHQgPSBkaWZmX3Njb3Jlb3B0X3BhcnNlKGFyZykpID09IC0xKQoJCQkJdXNhZ2UoZGlmZl9zdGFnZXNfdXNhZ2UpOwoJCX0KCQllbHNlIGlmICghc3RybmNtcChhcmcsICItTSIsIDIpKSB7CgkJCWRldGVjdF9yZW5hbWUgPSBESUZGX0RFVEVDVF9SRU5BTUU7CgkJCWlmICgoZGlmZl9zY29yZV9vcHQgPSBkaWZmX3Njb3Jlb3B0X3BhcnNlKGFyZykpID09IC0xKQoJCQkJdXNhZ2UoZGlmZl9zdGFnZXNfdXNhZ2UpOwoJCX0KCQllbHNlIGlmICghc3RybmNtcChhcmcsICItQyIsIDIpKSB7CgkJCWRldGVjdF9yZW5hbWUgPSBESUZGX0RFVEVDVF9DT1BZOwoJCQlpZiAoKGRpZmZfc2NvcmVfb3B0ID0gZGlmZl9zY29yZW9wdF9wYXJzZShhcmcpKSA9PSAtMSkKCQkJCXVzYWdlKGRpZmZfc3RhZ2VzX3VzYWdlKTsKCQl9CgkJZWxzZSBpZiAoIXN0cmNtcChhcmcsICIteiIpKQoJCQlkaWZmX291dHB1dF9mb3JtYXQgPSBESUZGX0ZPUk1BVF9NQUNISU5FOwoJCWVsc2UgaWYgKCFzdHJjbXAoYXJnLCAiLVIiKSkKCQkJZGlmZl9zZXR1cF9vcHQgfD0gRElGRl9TRVRVUF9SRVZFUlNFOwoJCWVsc2UgaWYgKCFzdHJuY21wKGFyZywgIi1TIiwgMikpCgkJCXBpY2theGUgPSBhcmcgKyAyOwoJCWVsc2UgaWYgKCFzdHJuY21wKGFyZywgIi1PIiwgMikpCgkJCW9yZGVyZmlsZSA9IGFyZyArIDI7CgkJZWxzZSBpZiAoIXN0cmNtcChhcmcsICItLXBpY2theGUtYWxsIikpCgkJCXBpY2theGVfb3B0cyA9IERJRkZfUElDS0FYRV9BTEw7CgkJZWxzZQoJCQl1c2FnZShkaWZmX3N0YWdlc191c2FnZSk7CgkJYWMtLTsgYXYrKzsKCX0KCglpZiAoYWMgPCAzIHx8CgkgICAgc3NjYW5mKGF2WzFdLCAiJWQiLCAmc3RhZ2UxKSAhPSAxIHx8CgkgICAgISAoMCA8PSBzdGFnZTEgJiYgc3RhZ2UxIDw9IDMpIHx8CgkgICAgc3NjYW5mKGF2WzJdLCAiJWQiLCAmc3RhZ2UyKSAhPSAxIHx8CgkgICAgISAoMCA8PSBzdGFnZTIgJiYgc3RhZ2UyIDw9IDMpKQoJCXVzYWdlKGRpZmZfc3RhZ2VzX3VzYWdlKTsKCglhdiArPSAzOyAvKiBUaGUgcmVzdCBmcm9tIGF2WzBdIGFyZSBmb3IgcGF0aHMgcmVzdHJpY3Rpb24uICovCglkaWZmX3NldHVwKGRpZmZfc2V0dXBfb3B0KTsKCglpID0gMDsKCXdoaWxlIChpIDwgYWN0aXZlX25yKSB7CgkJc3RydWN0IGNhY2hlX2VudHJ5ICpjZSwgKnN0YWdlc1s0XSA9IHsgTlVMTCwgfTsKCQlzdHJ1Y3QgY2FjaGVfZW50cnkgKm9uZSwgKnR3bzsKCQljb25zdCBjaGFyICpuYW1lOwoJCWludCBsZW47CgkJY2UgPSBhY3RpdmVfY2FjaGVbaV07CgkJbGVuID0gY2VfbmFtZWxlbihjZSk7CgkJbmFtZSA9IGNlLT5uYW1lOwoJCWZvciAoOzspIHsKCQkJaW50IHN0YWdlID0gY2Vfc3RhZ2UoY2UpOwoJCQlzdGFnZXNbc3RhZ2VdID0gY2U7CgkJCWlmIChhY3RpdmVfbnIgPD0gKytpKQoJCQkJYnJlYWs7CgkJCWNlID0gYWN0aXZlX2NhY2hlW2ldOwoJCQlpZiAoY2VfbmFtZWxlbihjZSkgIT0gbGVuIHx8CgkJCSAgICBtZW1jbXAobmFtZSwgY2UtPm5hbWUsIGxlbikpCgkJCQlicmVhazsKCQl9CgkJb25lID0gc3RhZ2VzW3N0YWdlMV07CgkJdHdvID0gc3RhZ2VzW3N0YWdlMl07CgkJaWYgKCFvbmUgJiYgIXR3bykKCQkJY29udGludWU7CgkJaWYgKCFvbmUpCgkJCWRpZmZfYWRkcmVtb3ZlKCcrJywgbnRvaGwodHdvLT5jZV9tb2RlKSwKCQkJCSAgICAgICB0d28tPnNoYTEsIG5hbWUsIE5VTEwpOwoJCWVsc2UgaWYgKCF0d28pCgkJCWRpZmZfYWRkcmVtb3ZlKCctJywgbnRvaGwob25lLT5jZV9tb2RlKSwKCQkJCSAgICAgICBvbmUtPnNoYTEsIG5hbWUsIE5VTEwpOwoJCWVsc2UgaWYgKG1lbWNtcChvbmUtPnNoYTEsIHR3by0+c2hhMSwgMjApIHx8CgkJCSAob25lLT5jZV9tb2RlICE9IHR3by0+Y2VfbW9kZSkpCgkJCSBkaWZmX2NoYW5nZShudG9obChvbmUtPmNlX21vZGUpLCBudG9obCh0d28tPmNlX21vZGUpLAoJCQkJICAgICBvbmUtPnNoYTEsIHR3by0+c2hhMSwgbmFtZSwgTlVMTCk7Cgl9CgoJZGlmZmNvcmVfc3RkKGF2LAoJCSAgICAgZGV0ZWN0X3JlbmFtZSwgZGlmZl9zY29yZV9vcHQsCgkJICAgICBwaWNrYXhlLCBwaWNrYXhlX29wdHMsCgkJICAgICBkaWZmX2JyZWFrX29wdCwKCQkgICAgIG9yZGVyZmlsZSk7CglkaWZmX2ZsdXNoKGRpZmZfb3V0cHV0X2Zvcm1hdCwgMSk7CglyZXR1cm4gMDsKfQo=",
    "text": "/*\n * Copyright (c) 2005 Junio C Hamano\n */\n\n#include \"cache.h\"\n#include \"diff.h\"\n\nstatic int diff_output_format = DIFF_FORMAT_HUMAN;\nstatic int detect_rename = 0;\nstatic int diff_setup_opt = 0;\nstatic int diff_score_opt = 0;\nstatic const char *pickaxe = NULL;\nstatic int pickaxe_opts = 0;\nstatic int diff_break_opt = -1;\nstatic const char *orderfile = NULL;\n\nstatic char *diff_stages_usage =\n\"git-diff-stages [-p] [-r] [-z] [-M] [-C] [-R] [-S<string>] [-O<orderfile>] <stage1> <stage2> [<path>...]\";\n\nint main(int ac, const char **av)\n{\n\tint stage1, stage2, i;\n\n\tread_cache();\n\twhile (1 < ac && av[1][0] == '-') {\n\t\tconst char *arg = av[1];\n\t\tif (!strcmp(arg, \"-r\"))\n\t\t\t; /* as usual */\n\t\telse if (!strcmp(arg, \"-p\"))\n\t\t\tdiff_output_format = DIFF_FORMAT_PATCH;\n\t\telse if (!strncmp(arg, \"-B\", 2)) {\n\t\t\tif ((diff_break_opt = diff_scoreopt_parse(arg)) == -1)\n\t\t\t\tusage(diff_stages_usage);\n\t\t}\n\t\telse if (!strncmp(arg, \"-M\", 2)) {\n\t\t\tdetect_rename = DIFF_DETECT_RENAME;\n\t\t\tif ((diff_score_opt = diff_scoreopt_parse(arg)) == -1)\n\t\t\t\tusage(diff_stages_usage);\n\t\t}\n\t\telse if (!strncmp(arg, \"-C\", 2)) {\n\t\t\tdetect_rename = DIFF_DETECT_COPY;\n\t\t\tif ((diff_score_opt = diff_scoreopt_parse(arg)) == -1)\n\t\t\t\tusage(diff_stages_usage);\n\t\t}\n\t\telse if (!strcmp(arg, \"-z\"))\n\t\t\tdiff_output_format = DIFF_FORMAT_MACHINE;\n\t\telse if (!strcmp(arg, \"-R\"))\n\t\t\tdiff_setup_opt |= DIFF_SETUP_REVERSE;\n\t\telse if (!strncmp(arg, \"-S\", 2))\n\t\t\tpickaxe = arg + 2;\n\t\telse if (!strncmp(arg, \"-O\", 2))\n\t\t\torderfile = arg + 2;\n\t\telse if (!strcmp(arg, \"--pickaxe-all\"))\n\t\t\tpickaxe_opts = DIFF_PICKAXE_ALL;\n\t\telse\n\t\t\tusage(diff_stages_usage);\n\t\tac--; av++;\n\t}\n\n\tif (ac < 3 ||\n\t    sscanf(av[1], \"%d\", &stage1) != 1 ||\n\t    ! (0 <= stage1 && stage1 <= 3) ||\n\t    sscanf(av[2], \"%d\", &stage2) != 1 ||\n\t    ! (0 <= stage2 && stage2 <= 3))\n\t\tusage(diff_stages_usage);\n\n\tav += 3; /* The rest from av[0] are for paths restriction. */\n\tdiff_setup(diff_setup_opt);\n\n\ti = 0;\n\twhile (i < active_nr) {\n\t\tstruct cache_entry *ce, *stages[4] = { NULL, };\n\t\tstruct cache_entry *one, *two;\n\t\tconst char *name;\n\t\tint len;\n\t\tce = active_cache[i];\n\t\tlen = ce_namelen(ce);\n\t\tname = ce->name;\n\t\tfor (;;) {\n\t\t\tint stage = ce_stage(ce);\n\t\t\tstages[stage] = ce;\n\t\t\tif (active_nr <= ++i)\n\t\t\t\tbreak;\n\t\t\tce = active_cache[i];\n\t\t\tif (ce_namelen(ce) != len ||\n\t\t\t    memcmp(name, ce->name, len))\n\t\t\t\tbreak;\n\t\t}\n\t\tone = stages[stage1];\n\t\ttwo = stages[stage2];\n\t\tif (!one && !two)\n\t\t\tcontinue;\n\t\tif (!one)\n\t\t\tdiff_addremove('+', ntohl(two->ce_mode),\n\t\t\t\t       two->sha1, name, NULL);\n\t\telse if (!two)\n\t\t\tdiff_addremove('-', ntohl(one->ce_mode),\n\t\t\t\t       one->sha1, name, NULL);\n\t\telse if (memcmp(one->sha1, two->sha1, 20) ||\n\t\t\t (one->ce_mode != two->ce_mode))\n\t\t\t diff_change(ntohl(one->ce_mode), ntohl(two->ce_mode),\n\t\t\t\t     one->sha1, two->sha1, name, NULL);\n\t}\n\n\tdiffcore_std(av,\n\t\t     detect_rename, diff_score_opt,\n\t\t     pickaxe, pickaxe_opts,\n\t\t     diff_break_opt,\n\t\t     orderfile);\n\tdiff_flush(diff_output_format, 1);\n\treturn 0;\n}\n",
    "type": "blob"
  },
  "kind": "blob",
  "oid": "0090ac00bba4b46eff46c4f57117829531b597eb",
  "sha1_ok": true,
  "size": 2975
}
