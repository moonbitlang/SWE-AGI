{
  "content": {
    "base64": "I2luY2x1ZGUgImNhY2hlLmgiCiNpbmNsdWRlICJjb25maWcuaCIKI2luY2x1ZGUgInJlcG9zaXRvcnkuaCIKI2luY2x1ZGUgIm1pZHguaCIKCnN0YXRpYyB2b2lkIHJlcG9fY2ZnX2Jvb2woc3RydWN0IHJlcG9zaXRvcnkgKnIsIGNvbnN0IGNoYXIgKmtleSwgaW50ICpkZXN0LAoJCQkgIGludCBkZWYpCnsKCWlmIChyZXBvX2NvbmZpZ19nZXRfYm9vbChyLCBrZXksIGRlc3QpKQoJCSpkZXN0ID0gZGVmOwp9Cgp2b2lkIHByZXBhcmVfcmVwb19zZXR0aW5ncyhzdHJ1Y3QgcmVwb3NpdG9yeSAqcikKewoJaW50IGV4cGVyaW1lbnRhbDsKCWludCB2YWx1ZTsKCWNoYXIgKnN0cnZhbDsKCWludCBtYW55ZmlsZXM7CgoJaWYgKCFyLT5naXRkaXIpCgkJQlVHKCJDYW5ub3QgYWRkIHNldHRpbmdzIGZvciB1bmluaXRpYWxpemVkIHJlcG9zaXRvcnkiKTsKCglpZiAoci0+c2V0dGluZ3MuaW5pdGlhbGl6ZWQrKykKCQlyZXR1cm47CgoJLyogRGVmYXVsdHMgKi8KCXItPnNldHRpbmdzLmluZGV4X3ZlcnNpb24gPSAtMTsKCXItPnNldHRpbmdzLmNvcmVfdW50cmFja2VkX2NhY2hlID0gVU5UUkFDS0VEX0NBQ0hFX0tFRVA7CglyLT5zZXR0aW5ncy5mZXRjaF9uZWdvdGlhdGlvbl9hbGdvcml0aG0gPSBGRVRDSF9ORUdPVElBVElPTl9ERUZBVUxUOwoKCS8qIEJvb2xlYW5zIGNvbmZpZyBvciBkZWZhdWx0LCBjYXNjYWRlcyB0byBvdGhlciBzZXR0aW5ncyAqLwoJcmVwb19jZmdfYm9vbChyLCAiZmVhdHVyZS5tYW55ZmlsZXMiLCAmbWFueWZpbGVzLCAwKTsKCXJlcG9fY2ZnX2Jvb2wociwgImZlYXR1cmUuZXhwZXJpbWVudGFsIiwgJmV4cGVyaW1lbnRhbCwgMCk7CgoJLyogRGVmYXVsdHMgbW9kaWZpZWQgYnkgZmVhdHVyZS4qICovCglpZiAoZXhwZXJpbWVudGFsKSB7CgkJci0+c2V0dGluZ3MuZmV0Y2hfbmVnb3RpYXRpb25fYWxnb3JpdGhtID0gRkVUQ0hfTkVHT1RJQVRJT05fU0tJUFBJTkc7Cgl9CglpZiAobWFueWZpbGVzKSB7CgkJci0+c2V0dGluZ3MuaW5kZXhfdmVyc2lvbiA9IDQ7CgkJci0+c2V0dGluZ3MuY29yZV91bnRyYWNrZWRfY2FjaGUgPSBVTlRSQUNLRURfQ0FDSEVfV1JJVEU7Cgl9CgoJLyogQm9vbGVhbiBjb25maWcgb3IgZGVmYXVsdCwgZG9lcyBub3QgY2FzY2FkZSAoc2ltcGxlKSAgKi8KCXJlcG9fY2ZnX2Jvb2wociwgImNvcmUuY29tbWl0Z3JhcGgiLCAmci0+c2V0dGluZ3MuY29yZV9jb21taXRfZ3JhcGgsIDEpOwoJcmVwb19jZmdfYm9vbChyLCAiY29tbWl0Z3JhcGgucmVhZGNoYW5nZWRwYXRocyIsICZyLT5zZXR0aW5ncy5jb21taXRfZ3JhcGhfcmVhZF9jaGFuZ2VkX3BhdGhzLCAxKTsKCXJlcG9fY2ZnX2Jvb2wociwgImdjLndyaXRlY29tbWl0Z3JhcGgiLCAmci0+c2V0dGluZ3MuZ2Nfd3JpdGVfY29tbWl0X2dyYXBoLCAxKTsKCXJlcG9fY2ZnX2Jvb2wociwgImZldGNoLndyaXRlY29tbWl0Z3JhcGgiLCAmci0+c2V0dGluZ3MuZmV0Y2hfd3JpdGVfY29tbWl0X2dyYXBoLCAwKTsKCXJlcG9fY2ZnX2Jvb2wociwgInBhY2sudXNlc3BhcnNlIiwgJnItPnNldHRpbmdzLnBhY2tfdXNlX3NwYXJzZSwgMSk7CglyZXBvX2NmZ19ib29sKHIsICJjb3JlLm11bHRpcGFja2luZGV4IiwgJnItPnNldHRpbmdzLmNvcmVfbXVsdGlfcGFja19pbmRleCwgMSk7CglyZXBvX2NmZ19ib29sKHIsICJpbmRleC5zcGFyc2UiLCAmci0+c2V0dGluZ3Muc3BhcnNlX2luZGV4LCAwKTsKCgkvKgoJICogVGhlIEdJVF9URVNUX01VTFRJX1BBQ0tfSU5ERVggdmFyaWFibGUgaXMgc3BlY2lhbCBpbiB0aGF0CgkgKiBlaXRoZXIgaXQgKm9yKiB0aGUgY29uZmlnIHNldHMKCSAqIHItPnNldHRpbmdzLmNvcmVfbXVsdGlfcGFja19pbmRleCBpZiB0cnVlLiBXZSBkb24ndCB0YWtlCgkgKiB0aGUgZW52aXJvbm1lbnQgdmFyaWFibGUgaWYgaXQgZXhpc3RzIChldmVuIGlmIGZhbHNlKSBvdmVyCgkgKiBhbnkgY29uZmlnLCBhcyBpbiBtb3N0IG90aGVyIGNhc2VzLgoJICovCglpZiAoZ2l0X2Vudl9ib29sKEdJVF9URVNUX01VTFRJX1BBQ0tfSU5ERVgsIDApKQoJCXItPnNldHRpbmdzLmNvcmVfbXVsdGlfcGFja19pbmRleCA9IDE7CgoJLyoKCSAqIE5vbi1ib29sZWFuIGNvbmZpZwoJICovCglpZiAoIXJlcG9fY29uZmlnX2dldF9pbnQociwgImluZGV4LnZlcnNpb24iLCAmdmFsdWUpKQoJCXItPnNldHRpbmdzLmluZGV4X3ZlcnNpb24gPSB2YWx1ZTsKCglpZiAoIXJlcG9fY29uZmlnX2dldF9zdHJpbmcociwgImNvcmUudW50cmFja2VkY2FjaGUiLCAmc3RydmFsKSkgewoJCWludCB2ID0gZ2l0X3BhcnNlX21heWJlX2Jvb2woc3RydmFsKTsKCgkJLyoKCQkgKiBJZiBpdCdzIHNldCB0byAia2VlcCIsIG9yIHNvbWUgb3RoZXIgbm9uLWJvb2xlYW4KCQkgKiB2YWx1ZSB0aGVuICJ2IDwgMCIuIFRoZW4gd2UgZG8gbm90aGluZyBhbmQga2VlcCBpdAoJCSAqIGF0IHRoZSBkZWZhdWx0IG9mIFVOVFJBQ0tFRF9DQUNIRV9LRUVQLgoJCSAqLwoJCWlmICh2ID49IDApCgkJCXItPnNldHRpbmdzLmNvcmVfdW50cmFja2VkX2NhY2hlID0gdiA/CgkJCQlVTlRSQUNLRURfQ0FDSEVfV1JJVEUgOiBVTlRSQUNLRURfQ0FDSEVfUkVNT1ZFOwoJCWZyZWUoc3RydmFsKTsKCX0KCglpZiAoIXJlcG9fY29uZmlnX2dldF9zdHJpbmcociwgImZldGNoLm5lZ290aWF0aW9uYWxnb3JpdGhtIiwgJnN0cnZhbCkpIHsKCQlpZiAoIXN0cmNhc2VjbXAoc3RydmFsLCAic2tpcHBpbmciKSkKCQkJci0+c2V0dGluZ3MuZmV0Y2hfbmVnb3RpYXRpb25fYWxnb3JpdGhtID0gRkVUQ0hfTkVHT1RJQVRJT05fU0tJUFBJTkc7CgkJZWxzZSBpZiAoIXN0cmNhc2VjbXAoc3RydmFsLCAibm9vcCIpKQoJCQlyLT5zZXR0aW5ncy5mZXRjaF9uZWdvdGlhdGlvbl9hbGdvcml0aG0gPSBGRVRDSF9ORUdPVElBVElPTl9OT09QOwoJfQoKCS8qCgkgKiBUaGlzIHNldHRpbmcgZ3VhcmRzIGFsbCBpbmRleCByZWFkcyB0byByZXF1aXJlIGEgZnVsbCBpbmRleAoJICogb3ZlciBhIHNwYXJzZSBpbmRleC4gQWZ0ZXIgc3VpdGFibGUgZ3VhcmRzIGFyZSBwbGFjZWQgaW4gdGhlCgkgKiBjb2RlYmFzZSBhcm91bmQgdXNlcyBvZiB0aGUgaW5kZXgsIHRoaXMgc2V0dGluZyB3aWxsIGJlCgkgKiByZW1vdmVkLgoJICovCglyLT5zZXR0aW5ncy5jb21tYW5kX3JlcXVpcmVzX2Z1bGxfaW5kZXggPSAxOwp9Cg==",
    "text": "#include \"cache.h\"\n#include \"config.h\"\n#include \"repository.h\"\n#include \"midx.h\"\n\nstatic void repo_cfg_bool(struct repository *r, const char *key, int *dest,\n\t\t\t  int def)\n{\n\tif (repo_config_get_bool(r, key, dest))\n\t\t*dest = def;\n}\n\nvoid prepare_repo_settings(struct repository *r)\n{\n\tint experimental;\n\tint value;\n\tchar *strval;\n\tint manyfiles;\n\n\tif (!r->gitdir)\n\t\tBUG(\"Cannot add settings for uninitialized repository\");\n\n\tif (r->settings.initialized++)\n\t\treturn;\n\n\t/* Defaults */\n\tr->settings.index_version = -1;\n\tr->settings.core_untracked_cache = UNTRACKED_CACHE_KEEP;\n\tr->settings.fetch_negotiation_algorithm = FETCH_NEGOTIATION_DEFAULT;\n\n\t/* Booleans config or default, cascades to other settings */\n\trepo_cfg_bool(r, \"feature.manyfiles\", &manyfiles, 0);\n\trepo_cfg_bool(r, \"feature.experimental\", &experimental, 0);\n\n\t/* Defaults modified by feature.* */\n\tif (experimental) {\n\t\tr->settings.fetch_negotiation_algorithm = FETCH_NEGOTIATION_SKIPPING;\n\t}\n\tif (manyfiles) {\n\t\tr->settings.index_version = 4;\n\t\tr->settings.core_untracked_cache = UNTRACKED_CACHE_WRITE;\n\t}\n\n\t/* Boolean config or default, does not cascade (simple)  */\n\trepo_cfg_bool(r, \"core.commitgraph\", &r->settings.core_commit_graph, 1);\n\trepo_cfg_bool(r, \"commitgraph.readchangedpaths\", &r->settings.commit_graph_read_changed_paths, 1);\n\trepo_cfg_bool(r, \"gc.writecommitgraph\", &r->settings.gc_write_commit_graph, 1);\n\trepo_cfg_bool(r, \"fetch.writecommitgraph\", &r->settings.fetch_write_commit_graph, 0);\n\trepo_cfg_bool(r, \"pack.usesparse\", &r->settings.pack_use_sparse, 1);\n\trepo_cfg_bool(r, \"core.multipackindex\", &r->settings.core_multi_pack_index, 1);\n\trepo_cfg_bool(r, \"index.sparse\", &r->settings.sparse_index, 0);\n\n\t/*\n\t * The GIT_TEST_MULTI_PACK_INDEX variable is special in that\n\t * either it *or* the config sets\n\t * r->settings.core_multi_pack_index if true. We don't take\n\t * the environment variable if it exists (even if false) over\n\t * any config, as in most other cases.\n\t */\n\tif (git_env_bool(GIT_TEST_MULTI_PACK_INDEX, 0))\n\t\tr->settings.core_multi_pack_index = 1;\n\n\t/*\n\t * Non-boolean config\n\t */\n\tif (!repo_config_get_int(r, \"index.version\", &value))\n\t\tr->settings.index_version = value;\n\n\tif (!repo_config_get_string(r, \"core.untrackedcache\", &strval)) {\n\t\tint v = git_parse_maybe_bool(strval);\n\n\t\t/*\n\t\t * If it's set to \"keep\", or some other non-boolean\n\t\t * value then \"v < 0\". Then we do nothing and keep it\n\t\t * at the default of UNTRACKED_CACHE_KEEP.\n\t\t */\n\t\tif (v >= 0)\n\t\t\tr->settings.core_untracked_cache = v ?\n\t\t\t\tUNTRACKED_CACHE_WRITE : UNTRACKED_CACHE_REMOVE;\n\t\tfree(strval);\n\t}\n\n\tif (!repo_config_get_string(r, \"fetch.negotiationalgorithm\", &strval)) {\n\t\tif (!strcasecmp(strval, \"skipping\"))\n\t\t\tr->settings.fetch_negotiation_algorithm = FETCH_NEGOTIATION_SKIPPING;\n\t\telse if (!strcasecmp(strval, \"noop\"))\n\t\t\tr->settings.fetch_negotiation_algorithm = FETCH_NEGOTIATION_NOOP;\n\t}\n\n\t/*\n\t * This setting guards all index reads to require a full index\n\t * over a sparse index. After suitable guards are placed in the\n\t * codebase around uses of the index, this setting will be\n\t * removed.\n\t */\n\tr->settings.command_requires_full_index = 1;\n}\n",
    "type": "blob"
  },
  "kind": "blob",
  "oid": "00ca5571a1ab77e8a1b2d505d59e6ff59d629dd9",
  "sha1_ok": true,
  "size": 3139
}
