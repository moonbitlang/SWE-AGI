{
  "content": {
    "base64": "LyoKQ29weXJpZ2h0IDIwMjAgR29vZ2xlIExMQwoKVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIG9yIGF0Cmh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL29wZW4tc291cmNlL2xpY2Vuc2VzL2JzZAoqLwoKI2luY2x1ZGUgInBxLmgiCgojaW5jbHVkZSAicmVmdGFibGUtcmVjb3JkLmgiCiNpbmNsdWRlICJzeXN0ZW0uaCIKI2luY2x1ZGUgImJhc2ljcy5oIgoKaW50IHBxX2xlc3Moc3RydWN0IHBxX2VudHJ5ICphLCBzdHJ1Y3QgcHFfZW50cnkgKmIpCnsKCWludCBjbXAgPSByZWZ0YWJsZV9yZWNvcmRfY21wKGEtPnJlYywgYi0+cmVjKTsKCWlmIChjbXAgPT0gMCkKCQlyZXR1cm4gYS0+aW5kZXggPiBiLT5pbmRleDsKCXJldHVybiBjbXAgPCAwOwp9CgpzdHJ1Y3QgcHFfZW50cnkgbWVyZ2VkX2l0ZXJfcHF1ZXVlX3RvcChzdHJ1Y3QgbWVyZ2VkX2l0ZXJfcHF1ZXVlIHBxKQp7CglyZXR1cm4gcHEuaGVhcFswXTsKfQoKaW50IG1lcmdlZF9pdGVyX3BxdWV1ZV9pc19lbXB0eShzdHJ1Y3QgbWVyZ2VkX2l0ZXJfcHF1ZXVlIHBxKQp7CglyZXR1cm4gcHEubGVuID09IDA7Cn0KCnN0cnVjdCBwcV9lbnRyeSBtZXJnZWRfaXRlcl9wcXVldWVfcmVtb3ZlKHN0cnVjdCBtZXJnZWRfaXRlcl9wcXVldWUgKnBxKQp7CglpbnQgaSA9IDA7CglzdHJ1Y3QgcHFfZW50cnkgZSA9IHBxLT5oZWFwWzBdOwoJcHEtPmhlYXBbMF0gPSBwcS0+aGVhcFtwcS0+bGVuIC0gMV07CglwcS0+bGVuLS07CgoJaSA9IDA7Cgl3aGlsZSAoaSA8IHBxLT5sZW4pIHsKCQlpbnQgbWluID0gaTsKCQlpbnQgaiA9IDIgKiBpICsgMTsKCQlpbnQgayA9IDIgKiBpICsgMjsKCQlpZiAoaiA8IHBxLT5sZW4gJiYgcHFfbGVzcygmcHEtPmhlYXBbal0sICZwcS0+aGVhcFtpXSkpIHsKCQkJbWluID0gajsKCQl9CgkJaWYgKGsgPCBwcS0+bGVuICYmIHBxX2xlc3MoJnBxLT5oZWFwW2tdLCAmcHEtPmhlYXBbbWluXSkpIHsKCQkJbWluID0gazsKCQl9CgoJCWlmIChtaW4gPT0gaSkgewoJCQlicmVhazsKCQl9CgoJCVNXQVAocHEtPmhlYXBbaV0sIHBxLT5oZWFwW21pbl0pOwoJCWkgPSBtaW47Cgl9CgoJcmV0dXJuIGU7Cn0KCnZvaWQgbWVyZ2VkX2l0ZXJfcHF1ZXVlX2FkZChzdHJ1Y3QgbWVyZ2VkX2l0ZXJfcHF1ZXVlICpwcSwgY29uc3Qgc3RydWN0IHBxX2VudHJ5ICplKQp7CglpbnQgaSA9IDA7CgoJUkVGVEFCTEVfQUxMT0NfR1JPVyhwcS0+aGVhcCwgcHEtPmxlbiArIDEsIHBxLT5jYXApOwoJcHEtPmhlYXBbcHEtPmxlbisrXSA9ICplOwoKCWkgPSBwcS0+bGVuIC0gMTsKCXdoaWxlIChpID4gMCkgewoJCWludCBqID0gKGkgLSAxKSAvIDI7CgkJaWYgKHBxX2xlc3MoJnBxLT5oZWFwW2pdLCAmcHEtPmhlYXBbaV0pKSB7CgkJCWJyZWFrOwoJCX0KCgkJU1dBUChwcS0+aGVhcFtqXSwgcHEtPmhlYXBbaV0pOwoKCQlpID0gajsKCX0KfQoKdm9pZCBtZXJnZWRfaXRlcl9wcXVldWVfcmVsZWFzZShzdHJ1Y3QgbWVyZ2VkX2l0ZXJfcHF1ZXVlICpwcSkKewoJRlJFRV9BTkRfTlVMTChwcS0+aGVhcCk7CgltZW1zZXQocHEsIDAsIHNpemVvZigqcHEpKTsKfQo=",
    "text": "/*\nCopyright 2020 Google LLC\n\nUse of this source code is governed by a BSD-style\nlicense that can be found in the LICENSE file or at\nhttps://developers.google.com/open-source/licenses/bsd\n*/\n\n#include \"pq.h\"\n\n#include \"reftable-record.h\"\n#include \"system.h\"\n#include \"basics.h\"\n\nint pq_less(struct pq_entry *a, struct pq_entry *b)\n{\n\tint cmp = reftable_record_cmp(a->rec, b->rec);\n\tif (cmp == 0)\n\t\treturn a->index > b->index;\n\treturn cmp < 0;\n}\n\nstruct pq_entry merged_iter_pqueue_top(struct merged_iter_pqueue pq)\n{\n\treturn pq.heap[0];\n}\n\nint merged_iter_pqueue_is_empty(struct merged_iter_pqueue pq)\n{\n\treturn pq.len == 0;\n}\n\nstruct pq_entry merged_iter_pqueue_remove(struct merged_iter_pqueue *pq)\n{\n\tint i = 0;\n\tstruct pq_entry e = pq->heap[0];\n\tpq->heap[0] = pq->heap[pq->len - 1];\n\tpq->len--;\n\n\ti = 0;\n\twhile (i < pq->len) {\n\t\tint min = i;\n\t\tint j = 2 * i + 1;\n\t\tint k = 2 * i + 2;\n\t\tif (j < pq->len && pq_less(&pq->heap[j], &pq->heap[i])) {\n\t\t\tmin = j;\n\t\t}\n\t\tif (k < pq->len && pq_less(&pq->heap[k], &pq->heap[min])) {\n\t\t\tmin = k;\n\t\t}\n\n\t\tif (min == i) {\n\t\t\tbreak;\n\t\t}\n\n\t\tSWAP(pq->heap[i], pq->heap[min]);\n\t\ti = min;\n\t}\n\n\treturn e;\n}\n\nvoid merged_iter_pqueue_add(struct merged_iter_pqueue *pq, const struct pq_entry *e)\n{\n\tint i = 0;\n\n\tREFTABLE_ALLOC_GROW(pq->heap, pq->len + 1, pq->cap);\n\tpq->heap[pq->len++] = *e;\n\n\ti = pq->len - 1;\n\twhile (i > 0) {\n\t\tint j = (i - 1) / 2;\n\t\tif (pq_less(&pq->heap[j], &pq->heap[i])) {\n\t\t\tbreak;\n\t\t}\n\n\t\tSWAP(pq->heap[j], pq->heap[i]);\n\n\t\ti = j;\n\t}\n}\n\nvoid merged_iter_pqueue_release(struct merged_iter_pqueue *pq)\n{\n\tFREE_AND_NULL(pq->heap);\n\tmemset(pq, 0, sizeof(*pq));\n}\n",
    "type": "blob"
  },
  "kind": "blob",
  "oid": "0074d6bc43dd2e97065d522a592709cec1e06196",
  "sha1_ok": true,
  "size": 1613
}
