{
  "content": {
    "base64": "I2luY2x1ZGUgInRlc3QtdG9vbC5oIgojaW5jbHVkZSAiY2FjaGUuaCIKI2luY2x1ZGUgIm1pZHguaCIKI2luY2x1ZGUgInJlcG9zaXRvcnkuaCIKI2luY2x1ZGUgIm9iamVjdC1zdG9yZS5oIgojaW5jbHVkZSAicGFjay1iaXRtYXAuaCIKCnN0YXRpYyBpbnQgcmVhZF9taWR4X2ZpbGUoY29uc3QgY2hhciAqb2JqZWN0X2RpciwgaW50IHNob3dfb2JqZWN0cykKewoJdWludDMyX3QgaTsKCXN0cnVjdCBtdWx0aV9wYWNrX2luZGV4ICptOwoKCXNldHVwX2dpdF9kaXJlY3RvcnkoKTsKCW0gPSBsb2FkX211bHRpX3BhY2tfaW5kZXgob2JqZWN0X2RpciwgMSk7CgoJaWYgKCFtKQoJCXJldHVybiAxOwoKCXByaW50ZigiaGVhZGVyOiAlMDh4ICVkICVkICVkICVkXG4iLAoJICAgICAgIG0tPnNpZ25hdHVyZSwKCSAgICAgICBtLT52ZXJzaW9uLAoJICAgICAgIG0tPmhhc2hfbGVuLAoJICAgICAgIG0tPm51bV9jaHVua3MsCgkgICAgICAgbS0+bnVtX3BhY2tzKTsKCglwcmludGYoImNodW5rczoiKTsKCglpZiAobS0+Y2h1bmtfcGFja19uYW1lcykKCQlwcmludGYoIiBwYWNrLW5hbWVzIik7CglpZiAobS0+Y2h1bmtfb2lkX2Zhbm91dCkKCQlwcmludGYoIiBvaWQtZmFub3V0Iik7CglpZiAobS0+Y2h1bmtfb2lkX2xvb2t1cCkKCQlwcmludGYoIiBvaWQtbG9va3VwIik7CglpZiAobS0+Y2h1bmtfb2JqZWN0X29mZnNldHMpCgkJcHJpbnRmKCIgb2JqZWN0LW9mZnNldHMiKTsKCWlmIChtLT5jaHVua19sYXJnZV9vZmZzZXRzKQoJCXByaW50ZigiIGxhcmdlLW9mZnNldHMiKTsKCglwcmludGYoIlxubnVtX29iamVjdHM6ICVkXG4iLCBtLT5udW1fb2JqZWN0cyk7CgoJcHJpbnRmKCJwYWNrczpcbiIpOwoJZm9yIChpID0gMDsgaSA8IG0tPm51bV9wYWNrczsgaSsrKQoJCXByaW50ZigiJXNcbiIsIG0tPnBhY2tfbmFtZXNbaV0pOwoKCXByaW50Zigib2JqZWN0LWRpcjogJXNcbiIsIG0tPm9iamVjdF9kaXIpOwoKCWlmIChzaG93X29iamVjdHMpIHsKCQlzdHJ1Y3Qgb2JqZWN0X2lkIG9pZDsKCQlzdHJ1Y3QgcGFja19lbnRyeSBlOwoKCQlmb3IgKGkgPSAwOyBpIDwgbS0+bnVtX29iamVjdHM7IGkrKykgewoJCQludGhfbWlkeGVkX29iamVjdF9vaWQoJm9pZCwgbSwgaSk7CgkJCWZpbGxfbWlkeF9lbnRyeSh0aGVfcmVwb3NpdG9yeSwgJm9pZCwgJmUsIG0pOwoKCQkJcHJpbnRmKCIlcyAlIlBSSXU2NCJcdCVzXG4iLAoJCQkgICAgICAgb2lkX3RvX2hleCgmb2lkKSwgZS5vZmZzZXQsIGUucC0+cGFja19uYW1lKTsKCQl9CgkJcmV0dXJuIDA7Cgl9CgoJcmV0dXJuIDA7Cn0KCnN0YXRpYyBpbnQgcmVhZF9taWR4X2NoZWNrc3VtKGNvbnN0IGNoYXIgKm9iamVjdF9kaXIpCnsKCXN0cnVjdCBtdWx0aV9wYWNrX2luZGV4ICptOwoKCXNldHVwX2dpdF9kaXJlY3RvcnkoKTsKCW0gPSBsb2FkX211bHRpX3BhY2tfaW5kZXgob2JqZWN0X2RpciwgMSk7CglpZiAoIW0pCgkJcmV0dXJuIDE7CglwcmludGYoIiVzXG4iLCBoYXNoX3RvX2hleChnZXRfbWlkeF9jaGVja3N1bShtKSkpOwoJcmV0dXJuIDA7Cn0KCnN0YXRpYyBpbnQgcmVhZF9taWR4X3ByZWZlcnJlZF9wYWNrKGNvbnN0IGNoYXIgKm9iamVjdF9kaXIpCnsKCXN0cnVjdCBtdWx0aV9wYWNrX2luZGV4ICptaWR4ID0gTlVMTDsKCXN0cnVjdCBiaXRtYXBfaW5kZXggKmJpdG1hcCA9IE5VTEw7CgoJc2V0dXBfZ2l0X2RpcmVjdG9yeSgpOwoKCW1pZHggPSBsb2FkX211bHRpX3BhY2tfaW5kZXgob2JqZWN0X2RpciwgMSk7CglpZiAoIW1pZHgpCgkJcmV0dXJuIDE7CgoJYml0bWFwID0gcHJlcGFyZV9iaXRtYXBfZ2l0KHRoZV9yZXBvc2l0b3J5KTsKCWlmICghKGJpdG1hcCAmJiBiaXRtYXBfaXNfbWlkeChiaXRtYXApKSkKCQlyZXR1cm4gMTsKCgoJcHJpbnRmKCIlc1xuIiwgbWlkeC0+cGFja19uYW1lc1ttaWR4X3ByZWZlcnJlZF9wYWNrKGJpdG1hcCldKTsKCXJldHVybiAwOwp9CgppbnQgY21kX19yZWFkX21pZHgoaW50IGFyZ2MsIGNvbnN0IGNoYXIgKiphcmd2KQp7CglpZiAoIShhcmdjID09IDIgfHwgYXJnYyA9PSAzKSkKCQl1c2FnZSgicmVhZC1taWR4IFstLXNob3ctb2JqZWN0c3wtLWNoZWNrc3VtfC0tcHJlZmVycmVkLXBhY2tdIDxvYmplY3QtZGlyPiIpOwoKCWlmICghc3RyY21wKGFyZ3ZbMV0sICItLXNob3ctb2JqZWN0cyIpKQoJCXJldHVybiByZWFkX21pZHhfZmlsZShhcmd2WzJdLCAxKTsKCWVsc2UgaWYgKCFzdHJjbXAoYXJndlsxXSwgIi0tY2hlY2tzdW0iKSkKCQlyZXR1cm4gcmVhZF9taWR4X2NoZWNrc3VtKGFyZ3ZbMl0pOwoJZWxzZSBpZiAoIXN0cmNtcChhcmd2WzFdLCAiLS1wcmVmZXJyZWQtcGFjayIpKQoJCXJldHVybiByZWFkX21pZHhfcHJlZmVycmVkX3BhY2soYXJndlsyXSk7CglyZXR1cm4gcmVhZF9taWR4X2ZpbGUoYXJndlsxXSwgMCk7Cn0K",
    "text": "#include \"test-tool.h\"\n#include \"cache.h\"\n#include \"midx.h\"\n#include \"repository.h\"\n#include \"object-store.h\"\n#include \"pack-bitmap.h\"\n\nstatic int read_midx_file(const char *object_dir, int show_objects)\n{\n\tuint32_t i;\n\tstruct multi_pack_index *m;\n\n\tsetup_git_directory();\n\tm = load_multi_pack_index(object_dir, 1);\n\n\tif (!m)\n\t\treturn 1;\n\n\tprintf(\"header: %08x %d %d %d %d\\n\",\n\t       m->signature,\n\t       m->version,\n\t       m->hash_len,\n\t       m->num_chunks,\n\t       m->num_packs);\n\n\tprintf(\"chunks:\");\n\n\tif (m->chunk_pack_names)\n\t\tprintf(\" pack-names\");\n\tif (m->chunk_oid_fanout)\n\t\tprintf(\" oid-fanout\");\n\tif (m->chunk_oid_lookup)\n\t\tprintf(\" oid-lookup\");\n\tif (m->chunk_object_offsets)\n\t\tprintf(\" object-offsets\");\n\tif (m->chunk_large_offsets)\n\t\tprintf(\" large-offsets\");\n\n\tprintf(\"\\nnum_objects: %d\\n\", m->num_objects);\n\n\tprintf(\"packs:\\n\");\n\tfor (i = 0; i < m->num_packs; i++)\n\t\tprintf(\"%s\\n\", m->pack_names[i]);\n\n\tprintf(\"object-dir: %s\\n\", m->object_dir);\n\n\tif (show_objects) {\n\t\tstruct object_id oid;\n\t\tstruct pack_entry e;\n\n\t\tfor (i = 0; i < m->num_objects; i++) {\n\t\t\tnth_midxed_object_oid(&oid, m, i);\n\t\t\tfill_midx_entry(the_repository, &oid, &e, m);\n\n\t\t\tprintf(\"%s %\"PRIu64\"\\t%s\\n\",\n\t\t\t       oid_to_hex(&oid), e.offset, e.p->pack_name);\n\t\t}\n\t\treturn 0;\n\t}\n\n\treturn 0;\n}\n\nstatic int read_midx_checksum(const char *object_dir)\n{\n\tstruct multi_pack_index *m;\n\n\tsetup_git_directory();\n\tm = load_multi_pack_index(object_dir, 1);\n\tif (!m)\n\t\treturn 1;\n\tprintf(\"%s\\n\", hash_to_hex(get_midx_checksum(m)));\n\treturn 0;\n}\n\nstatic int read_midx_preferred_pack(const char *object_dir)\n{\n\tstruct multi_pack_index *midx = NULL;\n\tstruct bitmap_index *bitmap = NULL;\n\n\tsetup_git_directory();\n\n\tmidx = load_multi_pack_index(object_dir, 1);\n\tif (!midx)\n\t\treturn 1;\n\n\tbitmap = prepare_bitmap_git(the_repository);\n\tif (!(bitmap && bitmap_is_midx(bitmap)))\n\t\treturn 1;\n\n\n\tprintf(\"%s\\n\", midx->pack_names[midx_preferred_pack(bitmap)]);\n\treturn 0;\n}\n\nint cmd__read_midx(int argc, const char **argv)\n{\n\tif (!(argc == 2 || argc == 3))\n\t\tusage(\"read-midx [--show-objects|--checksum|--preferred-pack] <object-dir>\");\n\n\tif (!strcmp(argv[1], \"--show-objects\"))\n\t\treturn read_midx_file(argv[2], 1);\n\telse if (!strcmp(argv[1], \"--checksum\"))\n\t\treturn read_midx_checksum(argv[2]);\n\telse if (!strcmp(argv[1], \"--preferred-pack\"))\n\t\treturn read_midx_preferred_pack(argv[2]);\n\treturn read_midx_file(argv[1], 0);\n}\n",
    "type": "blob"
  },
  "kind": "blob",
  "oid": "00385591297567154f817c5a3f1fdeb0dd5c4b9a",
  "sha1_ok": true,
  "size": 2391
}
