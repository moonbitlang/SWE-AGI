{
  "content": {
    "base64": "I2luY2x1ZGUgImJ1aWx0aW4uaCIKI2luY2x1ZGUgImNhY2hlLmgiCiNpbmNsdWRlICJwcm9ncmVzcy5oIgoKc3RhdGljIGNvbnN0IGNoYXIgcHJ1bmVfcGFja2VkX3VzYWdlW10gPQoiZ2l0IHBydW5lLXBhY2tlZCBbLW5dIFstcV0iOwoKI2RlZmluZSBEUllfUlVOIDAxCiNkZWZpbmUgVkVSQk9TRSAwMgoKc3RhdGljIHN0cnVjdCBwcm9ncmVzcyAqcHJvZ3Jlc3M7CgpzdGF0aWMgdm9pZCBwcnVuZV9kaXIoaW50IGksIERJUiAqZGlyLCBjaGFyICpwYXRobmFtZSwgaW50IGxlbiwgaW50IG9wdHMpCnsKCXN0cnVjdCBkaXJlbnQgKmRlOwoJY2hhciBoZXhbNDBdOwoKCXNwcmludGYoaGV4LCAiJTAyeCIsIGkpOwoJd2hpbGUgKChkZSA9IHJlYWRkaXIoZGlyKSkgIT0gTlVMTCkgewoJCXVuc2lnbmVkIGNoYXIgc2hhMVsyMF07CgkJaWYgKHN0cmxlbihkZS0+ZF9uYW1lKSAhPSAzOCkKCQkJY29udGludWU7CgkJbWVtY3B5KGhleCsyLCBkZS0+ZF9uYW1lLCAzOCk7CgkJaWYgKGdldF9zaGExX2hleChoZXgsIHNoYTEpKQoJCQljb250aW51ZTsKCQlpZiAoIWhhc19zaGExX3BhY2soc2hhMSkpCgkJCWNvbnRpbnVlOwoJCW1lbWNweShwYXRobmFtZSArIGxlbiwgZGUtPmRfbmFtZSwgMzgpOwoJCWlmIChvcHRzICYgRFJZX1JVTikKCQkJcHJpbnRmKCJybSAtZiAlc1xuIiwgcGF0aG5hbWUpOwoJCWVsc2UKCQkJdW5saW5rX29yX3dhcm4ocGF0aG5hbWUpOwoJCWRpc3BsYXlfcHJvZ3Jlc3MocHJvZ3Jlc3MsIGkgKyAxKTsKCX0KCXBhdGhuYW1lW2xlbl0gPSAwOwoJcm1kaXIocGF0aG5hbWUpOwp9Cgp2b2lkIHBydW5lX3BhY2tlZF9vYmplY3RzKGludCBvcHRzKQp7CglpbnQgaTsKCXN0YXRpYyBjaGFyIHBhdGhuYW1lW1BBVEhfTUFYXTsKCWNvbnN0IGNoYXIgKmRpciA9IGdldF9vYmplY3RfZGlyZWN0b3J5KCk7CglpbnQgbGVuID0gc3RybGVuKGRpcik7CgoJaWYgKG9wdHMgPT0gVkVSQk9TRSkKCQlwcm9ncmVzcyA9IHN0YXJ0X3Byb2dyZXNzX2RlbGF5KCJSZW1vdmluZyBkdXBsaWNhdGUgb2JqZWN0cyIsCgkJCTI1NiwgOTUsIDIpOwoKCWlmIChsZW4gPiBQQVRIX01BWCAtIDQyKQoJCWRpZSgiaW1wb3NzaWJsZSBvYmplY3QgZGlyZWN0b3J5Iik7CgltZW1jcHkocGF0aG5hbWUsIGRpciwgbGVuKTsKCWlmIChsZW4gJiYgcGF0aG5hbWVbbGVuLTFdICE9ICcvJykKCQlwYXRobmFtZVtsZW4rK10gPSAnLyc7Cglmb3IgKGkgPSAwOyBpIDwgMjU2OyBpKyspIHsKCQlESVIgKmQ7CgoJCWRpc3BsYXlfcHJvZ3Jlc3MocHJvZ3Jlc3MsIGkgKyAxKTsKCQlzcHJpbnRmKHBhdGhuYW1lICsgbGVuLCAiJTAyeC8iLCBpKTsKCQlkID0gb3BlbmRpcihwYXRobmFtZSk7CgkJaWYgKCFkKQoJCQljb250aW51ZTsKCQlwcnVuZV9kaXIoaSwgZCwgcGF0aG5hbWUsIGxlbiArIDMsIG9wdHMpOwoJCWNsb3NlZGlyKGQpOwoJfQoJc3RvcF9wcm9ncmVzcygmcHJvZ3Jlc3MpOwp9CgppbnQgY21kX3BydW5lX3BhY2tlZChpbnQgYXJnYywgY29uc3QgY2hhciAqKmFyZ3YsIGNvbnN0IGNoYXIgKnByZWZpeCkKewoJaW50IGk7CglpbnQgb3B0cyA9IFZFUkJPU0U7CgoJZm9yIChpID0gMTsgaSA8IGFyZ2M7IGkrKykgewoJCWNvbnN0IGNoYXIgKmFyZyA9IGFyZ3ZbaV07CgoJCWlmICgqYXJnID09ICctJykgewoJCQlpZiAoIXN0cmNtcChhcmcsICItbiIpKQoJCQkJb3B0cyB8PSBEUllfUlVOOwoJCQllbHNlIGlmICghc3RyY21wKGFyZywgIi1xIikpCgkJCQlvcHRzICY9IH5WRVJCT1NFOwoJCQllbHNlCgkJCQl1c2FnZShwcnVuZV9wYWNrZWRfdXNhZ2UpOwoJCQljb250aW51ZTsKCQl9CgkJLyogSGFuZGxlIGFyZ3VtZW50cyBoZXJlIC4uICovCgkJdXNhZ2UocHJ1bmVfcGFja2VkX3VzYWdlKTsKCX0KCXBydW5lX3BhY2tlZF9vYmplY3RzKG9wdHMpOwoJcmV0dXJuIDA7Cn0K",
    "text": "#include \"builtin.h\"\n#include \"cache.h\"\n#include \"progress.h\"\n\nstatic const char prune_packed_usage[] =\n\"git prune-packed [-n] [-q]\";\n\n#define DRY_RUN 01\n#define VERBOSE 02\n\nstatic struct progress *progress;\n\nstatic void prune_dir(int i, DIR *dir, char *pathname, int len, int opts)\n{\n\tstruct dirent *de;\n\tchar hex[40];\n\n\tsprintf(hex, \"%02x\", i);\n\twhile ((de = readdir(dir)) != NULL) {\n\t\tunsigned char sha1[20];\n\t\tif (strlen(de->d_name) != 38)\n\t\t\tcontinue;\n\t\tmemcpy(hex+2, de->d_name, 38);\n\t\tif (get_sha1_hex(hex, sha1))\n\t\t\tcontinue;\n\t\tif (!has_sha1_pack(sha1))\n\t\t\tcontinue;\n\t\tmemcpy(pathname + len, de->d_name, 38);\n\t\tif (opts & DRY_RUN)\n\t\t\tprintf(\"rm -f %s\\n\", pathname);\n\t\telse\n\t\t\tunlink_or_warn(pathname);\n\t\tdisplay_progress(progress, i + 1);\n\t}\n\tpathname[len] = 0;\n\trmdir(pathname);\n}\n\nvoid prune_packed_objects(int opts)\n{\n\tint i;\n\tstatic char pathname[PATH_MAX];\n\tconst char *dir = get_object_directory();\n\tint len = strlen(dir);\n\n\tif (opts == VERBOSE)\n\t\tprogress = start_progress_delay(\"Removing duplicate objects\",\n\t\t\t256, 95, 2);\n\n\tif (len > PATH_MAX - 42)\n\t\tdie(\"impossible object directory\");\n\tmemcpy(pathname, dir, len);\n\tif (len && pathname[len-1] != '/')\n\t\tpathname[len++] = '/';\n\tfor (i = 0; i < 256; i++) {\n\t\tDIR *d;\n\n\t\tdisplay_progress(progress, i + 1);\n\t\tsprintf(pathname + len, \"%02x/\", i);\n\t\td = opendir(pathname);\n\t\tif (!d)\n\t\t\tcontinue;\n\t\tprune_dir(i, d, pathname, len + 3, opts);\n\t\tclosedir(d);\n\t}\n\tstop_progress(&progress);\n}\n\nint cmd_prune_packed(int argc, const char **argv, const char *prefix)\n{\n\tint i;\n\tint opts = VERBOSE;\n\n\tfor (i = 1; i < argc; i++) {\n\t\tconst char *arg = argv[i];\n\n\t\tif (*arg == '-') {\n\t\t\tif (!strcmp(arg, \"-n\"))\n\t\t\t\topts |= DRY_RUN;\n\t\t\telse if (!strcmp(arg, \"-q\"))\n\t\t\t\topts &= ~VERBOSE;\n\t\t\telse\n\t\t\t\tusage(prune_packed_usage);\n\t\t\tcontinue;\n\t\t}\n\t\t/* Handle arguments here .. */\n\t\tusage(prune_packed_usage);\n\t}\n\tprune_packed_objects(opts);\n\treturn 0;\n}\n",
    "type": "blob"
  },
  "kind": "blob",
  "oid": "00590b1c3c2cceda7a75537c8680a96cd2ef84d4",
  "sha1_ok": true,
  "size": 1899
}
