{
  "content": {
    "base64": "I2luY2x1ZGUgImNhY2hlLmgiCiNpbmNsdWRlICJyZWZzLmgiCiNpbmNsdWRlICJidWlsdGluLmgiCgpzdGF0aWMgY29uc3QgY2hhciBnaXRfdXBkYXRlX3JlZl91c2FnZVtdID0KImdpdC11cGRhdGUtcmVmIDxyZWZuYW1lPiA8dmFsdWU+IFs8b2xkdmFsPl0gWy1tIDxyZWFzb24+XSI7CgppbnQgY21kX3VwZGF0ZV9yZWYoaW50IGFyZ2MsIGNvbnN0IGNoYXIgKiphcmd2LCBjaGFyICoqZW52cCkKewoJY29uc3QgY2hhciAqcmVmbmFtZT1OVUxMLCAqdmFsdWU9TlVMTCwgKm9sZHZhbD1OVUxMLCAqbXNnPU5VTEw7CglzdHJ1Y3QgcmVmX2xvY2sgKmxvY2s7Cgl1bnNpZ25lZCBjaGFyIHNoYTFbMjBdLCBvbGRzaGExWzIwXTsKCWludCBpOwoKCXNldHVwX2dpdF9kaXJlY3RvcnkoKTsKCWdpdF9jb25maWcoZ2l0X2RlZmF1bHRfY29uZmlnKTsKCglmb3IgKGkgPSAxOyBpIDwgYXJnYzsgaSsrKSB7CgkJaWYgKCFzdHJjbXAoIi1tIiwgYXJndltpXSkpIHsKCQkJaWYgKGkrMSA+PSBhcmdjKQoJCQkJdXNhZ2UoZ2l0X3VwZGF0ZV9yZWZfdXNhZ2UpOwoJCQltc2cgPSBhcmd2WysraV07CgkJCWlmICghKm1zZykKCQkJCWRpZSgiUmVmdXNpbmcgdG8gcGVyZm9ybSB1cGRhdGUgd2l0aCBlbXB0eSBtZXNzYWdlLiIpOwoJCQlpZiAoc3RyY2hyKG1zZywgJ1xuJykpCgkJCQlkaWUoIlJlZnVzaW5nIHRvIHBlcmZvcm0gdXBkYXRlIHdpdGggXFxuIGluIG1lc3NhZ2UuIik7CgkJCWNvbnRpbnVlOwoJCX0KCQlpZiAoIXJlZm5hbWUpIHsKCQkJcmVmbmFtZSA9IGFyZ3ZbaV07CgkJCWNvbnRpbnVlOwoJCX0KCQlpZiAoIXZhbHVlKSB7CgkJCXZhbHVlID0gYXJndltpXTsKCQkJY29udGludWU7CgkJfQoJCWlmICghb2xkdmFsKSB7CgkJCW9sZHZhbCA9IGFyZ3ZbaV07CgkJCWNvbnRpbnVlOwoJCX0KCX0KCWlmICghcmVmbmFtZSB8fCAhdmFsdWUpCgkJdXNhZ2UoZ2l0X3VwZGF0ZV9yZWZfdXNhZ2UpOwoKCWlmIChnZXRfc2hhMSh2YWx1ZSwgc2hhMSkpCgkJZGllKCIlczogbm90IGEgdmFsaWQgU0hBMSIsIHZhbHVlKTsKCW1lbXNldChvbGRzaGExLCAwLCAyMCk7CglpZiAob2xkdmFsICYmIGdldF9zaGExKG9sZHZhbCwgb2xkc2hhMSkpCgkJZGllKCIlczogbm90IGEgdmFsaWQgb2xkIFNIQTEiLCBvbGR2YWwpOwoKCWxvY2sgPSBsb2NrX2FueV9yZWZfZm9yX3VwZGF0ZShyZWZuYW1lLCBvbGR2YWwgPyBvbGRzaGExIDogTlVMTCwgMCk7CglpZiAoIWxvY2spCgkJcmV0dXJuIDE7CglpZiAod3JpdGVfcmVmX3NoYTEobG9jaywgc2hhMSwgbXNnKSA8IDApCgkJcmV0dXJuIDE7CgoJLyogd3JpdGVfcmVmX3NoYTEgYWx3YXlzIHVubG9ja3MgdGhlIHJlZiwgbm8gbmVlZCB0byBkbyBpdCBleHBsaWNpdGx5ICovCglyZXR1cm4gMDsKfQo=",
    "text": "#include \"cache.h\"\n#include \"refs.h\"\n#include \"builtin.h\"\n\nstatic const char git_update_ref_usage[] =\n\"git-update-ref <refname> <value> [<oldval>] [-m <reason>]\";\n\nint cmd_update_ref(int argc, const char **argv, char **envp)\n{\n\tconst char *refname=NULL, *value=NULL, *oldval=NULL, *msg=NULL;\n\tstruct ref_lock *lock;\n\tunsigned char sha1[20], oldsha1[20];\n\tint i;\n\n\tsetup_git_directory();\n\tgit_config(git_default_config);\n\n\tfor (i = 1; i < argc; i++) {\n\t\tif (!strcmp(\"-m\", argv[i])) {\n\t\t\tif (i+1 >= argc)\n\t\t\t\tusage(git_update_ref_usage);\n\t\t\tmsg = argv[++i];\n\t\t\tif (!*msg)\n\t\t\t\tdie(\"Refusing to perform update with empty message.\");\n\t\t\tif (strchr(msg, '\\n'))\n\t\t\t\tdie(\"Refusing to perform update with \\\\n in message.\");\n\t\t\tcontinue;\n\t\t}\n\t\tif (!refname) {\n\t\t\trefname = argv[i];\n\t\t\tcontinue;\n\t\t}\n\t\tif (!value) {\n\t\t\tvalue = argv[i];\n\t\t\tcontinue;\n\t\t}\n\t\tif (!oldval) {\n\t\t\toldval = argv[i];\n\t\t\tcontinue;\n\t\t}\n\t}\n\tif (!refname || !value)\n\t\tusage(git_update_ref_usage);\n\n\tif (get_sha1(value, sha1))\n\t\tdie(\"%s: not a valid SHA1\", value);\n\tmemset(oldsha1, 0, 20);\n\tif (oldval && get_sha1(oldval, oldsha1))\n\t\tdie(\"%s: not a valid old SHA1\", oldval);\n\n\tlock = lock_any_ref_for_update(refname, oldval ? oldsha1 : NULL, 0);\n\tif (!lock)\n\t\treturn 1;\n\tif (write_ref_sha1(lock, sha1, msg) < 0)\n\t\treturn 1;\n\n\t/* write_ref_sha1 always unlocks the ref, no need to do it explicitly */\n\treturn 0;\n}\n",
    "type": "blob"
  },
  "kind": "blob",
  "oid": "00333c7e7ca0e706be425182ff92b98a16ac3883",
  "sha1_ok": true,
  "size": 1370
}
