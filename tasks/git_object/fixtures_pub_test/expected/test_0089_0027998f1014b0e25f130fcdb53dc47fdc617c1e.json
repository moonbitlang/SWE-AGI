{
  "content": {
    "base64": "LyoKICogQnVpbHRpbiAiZ2l0IGxvZyIgYW5kIHJlbGF0ZWQgY29tbWFuZHMgKHNob3csIHdoYXRjaGFuZ2VkKQogKgogKiAoQykgQ29weXJpZ2h0IDIwMDYgTGludXMgVG9ydmFsZHMKICoJCSAyMDA2IEp1bmlvIEhhbWFubwogKi8KI2luY2x1ZGUgImNhY2hlLmgiCiNpbmNsdWRlICJjb21taXQuaCIKI2luY2x1ZGUgImRpZmYuaCIKI2luY2x1ZGUgInJldmlzaW9uLmgiCiNpbmNsdWRlICJsb2ctdHJlZS5oIgojaW5jbHVkZSAiYnVpbHRpbi5oIgoKc3RhdGljIGludCBjbWRfbG9nX3djKGludCBhcmdjLCBjb25zdCBjaGFyICoqYXJndiwgY2hhciAqKmVudnAsCgkJICAgICAgc3RydWN0IHJldl9pbmZvICpyZXYpCnsKCXN0cnVjdCBjb21taXQgKmNvbW1pdDsKCglyZXYtPmFiYnJldiA9IERFRkFVTFRfQUJCUkVWOwoJcmV2LT5jb21taXRfZm9ybWF0ID0gQ01JVF9GTVRfREVGQVVMVDsKCXJldi0+dmVyYm9zZV9oZWFkZXIgPSAxOwoJYXJnYyA9IHNldHVwX3JldmlzaW9ucyhhcmdjLCBhcmd2LCByZXYsICJIRUFEIik7CgoJaWYgKGFyZ2MgPiAxKQoJCWRpZSgidW5yZWNvZ25pemVkIGFyZ3VtZW50OiAlcyIsIGFyZ3ZbMV0pOwoKCXByZXBhcmVfcmV2aXNpb25fd2FsayhyZXYpOwoJc2V0dXBfcGFnZXIoKTsKCXdoaWxlICgoY29tbWl0ID0gZ2V0X3JldmlzaW9uKHJldikpICE9IE5VTEwpIHsKCQlsb2dfdHJlZV9jb21taXQocmV2LCBjb21taXQpOwoJCWZyZWUoY29tbWl0LT5idWZmZXIpOwoJCWNvbW1pdC0+YnVmZmVyID0gTlVMTDsKCX0KCXJldHVybiAwOwp9CgppbnQgY21kX3doYXRjaGFuZ2VkKGludCBhcmdjLCBjb25zdCBjaGFyICoqYXJndiwgY2hhciAqKmVudnApCnsKCXN0cnVjdCByZXZfaW5mbyByZXY7CgoJaW5pdF9yZXZpc2lvbnMoJnJldik7CglyZXYuZGlmZiA9IDE7CglyZXYuZGlmZm9wdC5yZWN1cnNpdmUgPSAxOwoJcmV0dXJuIGNtZF9sb2dfd2MoYXJnYywgYXJndiwgZW52cCwgJnJldik7Cn0KCmludCBjbWRfc2hvdyhpbnQgYXJnYywgY29uc3QgY2hhciAqKmFyZ3YsIGNoYXIgKiplbnZwKQp7CglzdHJ1Y3QgcmV2X2luZm8gcmV2OwoKCWluaXRfcmV2aXNpb25zKCZyZXYpOwoJcmV2LmRpZmYgPSAxOwoJcmV2LmRpZmZvcHQucmVjdXJzaXZlID0gMTsKCXJldi5jb21iaW5lX21lcmdlcyA9IDE7CglyZXYuZGVuc2VfY29tYmluZWRfbWVyZ2VzID0gMTsKCXJldi5hbHdheXNfc2hvd19oZWFkZXIgPSAxOwoJcmV2Lmlnbm9yZV9tZXJnZXMgPSAwOwoJcmV2Lm5vX3dhbGsgPSAxOwoJcmV0dXJuIGNtZF9sb2dfd2MoYXJnYywgYXJndiwgZW52cCwgJnJldik7Cn0KCmludCBjbWRfbG9nKGludCBhcmdjLCBjb25zdCBjaGFyICoqYXJndiwgY2hhciAqKmVudnApCnsKCXN0cnVjdCByZXZfaW5mbyByZXY7CgoJaW5pdF9yZXZpc2lvbnMoJnJldik7CglyZXYuYWx3YXlzX3Nob3dfaGVhZGVyID0gMTsKCXJldi5kaWZmb3B0LnJlY3Vyc2l2ZSA9IDE7CglyZXR1cm4gY21kX2xvZ193YyhhcmdjLCBhcmd2LCBlbnZwLCAmcmV2KTsKfQoKc3RhdGljIGludCBpc3RpdGxlY2hhcihjaGFyIGMpCnsKCXJldHVybiAoYyA+PSAnYScgJiYgYyA8PSAneicpIHx8IChjID49ICdBJyAmJiBjIDw9ICdaJykgfHwKCQkoYyA+PSAnMCcgJiYgYyA8PSAnOScpIHx8IGMgPT0gJy4nIHx8IGMgPT0gJ18nOwp9CgpzdGF0aWMgRklMRSAqcmVhbHN0ZG91dCA9IE5VTEw7CnN0YXRpYyBjaGFyICpvdXRwdXRfZGlyZWN0b3J5ID0gTlVMTDsKCnN0YXRpYyB2b2lkIHJlb3Blbl9zdGRvdXQoc3RydWN0IGNvbW1pdCAqY29tbWl0LCBpbnQgbnIsIGludCBrZWVwX3N1YmplY3QpCnsKCWNoYXIgZmlsZW5hbWVbMTAyNF07CgljaGFyICpzb2w7CglpbnQgbGVuID0gMDsKCglpZiAob3V0cHV0X2RpcmVjdG9yeSkgewoJCXN0cm5jcHkoZmlsZW5hbWUsIG91dHB1dF9kaXJlY3RvcnksIDEwMTApOwoJCWxlbiA9IHN0cmxlbihmaWxlbmFtZSk7CgkJaWYgKGZpbGVuYW1lW2xlbiAtIDFdICE9ICcvJykKCQkJZmlsZW5hbWVbbGVuKytdID0gJy8nOwoJfQoKCXNwcmludGYoZmlsZW5hbWUgKyBsZW4sICIlMDRkIiwgbnIpOwoJbGVuID0gc3RybGVuKGZpbGVuYW1lKTsKCglzb2wgPSBzdHJzdHIoY29tbWl0LT5idWZmZXIsICJcblxuIik7CglpZiAoc29sKSB7CgkJaW50IGosIHNwYWNlID0gMTsKCgkJc29sICs9IDI7CgkJLyogc3RyaXAgW1BBVENIXSBvciBbUEFUQ0ggYmxhYmxhXSAqLwoJCWlmICgha2VlcF9zdWJqZWN0ICYmICFzdHJuY21wKHNvbCwgIltQQVRDSCIsIDYpKSB7CgkJCWNoYXIgKmVvcyA9IHN0cmNocihzb2wgKyA2LCAnXScpOwoJCQlpZiAoZW9zKSB7CgkJCQl3aGlsZSAoaXNzcGFjZSgqZW9zKSkKCQkJCQllb3MrKzsKCQkJCXNvbCA9IGVvczsKCQkJfQoJCX0KCgkJZm9yIChqID0gMDsgbGVuIDwgMTAyNCAtIDYgJiYgc29sW2pdICYmIHNvbFtqXSAhPSAnXG4nOyBqKyspIHsKCQkJaWYgKGlzdGl0bGVjaGFyKHNvbFtqXSkpIHsKCQkJCWlmIChzcGFjZSkgewoJCQkJCWZpbGVuYW1lW2xlbisrXSA9ICctJzsKCQkJCQlzcGFjZSA9IDA7CgkJCQl9CgkJCQlmaWxlbmFtZVtsZW4rK10gPSBzb2xbal07CgkJCQlpZiAoc29sW2pdID09ICcuJykKCQkJCQl3aGlsZSAoc29sW2ogKyAxXSA9PSAnLicpCgkJCQkJCWorKzsKCQkJfSBlbHNlCgkJCQlzcGFjZSA9IDE7CgkJfQoJCXdoaWxlIChmaWxlbmFtZVtsZW4gLSAxXSA9PSAnLicgfHwgZmlsZW5hbWVbbGVuIC0gMV0gPT0gJy0nKQoJCQlsZW4tLTsKCX0KCXN0cmNweShmaWxlbmFtZSArIGxlbiwgIi50eHQiKTsKCWZwcmludGYocmVhbHN0ZG91dCwgIiVzXG4iLCBmaWxlbmFtZSk7CglmcmVvcGVuKGZpbGVuYW1lLCAidyIsIHN0ZG91dCk7Cn0KCmludCBjbWRfZm9ybWF0X3BhdGNoKGludCBhcmdjLCBjb25zdCBjaGFyICoqYXJndiwgY2hhciAqKmVudnApCnsKCXN0cnVjdCBjb21taXQgKmNvbW1pdDsKCXN0cnVjdCBjb21taXQgKipsaXN0ID0gTlVMTDsKCXN0cnVjdCByZXZfaW5mbyByZXY7CglpbnQgbnIgPSAwLCB0b3RhbCwgaSwgajsKCWludCB1c2Vfc3Rkb3V0ID0gMDsKCWludCBudW1iZXJlZCA9IDA7CglpbnQga2VlcF9zdWJqZWN0ID0gMDsKCglpbml0X3JldmlzaW9ucygmcmV2KTsKCXJldi5jb21taXRfZm9ybWF0ID0gQ01JVF9GTVRfRU1BSUw7CglyZXYudmVyYm9zZV9oZWFkZXIgPSAxOwoJcmV2LmRpZmYgPSAxOwoJcmV2LmRpZmZvcHQud2l0aF9yYXcgPSAwOwoJcmV2LmRpZmZvcHQud2l0aF9zdGF0ID0gMTsKCXJldi5jb21iaW5lX21lcmdlcyA9IDA7CglyZXYuaWdub3JlX21lcmdlcyA9IDE7CglyZXYuZGlmZm9wdC5vdXRwdXRfZm9ybWF0ID0gRElGRl9GT1JNQVRfUEFUQ0g7CgoJLyoKCSAqIFBhcnNlIHRoZSBhcmd1bWVudHMgYmVmb3JlIHNldHVwX3JldmlzaW9ucygpLCBvciBzb21ldGhpbmcKCSAqIGxpa2UgImdpdCBmbXQtcGF0Y2ggLW8gYTEyMyBIRUFEXi4uIiBtYXkgZmFpbDsgYTEyMyBpcwoJICogcG9zc2libHkgYSB2YWxpZCBTSEExLgoJICovCglmb3IgKGkgPSAxLCBqID0gMTsgaSA8IGFyZ2M7IGkrKykgewoJCWlmICghc3RyY21wKGFyZ3ZbaV0sICItLXN0ZG91dCIpKQoJCQl1c2Vfc3Rkb3V0ID0gMTsKCQllbHNlIGlmICghc3RyY21wKGFyZ3ZbaV0sICItbiIpIHx8CgkJCQkhc3RyY21wKGFyZ3ZbaV0sICItLW51bWJlcmVkIikpCgkJCW51bWJlcmVkID0gMTsKCQllbHNlIGlmICghc3RyY21wKGFyZ3ZbaV0sICItayIpIHx8CgkJCQkhc3RyY21wKGFyZ3ZbaV0sICItLWtlZXAtc3ViamVjdCIpKSB7CgkJCWtlZXBfc3ViamVjdCA9IDE7CgkJCXJldi50b3RhbCA9IC0xOwoJCX0gZWxzZSBpZiAoIXN0cmNtcChhcmd2W2ldLCAiLW8iKSkgewoJCQlpZiAoYXJnYyA8IDMpCgkJCQlkaWUgKCJXaGljaCBkaXJlY3Rvcnk/Iik7CgkJCWlmIChta2Rpcihhcmd2W2kgKyAxXSwgMDc3NykgPCAwICYmIGVycm5vICE9IEVFWElTVCkKCQkJCWRpZSgiQ291bGQgbm90IGNyZWF0ZSBkaXJlY3RvcnkgJXMiLAoJCQkJCQlhcmd2W2kgKyAxXSk7CgkJCW91dHB1dF9kaXJlY3RvcnkgPSBzdHJkdXAoYXJndltpICsgMV0pOwoJCQlpKys7CgkJfSBlbHNlCgkJCWFyZ3ZbaisrXSA9IGFyZ3ZbaV07Cgl9CglhcmdjID0gajsKCglpZiAobnVtYmVyZWQgJiYga2VlcF9zdWJqZWN0IDwgMCkKCQlkaWUgKCItbiBhbmQgLWsgYXJlIG11dHVhbGx5IGV4Y2x1c2l2ZS4iKTsKCglhcmdjID0gc2V0dXBfcmV2aXNpb25zKGFyZ2MsIGFyZ3YsICZyZXYsICJIRUFEIik7CglpZiAoYXJnYyA+IDEpCgkJZGllICgidW5yZWNvZ25pemVkIGFyZ3VtZW50OiAlcyIsIGFyZ3ZbMV0pOwoKCWlmICghdXNlX3N0ZG91dCkKCQlyZWFsc3Rkb3V0ID0gZmRvcGVuKGR1cCgxKSwgInciKTsKCglwcmVwYXJlX3JldmlzaW9uX3dhbGsoJnJldik7Cgl3aGlsZSAoKGNvbW1pdCA9IGdldF9yZXZpc2lvbigmcmV2KSkgIT0gTlVMTCkgewoJCS8qIGlnbm9yZSBtZXJnZXMgKi8KCQlpZiAoY29tbWl0LT5wYXJlbnRzICYmIGNvbW1pdC0+cGFyZW50cy0+bmV4dCkKCQkJY29udGludWU7CgkJbnIrKzsKCQlsaXN0ID0gcmVhbGxvYyhsaXN0LCBuciAqIHNpemVvZihsaXN0WzBdKSk7CgkJbGlzdFtuciAtIDFdID0gY29tbWl0OwoJfQoJdG90YWwgPSBucjsKCWlmIChudW1iZXJlZCkKCQlyZXYudG90YWwgPSB0b3RhbDsKCXdoaWxlICgwIDw9IC0tbnIpIHsKCQlpbnQgc2hvd247CgkJY29tbWl0ID0gbGlzdFtucl07CgkJcmV2Lm5yID0gdG90YWwgLSBucjsKCQlpZiAoIXVzZV9zdGRvdXQpCgkJCXJlb3Blbl9zdGRvdXQoY29tbWl0LCByZXYubnIsIGtlZXBfc3ViamVjdCk7CgkJc2hvd24gPSBsb2dfdHJlZV9jb21taXQoJnJldiwgY29tbWl0KTsKCQlmcmVlKGNvbW1pdC0+YnVmZmVyKTsKCQljb21taXQtPmJ1ZmZlciA9IE5VTEw7CgkJaWYgKHNob3duKQoJCQlwcmludGYoIi0tIFxuJXNcblxuIiwgZ2l0X3ZlcnNpb25fc3RyaW5nKTsKCQlpZiAoIXVzZV9zdGRvdXQpCgkJCWZjbG9zZShzdGRvdXQpOwoJfQoJaWYgKG91dHB1dF9kaXJlY3RvcnkpCgkJZnJlZShvdXRwdXRfZGlyZWN0b3J5KTsKCWZyZWUobGlzdCk7CglyZXR1cm4gMDsKfQoK",
    "text": "/*\n * Builtin \"git log\" and related commands (show, whatchanged)\n *\n * (C) Copyright 2006 Linus Torvalds\n *\t\t 2006 Junio Hamano\n */\n#include \"cache.h\"\n#include \"commit.h\"\n#include \"diff.h\"\n#include \"revision.h\"\n#include \"log-tree.h\"\n#include \"builtin.h\"\n\nstatic int cmd_log_wc(int argc, const char **argv, char **envp,\n\t\t      struct rev_info *rev)\n{\n\tstruct commit *commit;\n\n\trev->abbrev = DEFAULT_ABBREV;\n\trev->commit_format = CMIT_FMT_DEFAULT;\n\trev->verbose_header = 1;\n\targc = setup_revisions(argc, argv, rev, \"HEAD\");\n\n\tif (argc > 1)\n\t\tdie(\"unrecognized argument: %s\", argv[1]);\n\n\tprepare_revision_walk(rev);\n\tsetup_pager();\n\twhile ((commit = get_revision(rev)) != NULL) {\n\t\tlog_tree_commit(rev, commit);\n\t\tfree(commit->buffer);\n\t\tcommit->buffer = NULL;\n\t}\n\treturn 0;\n}\n\nint cmd_whatchanged(int argc, const char **argv, char **envp)\n{\n\tstruct rev_info rev;\n\n\tinit_revisions(&rev);\n\trev.diff = 1;\n\trev.diffopt.recursive = 1;\n\treturn cmd_log_wc(argc, argv, envp, &rev);\n}\n\nint cmd_show(int argc, const char **argv, char **envp)\n{\n\tstruct rev_info rev;\n\n\tinit_revisions(&rev);\n\trev.diff = 1;\n\trev.diffopt.recursive = 1;\n\trev.combine_merges = 1;\n\trev.dense_combined_merges = 1;\n\trev.always_show_header = 1;\n\trev.ignore_merges = 0;\n\trev.no_walk = 1;\n\treturn cmd_log_wc(argc, argv, envp, &rev);\n}\n\nint cmd_log(int argc, const char **argv, char **envp)\n{\n\tstruct rev_info rev;\n\n\tinit_revisions(&rev);\n\trev.always_show_header = 1;\n\trev.diffopt.recursive = 1;\n\treturn cmd_log_wc(argc, argv, envp, &rev);\n}\n\nstatic int istitlechar(char c)\n{\n\treturn (c >= 'a' && c <= 'z') || (c >= 'A' && c <= 'Z') ||\n\t\t(c >= '0' && c <= '9') || c == '.' || c == '_';\n}\n\nstatic FILE *realstdout = NULL;\nstatic char *output_directory = NULL;\n\nstatic void reopen_stdout(struct commit *commit, int nr, int keep_subject)\n{\n\tchar filename[1024];\n\tchar *sol;\n\tint len = 0;\n\n\tif (output_directory) {\n\t\tstrncpy(filename, output_directory, 1010);\n\t\tlen = strlen(filename);\n\t\tif (filename[len - 1] != '/')\n\t\t\tfilename[len++] = '/';\n\t}\n\n\tsprintf(filename + len, \"%04d\", nr);\n\tlen = strlen(filename);\n\n\tsol = strstr(commit->buffer, \"\\n\\n\");\n\tif (sol) {\n\t\tint j, space = 1;\n\n\t\tsol += 2;\n\t\t/* strip [PATCH] or [PATCH blabla] */\n\t\tif (!keep_subject && !strncmp(sol, \"[PATCH\", 6)) {\n\t\t\tchar *eos = strchr(sol + 6, ']');\n\t\t\tif (eos) {\n\t\t\t\twhile (isspace(*eos))\n\t\t\t\t\teos++;\n\t\t\t\tsol = eos;\n\t\t\t}\n\t\t}\n\n\t\tfor (j = 0; len < 1024 - 6 && sol[j] && sol[j] != '\\n'; j++) {\n\t\t\tif (istitlechar(sol[j])) {\n\t\t\t\tif (space) {\n\t\t\t\t\tfilename[len++] = '-';\n\t\t\t\t\tspace = 0;\n\t\t\t\t}\n\t\t\t\tfilename[len++] = sol[j];\n\t\t\t\tif (sol[j] == '.')\n\t\t\t\t\twhile (sol[j + 1] == '.')\n\t\t\t\t\t\tj++;\n\t\t\t} else\n\t\t\t\tspace = 1;\n\t\t}\n\t\twhile (filename[len - 1] == '.' || filename[len - 1] == '-')\n\t\t\tlen--;\n\t}\n\tstrcpy(filename + len, \".txt\");\n\tfprintf(realstdout, \"%s\\n\", filename);\n\tfreopen(filename, \"w\", stdout);\n}\n\nint cmd_format_patch(int argc, const char **argv, char **envp)\n{\n\tstruct commit *commit;\n\tstruct commit **list = NULL;\n\tstruct rev_info rev;\n\tint nr = 0, total, i, j;\n\tint use_stdout = 0;\n\tint numbered = 0;\n\tint keep_subject = 0;\n\n\tinit_revisions(&rev);\n\trev.commit_format = CMIT_FMT_EMAIL;\n\trev.verbose_header = 1;\n\trev.diff = 1;\n\trev.diffopt.with_raw = 0;\n\trev.diffopt.with_stat = 1;\n\trev.combine_merges = 0;\n\trev.ignore_merges = 1;\n\trev.diffopt.output_format = DIFF_FORMAT_PATCH;\n\n\t/*\n\t * Parse the arguments before setup_revisions(), or something\n\t * like \"git fmt-patch -o a123 HEAD^..\" may fail; a123 is\n\t * possibly a valid SHA1.\n\t */\n\tfor (i = 1, j = 1; i < argc; i++) {\n\t\tif (!strcmp(argv[i], \"--stdout\"))\n\t\t\tuse_stdout = 1;\n\t\telse if (!strcmp(argv[i], \"-n\") ||\n\t\t\t\t!strcmp(argv[i], \"--numbered\"))\n\t\t\tnumbered = 1;\n\t\telse if (!strcmp(argv[i], \"-k\") ||\n\t\t\t\t!strcmp(argv[i], \"--keep-subject\")) {\n\t\t\tkeep_subject = 1;\n\t\t\trev.total = -1;\n\t\t} else if (!strcmp(argv[i], \"-o\")) {\n\t\t\tif (argc < 3)\n\t\t\t\tdie (\"Which directory?\");\n\t\t\tif (mkdir(argv[i + 1], 0777) < 0 && errno != EEXIST)\n\t\t\t\tdie(\"Could not create directory %s\",\n\t\t\t\t\t\targv[i + 1]);\n\t\t\toutput_directory = strdup(argv[i + 1]);\n\t\t\ti++;\n\t\t} else\n\t\t\targv[j++] = argv[i];\n\t}\n\targc = j;\n\n\tif (numbered && keep_subject < 0)\n\t\tdie (\"-n and -k are mutually exclusive.\");\n\n\targc = setup_revisions(argc, argv, &rev, \"HEAD\");\n\tif (argc > 1)\n\t\tdie (\"unrecognized argument: %s\", argv[1]);\n\n\tif (!use_stdout)\n\t\trealstdout = fdopen(dup(1), \"w\");\n\n\tprepare_revision_walk(&rev);\n\twhile ((commit = get_revision(&rev)) != NULL) {\n\t\t/* ignore merges */\n\t\tif (commit->parents && commit->parents->next)\n\t\t\tcontinue;\n\t\tnr++;\n\t\tlist = realloc(list, nr * sizeof(list[0]));\n\t\tlist[nr - 1] = commit;\n\t}\n\ttotal = nr;\n\tif (numbered)\n\t\trev.total = total;\n\twhile (0 <= --nr) {\n\t\tint shown;\n\t\tcommit = list[nr];\n\t\trev.nr = total - nr;\n\t\tif (!use_stdout)\n\t\t\treopen_stdout(commit, rev.nr, keep_subject);\n\t\tshown = log_tree_commit(&rev, commit);\n\t\tfree(commit->buffer);\n\t\tcommit->buffer = NULL;\n\t\tif (shown)\n\t\t\tprintf(\"-- \\n%s\\n\\n\", git_version_string);\n\t\tif (!use_stdout)\n\t\t\tfclose(stdout);\n\t}\n\tif (output_directory)\n\t\tfree(output_directory);\n\tfree(list);\n\treturn 0;\n}\n\n",
    "type": "blob"
  },
  "kind": "blob",
  "oid": "0027998f1014b0e25f130fcdb53dc47fdc617c1e",
  "sha1_ok": true,
  "size": 5028
}
