{
  "content": {
    "base64": "IyEvYmluL3NoCgp0ZXN0X2Rlc2NyaXB0aW9uPSdwdXNoaW5nIHRvIGEgcmVwb3NpdG9yeSB1c2luZyB0aGUgYXRvbWljIHB1c2ggb3B0aW9uJwoKLiAuL3Rlc3QtbGliLnNoCgpta19yZXBvX3BhaXIgKCkgewoJcm0gLXJmIHdvcmtiZW5jaCB1cHN0cmVhbSAmJgoJdGVzdF9jcmVhdGVfcmVwbyB1cHN0cmVhbSAmJgoJdGVzdF9jcmVhdGVfcmVwbyB3b3JrYmVuY2ggJiYKCSgKCQljZCB1cHN0cmVhbSAmJgoJCWdpdCBjb25maWcgcmVjZWl2ZS5kZW55Q3VycmVudEJyYW5jaCB3YXJuCgkpICYmCgkoCgkJY2Qgd29ya2JlbmNoICYmCgkJZ2l0IHJlbW90ZSBhZGQgdXAgLi4vdXBzdHJlYW0KCSkKfQoKIyBDb21wYXJlIHRoZSByZWYgKCQxKSBpbiB1cHN0cmVhbSB3aXRoIGEgcmVmIHZhbHVlIGZyb20gd29ya2JlbmNoICgkMikKIyBpLmUuIHRlc3RfcmVmcyBzZWNvbmQgSEVBREB7Mn0KdGVzdF9yZWZzICgpIHsKCXRlc3QgJCMgPSAyICYmCglnaXQgLUMgdXBzdHJlYW0gcmV2LXBhcnNlIC0tdmVyaWZ5ICIkMSIgPmV4cGVjdCAmJgoJZ2l0IC1DIHdvcmtiZW5jaCByZXYtcGFyc2UgLS12ZXJpZnkgIiQyIiA+YWN0dWFsICYmCgl0ZXN0X2NtcCBleHBlY3QgYWN0dWFsCn0KCmZtdF9zdGF0dXNfcmVwb3J0ICgpIHsKCXNlZCAtbiBcCgkJLWUgIi9eVG8gLyB7IHMvICAgKi8gL2c7IHA7IH0iIFwKCQktZSAiL14gISAvIHsgcy8gICAqLyAvZzsgcDsgfSIKfQoKdGVzdF9leHBlY3Rfc3VjY2VzcyAnYXRvbWljIHB1c2ggd29ya3MgZm9yIGEgc2luZ2xlIGJyYW5jaCcgJwoJbWtfcmVwb19wYWlyICYmCgkoCgkJY2Qgd29ya2JlbmNoICYmCgkJdGVzdF9jb21taXQgb25lICYmCgkJZ2l0IHB1c2ggLS1taXJyb3IgdXAgJiYKCQl0ZXN0X2NvbW1pdCB0d28gJiYKCQlnaXQgcHVzaCAtLWF0b21pYyB1cCBtYXN0ZXIKCSkgJiYKCXRlc3RfcmVmcyBtYXN0ZXIgbWFzdGVyCicKCnRlc3RfZXhwZWN0X3N1Y2Nlc3MgJ2F0b21pYyBwdXNoIHdvcmtzIGZvciB0d28gYnJhbmNoZXMnICcKCW1rX3JlcG9fcGFpciAmJgoJKAoJCWNkIHdvcmtiZW5jaCAmJgoJCXRlc3RfY29tbWl0IG9uZSAmJgoJCWdpdCBicmFuY2ggc2Vjb25kICYmCgkJZ2l0IHB1c2ggLS1taXJyb3IgdXAgJiYKCQl0ZXN0X2NvbW1pdCB0d28gJiYKCQlnaXQgY2hlY2tvdXQgc2Vjb25kICYmCgkJdGVzdF9jb21taXQgdGhyZWUgJiYKCQlnaXQgcHVzaCAtLWF0b21pYyB1cCBtYXN0ZXIgc2Vjb25kCgkpICYmCgl0ZXN0X3JlZnMgbWFzdGVyIG1hc3RlciAmJgoJdGVzdF9yZWZzIHNlY29uZCBzZWNvbmQKJwoKdGVzdF9leHBlY3Rfc3VjY2VzcyAnYXRvbWljIHB1c2ggd29ya3MgaW4gY29tYmluYXRpb24gd2l0aCAtLW1pcnJvcicgJwoJbWtfcmVwb19wYWlyICYmCgkoCgkJY2Qgd29ya2JlbmNoICYmCgkJdGVzdF9jb21taXQgb25lICYmCgkJZ2l0IGNoZWNrb3V0IC1iIHNlY29uZCAmJgoJCXRlc3RfY29tbWl0IHR3byAmJgoJCWdpdCBwdXNoIC0tYXRvbWljIC0tbWlycm9yIHVwCgkpICYmCgl0ZXN0X3JlZnMgbWFzdGVyIG1hc3RlciAmJgoJdGVzdF9yZWZzIHNlY29uZCBzZWNvbmQKJwoKdGVzdF9leHBlY3Rfc3VjY2VzcyAnYXRvbWljIHB1c2ggd29ya3MgaW4gY29tYmluYXRpb24gd2l0aCAtLWZvcmNlJyAnCglta19yZXBvX3BhaXIgJiYKCSgKCQljZCB3b3JrYmVuY2ggJiYKCQl0ZXN0X2NvbW1pdCBvbmUgJiYKCQlnaXQgYnJhbmNoIHNlY29uZCBtYXN0ZXIgJiYKCQl0ZXN0X2NvbW1pdCB0d29fYSAmJgoJCWdpdCBjaGVja291dCBzZWNvbmQgJiYKCQl0ZXN0X2NvbW1pdCB0d29fYiAmJgoJCXRlc3RfY29tbWl0IHRocmVlX2IgJiYKCQl0ZXN0X2NvbW1pdCBmb3VyICYmCgkJZ2l0IHB1c2ggLS1taXJyb3IgdXAgJiYKCQkjIFRoZSBhY3R1YWwgdGVzdCBpcyBiZWxvdwoJCWdpdCBjaGVja291dCBtYXN0ZXIgJiYKCQl0ZXN0X2NvbW1pdCB0aHJlZV9hICYmCgkJZ2l0IGNoZWNrb3V0IHNlY29uZCAmJgoJCWdpdCByZXNldCAtLWhhcmQgSEVBRF4gJiYKCQlnaXQgcHVzaCAtLWZvcmNlIC0tYXRvbWljIHVwIG1hc3RlciBzZWNvbmQKCSkgJiYKCXRlc3RfcmVmcyBtYXN0ZXIgbWFzdGVyICYmCgl0ZXN0X3JlZnMgc2Vjb25kIHNlY29uZAonCgojIHNldCB1cCB0d28gYnJhbmNoZXMgd2hlcmUgbWFzdGVyIGNhbiBiZSBwdXNoZWQgYnV0IHNlY29uZCBjYW4gbm90CiMgKG5vbi1mYXN0LWZvcndhcmQpLiBTaW5jZSBzZWNvbmQgY2FuIG5vdCBiZSBwdXNoZWQgdGhlIHdob2xlIG9wZXJhdGlvbgojIHdpbGwgZmFpbCBhbmQgbGVhdmUgbWFzdGVyIHVudG91Y2hlZC4KdGVzdF9leHBlY3Rfc3VjY2VzcyAnYXRvbWljIHB1c2ggZmFpbHMgaWYgb25lIGJyYW5jaCBmYWlscycgJwoJbWtfcmVwb19wYWlyICYmCgkoCgkJY2Qgd29ya2JlbmNoICYmCgkJdGVzdF9jb21taXQgb25lICYmCgkJZ2l0IGNoZWNrb3V0IC1iIHNlY29uZCBtYXN0ZXIgJiYKCQl0ZXN0X2NvbW1pdCB0d28gJiYKCQl0ZXN0X2NvbW1pdCB0aHJlZSAmJgoJCXRlc3RfY29tbWl0IGZvdXIgJiYKCQlnaXQgcHVzaCAtLW1pcnJvciB1cCAmJgoJCWdpdCByZXNldCAtLWhhcmQgSEVBRH4yICYmCgkJdGVzdF9jb21taXQgZml2ZSAmJgoJCWdpdCBjaGVja291dCBtYXN0ZXIgJiYKCQl0ZXN0X2NvbW1pdCBzaXggJiYKCQl0ZXN0X211c3RfZmFpbCBnaXQgcHVzaCAtLWF0b21pYyAtLWFsbCB1cAoJKSAmJgoJdGVzdF9yZWZzIG1hc3RlciBIRUFEQHs3fSAmJgoJdGVzdF9yZWZzIHNlY29uZCBIRUFEQHs0fQonCgp0ZXN0X2V4cGVjdF9zdWNjZXNzICdhdG9taWMgcHVzaCBmYWlscyBpZiBvbmUgdGFnIGZhaWxzIHJlbW90ZWx5JyAnCgkjIHByZXBhcmUgdGhlIHJlcG8KCW1rX3JlcG9fcGFpciAmJgoJKAoJCWNkIHdvcmtiZW5jaCAmJgoJCXRlc3RfY29tbWl0IG9uZSAmJgoJCWdpdCBjaGVja291dCAtYiBzZWNvbmQgbWFzdGVyICYmCgkJdGVzdF9jb21taXQgdHdvICYmCgkJZ2l0IHB1c2ggLS1taXJyb3IgdXAKCSkgJiYKCSMgYSB0aGlyZCBwYXJ0eSBtb2RpZmllcyB0aGUgc2VydmVyIHNpZGU6CgkoCgkJY2QgdXBzdHJlYW0gJiYKCQlnaXQgY2hlY2tvdXQgc2Vjb25kICYmCgkJZ2l0IHRhZyB0ZXN0X3RhZyBzZWNvbmQKCSkgJiYKCSMgc2VlIGlmIHdlIGNhbiBub3cgcHVzaCBib3RoIGJyYW5jaGVzLgoJKAoJCWNkIHdvcmtiZW5jaCAmJgoJCWdpdCBjaGVja291dCBtYXN0ZXIgJiYKCQl0ZXN0X2NvbW1pdCB0aHJlZSAmJgoJCWdpdCBjaGVja291dCBzZWNvbmQgJiYKCQl0ZXN0X2NvbW1pdCBmb3VyICYmCgkJZ2l0IHRhZyB0ZXN0X3RhZyAmJgoJCXRlc3RfbXVzdF9mYWlsIGdpdCBwdXNoIC0tdGFncyAtLWF0b21pYyB1cCBtYXN0ZXIgc2Vjb25kCgkpICYmCgl0ZXN0X3JlZnMgbWFzdGVyIEhFQURAezN9ICYmCgl0ZXN0X3JlZnMgc2Vjb25kIEhFQURAezF9CicKCnRlc3RfZXhwZWN0X3N1Y2Nlc3MgJ2F0b21pYyBwdXNoIG9iZXlzIHVwZGF0ZSBob29rIHByZXZlbnRpbmcgYSBicmFuY2ggdG8gYmUgcHVzaGVkJyAnCglta19yZXBvX3BhaXIgJiYKCSgKCQljZCB3b3JrYmVuY2ggJiYKCQl0ZXN0X2NvbW1pdCBvbmUgJiYKCQlnaXQgY2hlY2tvdXQgLWIgc2Vjb25kIG1hc3RlciAmJgoJCXRlc3RfY29tbWl0IHR3byAmJgoJCWdpdCBwdXNoIC0tbWlycm9yIHVwCgkpICYmCgkoCgkJY2QgdXBzdHJlYW0gJiYKCQlIT09LRElSPSIkKGdpdCByZXYtcGFyc2UgLS1naXQtZGlyKS9ob29rcyIgJiYKCQlIT09LPSIkSE9PS0RJUi91cGRhdGUiICYmCgkJbWtkaXIgLXAgIiRIT09LRElSIiAmJgoJCXdyaXRlX3NjcmlwdCAiJEhPT0siIDw8LVxFT0YKCQkJIyBvbmx5IGFsbG93IHVwZGF0ZSB0byBtYXN0ZXIgZnJvbSBub3cgb24KCQkJdGVzdCAiJDEiID0gInJlZnMvaGVhZHMvbWFzdGVyIgoJCUVPRgoJKSAmJgoJKAoJCWNkIHdvcmtiZW5jaCAmJgoJCWdpdCBjaGVja291dCBtYXN0ZXIgJiYKCQl0ZXN0X2NvbW1pdCB0aHJlZSAmJgoJCWdpdCBjaGVja291dCBzZWNvbmQgJiYKCQl0ZXN0X2NvbW1pdCBmb3VyICYmCgkJdGVzdF9tdXN0X2ZhaWwgZ2l0IHB1c2ggLS1hdG9taWMgdXAgbWFzdGVyIHNlY29uZAoJKSAmJgoJdGVzdF9yZWZzIG1hc3RlciBIRUFEQHszfSAmJgoJdGVzdF9yZWZzIHNlY29uZCBIRUFEQHsxfQonCgp0ZXN0X2V4cGVjdF9zdWNjZXNzICdhdG9taWMgcHVzaCBpcyBub3QgYWR2ZXJ0aXNlZCBpZiBjb25maWd1cmVkJyAnCglta19yZXBvX3BhaXIgJiYKCSgKCQljZCB1cHN0cmVhbSAmJgoJCWdpdCBjb25maWcgcmVjZWl2ZS5hZHZlcnRpc2VhdG9taWMgMAoJKSAmJgoJKAoJCWNkIHdvcmtiZW5jaCAmJgoJCXRlc3RfY29tbWl0IG9uZSAmJgoJCWdpdCBwdXNoIC0tbWlycm9yIHVwICYmCgkJdGVzdF9jb21taXQgdHdvICYmCgkJdGVzdF9tdXN0X2ZhaWwgZ2l0IHB1c2ggLS1hdG9taWMgdXAgbWFzdGVyCgkpICYmCgl0ZXN0X3JlZnMgbWFzdGVyIEhFQURAezF9CicKCiMgUmVmZXJlbmNlcyBpbiB1cHN0cmVhbSA6IG1hc3RlcigxKSBvbmUoMSkgZm9vKDEpCiMgUmVmZXJlbmNlcyBpbiB3b3JrYmVuY2g6IG1hc3RlcigyKSAgICAgICAgZm9vKDEpIHR3bygyKSBiYXIoMikKIyBBdG9taWMgcHVzaCAgICAgICAgICAgIDogbWFzdGVyKDIpICAgICAgICAgICAgICAgdHdvKDIpIGJhcigyKQp0ZXN0X2V4cGVjdF9mYWlsdXJlICdhdG9taWMgcHVzaCByZXBvcnRzIChyZWplY3QgYnkgdXBkYXRlIGhvb2spJyAnCglta19yZXBvX3BhaXIgJiYKCSgKCQljZCB3b3JrYmVuY2ggJiYKCQl0ZXN0X2NvbW1pdCBvbmUgJiYKCQlnaXQgYnJhbmNoIGZvbyAmJgoJCWdpdCBwdXNoIHVwIG1hc3RlciBvbmUgZm9vICYmCgkJZ2l0IHRhZyAtZCBvbmUKCSkgJiYKCSgKCQlta2RpciAtcCB1cHN0cmVhbS8uZ2l0L2hvb2tzICYmCgkJY2F0ID51cHN0cmVhbS8uZ2l0L2hvb2tzL3VwZGF0ZSA8PC1FT0YgJiYKCQkjIS9iaW4vc2gKCgkJaWYgdGVzdCAiXCQxIiA9ICJyZWZzL2hlYWRzL2JhciIKCQl0aGVuCgkJCWVjaG8gPiYyICJQdXNpbmcgdG8gYnJhbmNoIGJhciBpcyBwcm9oaWJpdGVkIgoJCQlleGl0IDEKCQlmaQoJCUVPRgoJCWNobW9kIGEreCB1cHN0cmVhbS8uZ2l0L2hvb2tzL3VwZGF0ZQoJKSAmJgoJKAoJCWNkIHdvcmtiZW5jaCAmJgoJCXRlc3RfY29tbWl0IHR3byAmJgoJCWdpdCBicmFuY2ggYmFyCgkpICYmCgl0ZXN0X211c3RfZmFpbCBnaXQgLUMgd29ya2JlbmNoIFwKCQlwdXNoIC0tYXRvbWljIHVwIG1hc3RlciB0d28gYmFyID5vdXQgMj4mMSAmJgoJZm10X3N0YXR1c19yZXBvcnQgPG91dCA+YWN0dWFsICYmCgljYXQgPmV4cGVjdCA8PC1FT0YgJiYKCVRvIC4uL3Vwc3RyZWFtCgkgISBbcmVtb3RlIHJlamVjdGVkXSBtYXN0ZXIgLT4gbWFzdGVyIChhdG9taWMgcHVzaCBmYWlsdXJlKQoJICEgW3JlbW90ZSByZWplY3RlZF0gdHdvIC0+IHR3byAoYXRvbWljIHB1c2ggZmFpbHVyZSkKCSAhIFtyZW1vdGUgcmVqZWN0ZWRdIGJhciAtPiBiYXIgKGhvb2sgZGVjbGluZWQpCglFT0YKCXRlc3RfY21wIGV4cGVjdCBhY3R1YWwKJwoKIyBSZWZlcmVuY2VzIGluIHVwc3RyZWFtIDogbWFzdGVyKDEpIG9uZSgxKSBmb28oMSkKIyBSZWZlcmVuY2VzIGluIHdvcmtiZW5jaDogbWFzdGVyKDIpICAgICAgICBmb28oMSkgdHdvKDIpIGJhcigyKQp0ZXN0X2V4cGVjdF9mYWlsdXJlICdhdG9taWMgcHVzaCByZXBvcnRzIChtaXJyb3IsIGJ1dCByZWplY3QgYnkgdXBkYXRlIGhvb2spJyAnCgkoCgkJY2Qgd29ya2JlbmNoICYmCgkJZ2l0IHJlbW90ZSByZW1vdmUgdXAgJiYKCQlnaXQgcmVtb3RlIGFkZCB1cCAuLi91cHN0cmVhbQoJKSAmJgoJdGVzdF9tdXN0X2ZhaWwgZ2l0IC1DIHdvcmtiZW5jaCBcCgkJcHVzaCAtLWF0b21pYyAtLW1pcnJvciB1cCA+b3V0IDI+JjEgJiYKCWZtdF9zdGF0dXNfcmVwb3J0IDxvdXQgPmFjdHVhbCAmJgoJY2F0ID5leHBlY3QgPDwtRU9GICYmCglUbyAuLi91cHN0cmVhbQoJICEgW3JlbW90ZSByZWplY3RlZF0gbWFzdGVyIC0+IG1hc3RlciAoYXRvbWljIHB1c2ggZmFpbHVyZSkKCSAhIFtyZW1vdGUgcmVqZWN0ZWRdIG9uZSAoYXRvbWljIHB1c2ggZmFpbHVyZSkKCSAhIFtyZW1vdGUgcmVqZWN0ZWRdIGJhciAtPiBiYXIgKGhvb2sgZGVjbGluZWQpCgkgISBbcmVtb3RlIHJlamVjdGVkXSB0d28gLT4gdHdvIChhdG9taWMgcHVzaCBmYWlsdXJlKQoJRU9GCgl0ZXN0X2NtcCBleHBlY3QgYWN0dWFsCicKCiMgUmVmZXJlbmNlcyBpbiB1cHN0cmVhbSA6IG1hc3RlcigyKSBvbmUoMSkgZm9vKDEpCiMgUmVmZXJlbmNlcyBpbiB3b3JrYmVuY2g6IG1hc3RlcigxKSAgICAgICAgZm9vKDEpIHR3bygyKSBiYXIoMikKdGVzdF9leHBlY3RfZmFpbHVyZSAnYXRvbWljIHB1c2ggcmVwb3J0cyAocmVqZWN0IGJ5IG5vbi1mZiknICcKCXJtIHVwc3RyZWFtLy5naXQvaG9va3MvdXBkYXRlICYmCgkoCgkJY2Qgd29ya2JlbmNoICYmCgkJZ2l0IHB1c2ggdXAgbWFzdGVyICYmCgkJZ2l0IHJlc2V0IC0taGFyZCBIRUFEXgoJKSAmJgoJdGVzdF9tdXN0X2ZhaWwgZ2l0IC1DIHdvcmtiZW5jaCBcCgkJcHVzaCAtLWF0b21pYyB1cCBtYXN0ZXIgZm9vIGJhciA+b3V0IDI+JjEgJiYKCWZtdF9zdGF0dXNfcmVwb3J0IDxvdXQgPmFjdHVhbCAmJgoJY2F0ID5leHBlY3QgPDwtRU9GICYmCglUbyAuLi91cHN0cmVhbQoJICEgW3JlamVjdGVkXSBtYXN0ZXIgLT4gbWFzdGVyIChub24tZmFzdC1mb3J3YXJkKQoJICEgW3JlamVjdGVkXSBiYXIgLT4gYmFyIChhdG9taWMgcHVzaCBmYWlsZWQpCglFT0YKCXRlc3RfY21wIGV4cGVjdCBhY3R1YWwKJwoKdGVzdF9kb25lCg==",
    "text": "#!/bin/sh\n\ntest_description='pushing to a repository using the atomic push option'\n\n. ./test-lib.sh\n\nmk_repo_pair () {\n\trm -rf workbench upstream &&\n\ttest_create_repo upstream &&\n\ttest_create_repo workbench &&\n\t(\n\t\tcd upstream &&\n\t\tgit config receive.denyCurrentBranch warn\n\t) &&\n\t(\n\t\tcd workbench &&\n\t\tgit remote add up ../upstream\n\t)\n}\n\n# Compare the ref ($1) in upstream with a ref value from workbench ($2)\n# i.e. test_refs second HEAD@{2}\ntest_refs () {\n\ttest $# = 2 &&\n\tgit -C upstream rev-parse --verify \"$1\" >expect &&\n\tgit -C workbench rev-parse --verify \"$2\" >actual &&\n\ttest_cmp expect actual\n}\n\nfmt_status_report () {\n\tsed -n \\\n\t\t-e \"/^To / { s/   */ /g; p; }\" \\\n\t\t-e \"/^ ! / { s/   */ /g; p; }\"\n}\n\ntest_expect_success 'atomic push works for a single branch' '\n\tmk_repo_pair &&\n\t(\n\t\tcd workbench &&\n\t\ttest_commit one &&\n\t\tgit push --mirror up &&\n\t\ttest_commit two &&\n\t\tgit push --atomic up master\n\t) &&\n\ttest_refs master master\n'\n\ntest_expect_success 'atomic push works for two branches' '\n\tmk_repo_pair &&\n\t(\n\t\tcd workbench &&\n\t\ttest_commit one &&\n\t\tgit branch second &&\n\t\tgit push --mirror up &&\n\t\ttest_commit two &&\n\t\tgit checkout second &&\n\t\ttest_commit three &&\n\t\tgit push --atomic up master second\n\t) &&\n\ttest_refs master master &&\n\ttest_refs second second\n'\n\ntest_expect_success 'atomic push works in combination with --mirror' '\n\tmk_repo_pair &&\n\t(\n\t\tcd workbench &&\n\t\ttest_commit one &&\n\t\tgit checkout -b second &&\n\t\ttest_commit two &&\n\t\tgit push --atomic --mirror up\n\t) &&\n\ttest_refs master master &&\n\ttest_refs second second\n'\n\ntest_expect_success 'atomic push works in combination with --force' '\n\tmk_repo_pair &&\n\t(\n\t\tcd workbench &&\n\t\ttest_commit one &&\n\t\tgit branch second master &&\n\t\ttest_commit two_a &&\n\t\tgit checkout second &&\n\t\ttest_commit two_b &&\n\t\ttest_commit three_b &&\n\t\ttest_commit four &&\n\t\tgit push --mirror up &&\n\t\t# The actual test is below\n\t\tgit checkout master &&\n\t\ttest_commit three_a &&\n\t\tgit checkout second &&\n\t\tgit reset --hard HEAD^ &&\n\t\tgit push --force --atomic up master second\n\t) &&\n\ttest_refs master master &&\n\ttest_refs second second\n'\n\n# set up two branches where master can be pushed but second can not\n# (non-fast-forward). Since second can not be pushed the whole operation\n# will fail and leave master untouched.\ntest_expect_success 'atomic push fails if one branch fails' '\n\tmk_repo_pair &&\n\t(\n\t\tcd workbench &&\n\t\ttest_commit one &&\n\t\tgit checkout -b second master &&\n\t\ttest_commit two &&\n\t\ttest_commit three &&\n\t\ttest_commit four &&\n\t\tgit push --mirror up &&\n\t\tgit reset --hard HEAD~2 &&\n\t\ttest_commit five &&\n\t\tgit checkout master &&\n\t\ttest_commit six &&\n\t\ttest_must_fail git push --atomic --all up\n\t) &&\n\ttest_refs master HEAD@{7} &&\n\ttest_refs second HEAD@{4}\n'\n\ntest_expect_success 'atomic push fails if one tag fails remotely' '\n\t# prepare the repo\n\tmk_repo_pair &&\n\t(\n\t\tcd workbench &&\n\t\ttest_commit one &&\n\t\tgit checkout -b second master &&\n\t\ttest_commit two &&\n\t\tgit push --mirror up\n\t) &&\n\t# a third party modifies the server side:\n\t(\n\t\tcd upstream &&\n\t\tgit checkout second &&\n\t\tgit tag test_tag second\n\t) &&\n\t# see if we can now push both branches.\n\t(\n\t\tcd workbench &&\n\t\tgit checkout master &&\n\t\ttest_commit three &&\n\t\tgit checkout second &&\n\t\ttest_commit four &&\n\t\tgit tag test_tag &&\n\t\ttest_must_fail git push --tags --atomic up master second\n\t) &&\n\ttest_refs master HEAD@{3} &&\n\ttest_refs second HEAD@{1}\n'\n\ntest_expect_success 'atomic push obeys update hook preventing a branch to be pushed' '\n\tmk_repo_pair &&\n\t(\n\t\tcd workbench &&\n\t\ttest_commit one &&\n\t\tgit checkout -b second master &&\n\t\ttest_commit two &&\n\t\tgit push --mirror up\n\t) &&\n\t(\n\t\tcd upstream &&\n\t\tHOOKDIR=\"$(git rev-parse --git-dir)/hooks\" &&\n\t\tHOOK=\"$HOOKDIR/update\" &&\n\t\tmkdir -p \"$HOOKDIR\" &&\n\t\twrite_script \"$HOOK\" <<-\\EOF\n\t\t\t# only allow update to master from now on\n\t\t\ttest \"$1\" = \"refs/heads/master\"\n\t\tEOF\n\t) &&\n\t(\n\t\tcd workbench &&\n\t\tgit checkout master &&\n\t\ttest_commit three &&\n\t\tgit checkout second &&\n\t\ttest_commit four &&\n\t\ttest_must_fail git push --atomic up master second\n\t) &&\n\ttest_refs master HEAD@{3} &&\n\ttest_refs second HEAD@{1}\n'\n\ntest_expect_success 'atomic push is not advertised if configured' '\n\tmk_repo_pair &&\n\t(\n\t\tcd upstream &&\n\t\tgit config receive.advertiseatomic 0\n\t) &&\n\t(\n\t\tcd workbench &&\n\t\ttest_commit one &&\n\t\tgit push --mirror up &&\n\t\ttest_commit two &&\n\t\ttest_must_fail git push --atomic up master\n\t) &&\n\ttest_refs master HEAD@{1}\n'\n\n# References in upstream : master(1) one(1) foo(1)\n# References in workbench: master(2)        foo(1) two(2) bar(2)\n# Atomic push            : master(2)               two(2) bar(2)\ntest_expect_failure 'atomic push reports (reject by update hook)' '\n\tmk_repo_pair &&\n\t(\n\t\tcd workbench &&\n\t\ttest_commit one &&\n\t\tgit branch foo &&\n\t\tgit push up master one foo &&\n\t\tgit tag -d one\n\t) &&\n\t(\n\t\tmkdir -p upstream/.git/hooks &&\n\t\tcat >upstream/.git/hooks/update <<-EOF &&\n\t\t#!/bin/sh\n\n\t\tif test \"\\$1\" = \"refs/heads/bar\"\n\t\tthen\n\t\t\techo >&2 \"Pusing to branch bar is prohibited\"\n\t\t\texit 1\n\t\tfi\n\t\tEOF\n\t\tchmod a+x upstream/.git/hooks/update\n\t) &&\n\t(\n\t\tcd workbench &&\n\t\ttest_commit two &&\n\t\tgit branch bar\n\t) &&\n\ttest_must_fail git -C workbench \\\n\t\tpush --atomic up master two bar >out 2>&1 &&\n\tfmt_status_report <out >actual &&\n\tcat >expect <<-EOF &&\n\tTo ../upstream\n\t ! [remote rejected] master -> master (atomic push failure)\n\t ! [remote rejected] two -> two (atomic push failure)\n\t ! [remote rejected] bar -> bar (hook declined)\n\tEOF\n\ttest_cmp expect actual\n'\n\n# References in upstream : master(1) one(1) foo(1)\n# References in workbench: master(2)        foo(1) two(2) bar(2)\ntest_expect_failure 'atomic push reports (mirror, but reject by update hook)' '\n\t(\n\t\tcd workbench &&\n\t\tgit remote remove up &&\n\t\tgit remote add up ../upstream\n\t) &&\n\ttest_must_fail git -C workbench \\\n\t\tpush --atomic --mirror up >out 2>&1 &&\n\tfmt_status_report <out >actual &&\n\tcat >expect <<-EOF &&\n\tTo ../upstream\n\t ! [remote rejected] master -> master (atomic push failure)\n\t ! [remote rejected] one (atomic push failure)\n\t ! [remote rejected] bar -> bar (hook declined)\n\t ! [remote rejected] two -> two (atomic push failure)\n\tEOF\n\ttest_cmp expect actual\n'\n\n# References in upstream : master(2) one(1) foo(1)\n# References in workbench: master(1)        foo(1) two(2) bar(2)\ntest_expect_failure 'atomic push reports (reject by non-ff)' '\n\trm upstream/.git/hooks/update &&\n\t(\n\t\tcd workbench &&\n\t\tgit push up master &&\n\t\tgit reset --hard HEAD^\n\t) &&\n\ttest_must_fail git -C workbench \\\n\t\tpush --atomic up master foo bar >out 2>&1 &&\n\tfmt_status_report <out >actual &&\n\tcat >expect <<-EOF &&\n\tTo ../upstream\n\t ! [rejected] master -> master (non-fast-forward)\n\t ! [rejected] bar -> bar (atomic push failed)\n\tEOF\n\ttest_cmp expect actual\n'\n\ntest_done\n",
    "type": "blob"
  },
  "kind": "blob",
  "oid": "001240eec717d68c7c9805353cc8d7655d5f8ab3",
  "sha1_ok": true,
  "size": 6727
}
